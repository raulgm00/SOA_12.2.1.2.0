package org.bcie.fenix.common.model.vo;

import java.sql.Timestamp;

import java.text.SimpleDateFormat;

import java.util.Date;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.server.ViewObjectImpl;

import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.vo.common.AccionesTablaVO;

// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Mon Jun 20 19:08:48 CDT 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class AccionesTablaVOImpl extends ViewObjectImpl implements AccionesTablaVO {

    private static ADFLogger logger = null;

    /**
     * This is the default constructor (do not remove).
     */
    public AccionesTablaVOImpl() {
        if (logger == null) {
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }


    /**
     * Returns the bind variable value for pIdOperacion.
     * @return bind variable value for pIdOperacion
     */
    public Long getpIdOperacion() {
        return (Long) getNamedWhereClauseParam("pIdOperacion");
    }

    /**
     * Sets <code>value</code> for bind variable pIdOperacion.
     * @param value value to bind as pIdOperacion
     */
    public void setpIdOperacion(Long value) {
        if (null != value) {
            setNamedWhereClauseParam("pIdOperacion", value);
        }
    }


    public void ingresarDatos(Long idCliente, Long idOperacion, Integer idProceso, Boolean valida, String rolUsuario,
                              Integer rolDUsuario, Integer idTarea, String loginUsuario, String nombre) {
        logger.warning("Entra en ingresarDatos.");
        logger.warning("valida: " + valida);
        logger.warning("cliente: " + idCliente);
        logger.warning("idOperacion: " + idOperacion);
        logger.warning("idProceso: " + idProceso);
        logger.warning("valida: " + valida);
        logger.warning("rolUsuario: " + rolUsuario);
        logger.warning("rolDUsuario: " + rolDUsuario);
        logger.warning("idTarea: " + idTarea);
        logger.warning("loginUsuario: " + loginUsuario);
        logger.warning("nombre: " + nombre);

        if (null != idCliente) {
            setpIdCliente(idCliente);
        }
        if (null != idOperacion) {
            setpIdOperacion(idOperacion);
        }
        if (null != idProceso) {
            Integer estado = null;
            Integer estado2 = null;
            Integer estado3 = null;
            String viewaplicar = null;

            if (valida) {
                logger.warning("requiereValidacion y no aplica roles");
                viewaplicar = FenixModelConstants.viewCriteriaValidacion;
                estado = FenixModelConstants.ESTADO_ACCION_REGISTRADO;
            } else {
                logger.warning("No requiere validacion y entra como process control");
                viewaplicar = FenixModelConstants.viewCriteriaCategoria;
                if (null != rolUsuario && rolUsuario.length() > 0) {
                    if (rolUsuario.equalsIgnoreCase(FenixModelConstants.ROL_OTROS)) {
                        logger.warning("cambia rol de process control a otros o cumplidor");
                        viewaplicar = FenixModelConstants.viewCriteriaCategoriaOtros;
                        estado2 = FenixModelConstants.ESTADO_ACCION_DESESTIMADA;
                        estado = FenixModelConstants.ESTADO_ACCION_ELIMINADA;
                    }
                    if (rolUsuario.equalsIgnoreCase(FenixModelConstants.ROL_INGRESADOR_VALIDADOR)) {
                        logger.warning("cambia rol de process control a ingresador o validador");
                        viewaplicar = FenixModelConstants.viewCriteriaCategoriaIngresador;
                        estado = FenixModelConstants.ESTADO_ACCION_ELIMINADA;
                    }
                }
            }
            logger.warning("viewaplicar " + viewaplicar);
            switch (idProceso) {
            case FenixModelConstants.ID_PROCESO_SEGUIMIENTO:
                setpIdCategoria(FenixModelConstants.ID_CATEGORIA_SEGUIMIENTO);
                logger.warning("seguimiento");
                getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_CATEGORIA_SEGUIMIENTO, viewaplicar,
                            valida);
                break;
            case FenixModelConstants.ID_PROCESO_UCE:
                logger.warning("uce");
                setpIdCategoria(FenixModelConstants.ID_CATEGORIA_UCE);
                getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_CATEGORIA_UCE, viewaplicar, valida);
                break;
            case FenixModelConstants.ID_PROCESO_SUPERVISION:
                logger.warning("supervision");
                setpIdCategoria(FenixModelConstants.ID_CATEGORIA_SUPERVISION);
                getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_CATEGORIA_SUPERVISION, viewaplicar,
                            valida);
                break;
            case FenixModelConstants.ID_PROCESO_SUPERVISION_AMBIENTAL_SOCIAL:
                    logger.warning("supervision Ambiental y Social");
                    setpIdCategoria(FenixModelConstants.ID_CATEGORIA_SUPERVISION);
                    getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_CATEGORIA_SUPERVISION, viewaplicar,
                                valida);
                    break;
            case FenixModelConstants.ID_PROCESO_EVALUACION_IBCIE:
                logger.warning("ibcie");
                setpIdCategoria(FenixModelConstants.ID_CATEGORIA_EVALUACION_IBCIE);
                getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_PROCESO_EVALUACION_IBCIE, viewaplicar,
                            valida);
                break;
            case FenixModelConstants.ID_PROCESO_EVALUACION_SIEMAS:
                logger.warning("siemas");
                setpIdCategoria(FenixModelConstants.ID_CATEGORIA_EVALUACION_SIEMAS);
                getAccionVO(estado, estado2, estado3, FenixModelConstants.ID_CATEGORIA_EVALUACION_SIEMAS, viewaplicar,
                            valida);
                break;
            default:
                logger.warning("gestor y otros procesos solo operacion");
                viewaplicar = FenixModelConstants.viewCriteriaGestor;
                estado = FenixModelConstants.ESTADO_ACCION_REGISTRADO;
                estado2 = null;
                estado3 = null;
                if (null != rolUsuario && rolUsuario.length() > 0) {
                    if (rolUsuario.equalsIgnoreCase(FenixModelConstants.ROL_OTROS)) {
                        logger.warning("cambia rol de process control a otros o cumplidor para el gestor u otros procesos");
                        viewaplicar = FenixModelConstants.viewCriteriaGestorOtros;
                        estado3 = FenixModelConstants.ESTADO_ACCION_DESESTIMADA;
                        estado2 = FenixModelConstants.ESTADO_ACCION_ELIMINADA;
                    }
                    if (rolUsuario.equalsIgnoreCase(FenixModelConstants.ROL_INGRESADOR_VALIDADOR)) {
                        logger.warning("cambia rol de process control a ingresador o validador en gestor u otros procesos");
                        viewaplicar = FenixModelConstants.viewCriteriaGestorIngresador;
                        estado2 = FenixModelConstants.ESTADO_ACCION_ELIMINADA;
                    }
                }
                getAccionVO(estado, estado2, estado3, null, viewaplicar, valida);
                break;
            }
            Boolean validar = Boolean.FALSE;
            actualizarEstadosAccion(validar, rolDUsuario, idTarea, loginUsuario, nombre);
            //actualizarVencidas(valida);
        }
    }


    private void getAccionVO(Integer estado, Integer estado2, Integer estado3, Integer categoria, String viewCriteria,
                             Boolean valida) {
        logger.log(ADFLogger.WARNING, "Inside getAccionVO.");
        ViewCriteria criteriaByClienteInstanciaProceso = null;

        criteriaByClienteInstanciaProceso = this.getViewCriteriaManager().getViewCriteria(viewCriteria);

        //   criteriaByClienteInstanciaProceso.ensureVariableManager().setVariableValue("pIdCategoria", categoria);
        if (null != estado) {
            criteriaByClienteInstanciaProceso.ensureVariableManager().setVariableValue("varIdEstado", estado);
        }
        if (null != estado2) {
            criteriaByClienteInstanciaProceso.ensureVariableManager().setVariableValue("varIdEstado2", estado2);
        }
        if (null != estado3) {
            criteriaByClienteInstanciaProceso.ensureVariableManager().setVariableValue("varIdEstado3", estado3);
        }

        this.clearCache();
        this.clearViewCriterias();
        this.applyViewCriteria(criteriaByClienteInstanciaProceso);
        this.executeQuery();

        // 2) Asignamos valor de retorno
        if (this.getEstimatedRowCount() <= 0) {
            logger.warning("No existen registros");

            // Removemos criteria del VO
            // this.getViewCriteriaManager().removeApplyViewCriteriaName(viewCriteria);

            // Re-ejecutamos el query
            // this.executeQuery();
        }else{
            logger.warning("Numero de registros encontrados : " + this.getEstimatedRowCount());
        }
    }

    /**
     * Returns the variable value for varIdEstado.
     * @return variable value for varIdEstado
     */
    public Integer getvarIdEstado() {
        return (Integer) ensureVariableManager().getVariableValue("varIdEstado");
    }

    /**
     * Sets <code>value</code> for variable varIdEstado.
     * @param value value to bind as varIdEstado
     */
    public void setvarIdEstado(Integer value) {
        ensureVariableManager().setVariableValue("varIdEstado", value);
    }

    /** validarAccionIngresada"
     * Metodo que validar se se ingreso una accion en la tabla "ACCION"
     * @param  idEstadoAccion
     * @param  IdTcaCategoriaAccion
     * @since 10/08/2016
     * @by Gabriel Niño Rosales
     */
    public Boolean validarAccionIngresada(Integer idEstadoAccion, Integer IdTcaCategoriaAccion) {
        logger.log(ADFLogger.WARNING, "Inside validarAccionIngresada.");
        Boolean resultado = Boolean.FALSE;
        try {
            ViewCriteria criteria = null;
            criteria = this.getViewCriteriaManager().getViewCriteria("AccionesTablaVOValidacionCategoria");
            criteria.ensureVariableManager().setVariableValue("varIdEstado", idEstadoAccion);
            criteria.ensureVariableManager().setVariableValue("pIdCategoria", IdTcaCategoriaAccion);
            this.applyViewCriteria(criteria);
            this.executeQuery();
            resultado = (this.getRowCount() > 0) ? Boolean.TRUE : Boolean.FALSE;
        } catch (Exception e) {
            logger.log(ADFLogger.ERROR, "Error en inicioLAFT " + e.getClass() + ":" + e.getMessage());
            resultado = Boolean.FALSE;
        } finally {
            //Siempre removemos el criterio de busqueda
            this.getViewCriteriaManager().removeApplyViewCriteriaName("AccionesTablaVOValidacionCategoria");
        }
        logger.log(ADFLogger.WARNING, "validarAccionIngresada return value is :" + resultado);
        return resultado;
    }

    /**
     * Returns the bind variable value for pIdCliente.
     * @return bind variable value for pIdCliente
     */
    public Long getpIdCliente() {
        return (Long) getNamedWhereClauseParam("pIdCliente");
    }

    /**
     * Sets <code>value</code> for bind variable pIdCliente.
     * @param value value to bind as pIdCliente
     */
    public void setpIdCliente(Long value) {
        setNamedWhereClauseParam("pIdCliente", value);
    }

    /**
     * Returns the variable value for pIdCategoria.
     * @return variable value for pIdCategoria
     */
    public Integer getpIdCategoria() {
        return (Integer) ensureVariableManager().getVariableValue("pIdCategoria");
    }

    /**
     * Sets <code>value</code> for variable pIdCategoria.
     * @param value value to bind as pIdCategoria
     */
    public void setpIdCategoria(Integer value) {
        ensureVariableManager().setVariableValue("pIdCategoria", value);
    }

    /**
     * Returns the variable value for varIdEstado2.
     * @return variable value for varIdEstado2
     */
    public Integer getvarIdEstado2() {
        return (Integer) ensureVariableManager().getVariableValue("varIdEstado2");
    }

    /**
     * Sets <code>value</code> for variable varIdEstado2.
     * @param value value to bind as varIdEstado2
     */
    public void setvarIdEstado2(Integer value) {
        ensureVariableManager().setVariableValue("varIdEstado2", value);
    }

    /**
     * Returns the variable value for varIdEstado3.
     * @return variable value for varIdEstado3
     */
    public Integer getvarIdEstado3() {
        return (Integer) ensureVariableManager().getVariableValue("varIdEstado3");
    }

    /**
     * Sets <code>value</code> for variable varIdEstado3.
     * @param value value to bind as varIdEstado3
     */
    public void setvarIdEstado3(Integer value) {
        ensureVariableManager().setVariableValue("varIdEstado3", value);
    }

    public void actualizarEstadosAccion(Boolean requiereValidacion, Integer rolDUsuario, Integer idTarea,
                                        String loginUsuario, String nombre) {
        logger.warning("Entra en actualizarEstadosAccion.");
        logger.warning("requiereValidacion: " + requiereValidacion);
        logger.warning("rolDUsuario: " + rolDUsuario);
        logger.warning("idTarea: " + idTarea);
        logger.warning("loginUsuario: " + loginUsuario);
        logger.warning("nombre: " + nombre);


        Boolean seguimientoAccion = Boolean.TRUE;
        FenixAMImpl fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        Long idAccion = null;
        Integer estadoAccion = null;
        java.sql.Timestamp fechaAntencion = null;
        Date fecha = new Date();
        java.sql.Timestamp fechaActual = new java.sql.Timestamp(fecha.getTime());
        fechaActual.setHours(0);
        fechaActual.setMinutes(0);
        fechaActual.setSeconds(0);
        fechaActual.setNanos(0);
        logger.warning("Fecha actual: " + fechaActual);
        logger.warning("registros encontrados: " + getEstimatedRowCount());
        RowSetIterator rowsAcciones = createRowSetIterator(null);
        rowsAcciones.reset();
        //se obtienen los registros de acciones encontrados
        while (rowsAcciones.hasNext()) {
            AccionesTablaVORowImpl activo = (AccionesTablaVORowImpl) rowsAcciones.next();
            estadoAccion = null;
            idAccion = null;
            fechaAntencion = null;
            if (null != (Long) activo.getAttribute("Id")) {
                idAccion = (Long) activo.getAttribute("Id");
            }
            if (null != (Integer) activo.getAttribute("IdEstadoAccion")) {
                estadoAccion = (Integer) activo.getAttribute("IdEstadoAccion");
            }
            if (null != (java.sql.Timestamp) activo.getAttribute("FechaAtencion")) {
                fechaAntencion = (java.sql.Timestamp) activo.getAttribute("FechaAtencion");
            }

            logger.warning("Id accion: " + idAccion);
            logger.warning("Id estadoAccion: " + estadoAccion);
            logger.warning("Fecha sugerida: " + fechaAntencion);
            if (requiereValidacion) {
                if (null != estadoAccion) {
                    if (estadoAccion.compareTo(FenixModelConstants.ESTADO_ACCION_REGISTRADO) == 0) {
                        logger.warning("Se actualiza la accion a por atender");
                        fenixAMImpl.getAccionVO().getAccionObtenido(idAccion,
                                                                    FenixModelConstants.ESTADO_ACCION_PORATENDER);
                        seguimientoAccion = fenixAMImpl.getSeguimientoAccionVO().obtenerEstadoActualAccion(idAccion);
                        if (seguimientoAccion) {
                            seguimientoAccion =
                                fenixAMImpl.getSeguimientoAccionVO().actualizarEstatusYCreaSeguimiento(FenixModelConstants.ESTADO_ACCION_REGISTRADO,
                                                                                                       FenixModelConstants.ESTADO_ACCION_PORATENDER,
                                                                                                       idAccion,
                                                                                                       rolDUsuario,
                                                                                                       idTarea,
                                                                                                       loginUsuario,
                                                                                                       nombre);
                        }
                    }
                }


            } else {
                if (null != estadoAccion) {
                    if (estadoAccion.compareTo(FenixModelConstants.ESTADO_ACCION_PORATENDER) == 0) {
                        if (fechaActual.compareTo(fechaAntencion) > 0) {
                            logger.warning("Se actualiza la accion a vencida");
                            fenixAMImpl.getAccionVO().getAccionObtenido(idAccion,
                                                                        FenixModelConstants.ESTADO_ACCION_VENCIDA);
                            seguimientoAccion =
                                fenixAMImpl.getSeguimientoAccionVO().obtenerEstadoActualAccion(idAccion);
                            if (seguimientoAccion) {
                                seguimientoAccion =
                                    fenixAMImpl.getSeguimientoAccionVO().actualizarEstatusYCreaSeguimiento(FenixModelConstants.ESTADO_ACCION_VENCIDA,
                                                                                                           FenixModelConstants.ESTADO_ACCION_PORATENDER,
                                                                                                           idAccion,
                                                                                                           rolDUsuario,
                                                                                                           idTarea,
                                                                                                           loginUsuario,
                                                                                                           nombre);
                            }
                        }
                    }
                }

            }
        }
        rowsAcciones.closeRowSetIterator();
        this.executeQuery();

    }


    public void filtrarPorRangoFecha(Timestamp fechaInicio, Timestamp fechaFin) {
        logger.warning("inside filtrarPorRangoFecha");

        logger.warning("FechaInicio: " + fechaInicio);
        logger.warning("FechaFin: " + fechaFin);

        String strFechaInicio = null;
        String strFechaFin = null;

        //Convertir Timestamp a cadena de texto

        //Generacion de clausula Where para ejecutar query con rango de fechas
        if (fechaInicio != null) {
            strFechaInicio = new SimpleDateFormat("dd/MM/yyyy").format(fechaInicio);
            if (fechaInicio != null && fechaFin == null) {
                setWhereClause("(FECHA_ATENCION = TO_DATE('" + strFechaInicio + "', 'DD-MM-YYYY'))");
                logger.warning("(FECHA_ATENCION = TO_DATE('" + strFechaInicio + "', 'DD-MM-YYYY'))");
                logger.warning("WhereClause creada");
            } else {
                strFechaFin = new SimpleDateFormat("dd/MM/yyyy").format(fechaFin);
                setWhereClause("(FECHA_ATENCION BETWEEN TO_DATE('" + strFechaInicio + "', 'DD-MM-YYYY') AND TO_DATE('" +
                               strFechaFin + "', 'DD-MM-YYYY'))");
                logger.warning("(FECHA_ATENCION BETWEEN TO_DATE('" + strFechaInicio + "', 'DD-MM-YYYY') AND TO_DATE('" +
                               strFechaFin + "', 'DD-MM-YYYY'))");
                logger.warning("WhereClause creada");
            }
        } else {
            setWhereClause(null);
            logger.warning("WhereClause reiniciada");
        }
    }
}
