package org.bcie.fenix.common.model.vo;

import com.bcie.xmlns.lineacreditoservice.LineaCredito;
import com.bcie.xmlns.lineacreditoservice.LineaCreditoPT;
import com.bcie.xmlns.operacionservice.Operacion12BndQSService;
import com.bcie.xmlns.operacionservice.Operacion12Port;

import java.math.BigDecimal;

import java.sql.Timestamp;

import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.JboException;
import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.server.ViewObjectImpl;

import org.bcie.atributobo.NivelType;
import org.bcie.commonbo.MontoType;
import org.bcie.fenix.common.model.vo.common.CalculoCargoPenalidadPrepagoVO;
import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.utils.IWsdlLocation;
import org.bcie.fenix.common.model.utils.ModelUtils;
import org.bcie.lineacreditomo.ConsultarFuentesRequestType;
import org.bcie.lineacreditomo.ConsultarFuentesResponseType;
import org.bcie.operacionmo.ConsultarOperacionByIdOperacionRequestType;
import org.bcie.operacionmo.ConsultarOperacionResponseType;

// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Wed Oct 05 18:07:47 CDT 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class CalculoCargoPenalidadPrepagoVOImpl extends ViewObjectImpl implements CalculoCargoPenalidadPrepagoVO {
    /**
     * This is the default constructor (do not remove).
     */
    private static ADFLogger logger = null;
    
    public CalculoCargoPenalidadPrepagoVOImpl() {
        if(logger == null){
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }

    /**
     * Returns the bind variable value for pIdPrepago.
     * @return bind variable value for pIdPrepago
     */
    public Long getpIdPrepago() {
        return (Long) getNamedWhereClauseParam("pIdPrepago");
    }

    /**
     * Sets <code>value</code> for bind variable pIdPrepago.
     * @param value value to bind as pIdPrepago
     */
    public void setpIdPrepago(Long value) {
        logger.log(ADFLogger.WARNING, "INTO setpIdPrepago en CalculoDetalleCargoPenalidadVOImpl." + value);
        setNamedWhereClauseParam("pIdPrepago", value);
        logger.log(ADFLogger.WARNING, "Ejecuta correctamente setNamedWhereClauseParam .");
    }

    public Map obtenerPenalidadPrepago(Long idPrepago) {

        logger.log(ADFLogger.WARNING, "INTO obtenerPenalidadPrepago.");

        Map<String, Object> atributosPenalidadPrepagoMap = new HashMap<String, Object>();
        //Map<String,Object> montoPenalidadFondoOrdinarioPrepagoMap = new HashMap<String,Object>();

        BigDecimal montoPenalidad = new BigDecimal(0);
        BigDecimal totalPenalidad = new BigDecimal(0);
        BigDecimal interes = new BigDecimal(0);
        BigDecimal totalInteres = new BigDecimal(0);
        Integer tipoMoneda = null;
        String nombreMoneda = null;

        //            BigDecimal totalMontoPenalidadFondoOrdinario = new BigDecimal(0);
        //            Integer idTipoMonedaPenalidadFondoOrdinario = null;
        //            Long idLineaCredito = null;
        //            String numeroLineaCredito = null;


        try {
            //Se ejecuta SQL para traer todos los rows con Penalidad
            setpIdPrepago(idPrepago);
            this.executeQuery();
            RowSetIterator rowsCategoriaVo = createRowSetIterator(null);
            rowsCategoriaVo.reset();
            //Se realiza la suma de las penalidades y los intereses
            while (rowsCategoriaVo.hasNext()) {
                CalculoCargoPenalidadPrepagoVORowImpl rowL =
                    (CalculoCargoPenalidadPrepagoVORowImpl) rowsCategoriaVo.next();
                if (null != rowL.getAttribute("MontoPenalidad")) {
                    montoPenalidad = (BigDecimal) rowL.getAttribute("MontoPenalidad");
                    totalPenalidad = totalPenalidad.add(montoPenalidad);
                } else {
                    logger.log(ADFLogger.WARNING, "Valor MontoPenalidad esta vacio.");
                }
                if (null != rowL.getAttribute("Intereses")) {
                    interes = (BigDecimal) rowL.getAttribute("Intereses");
                    totalInteres = totalInteres.add(interes);
                } else {
                    logger.log(ADFLogger.WARNING, "Valor Intereses esta vacio.");
                }
                if (null != rowL.getAttribute("DescripcionCorta")) {
                    nombreMoneda = (String) rowL.getAttribute("DescripcionCorta");
                } else {
                    logger.log(ADFLogger.WARNING, "Valor DescripcionCorta esta vacio.");
                }
                if (null != rowL.getAttribute("IdTcaTipoMoneda")) {
                    tipoMoneda = (Integer) rowL.getAttribute("IdTcaTipoMoneda");
                } else {
                    logger.log(ADFLogger.WARNING, "Valor IdTcaTipoMoneda esta vacio.");
                }
            }

            rowsCategoriaVo.closeRowSetIterator();
            //Se llama metodo para obtener el total de la penalidad de los contratos de desembolso con Recursos Ordinarios
            //            montoPenalidadFondoOrdinarioPrepagoMap = obtenerCargoPenalidadPrepagoByFondo();
            //            totalMontoPenalidadFondoOrdinario = (BigDecimal)montoPenalidadFondoOrdinarioPrepagoMap.get("totalPenalidadFondoOrdinario");
            //            idTipoMonedaPenalidadFondoOrdinario = (Integer)montoPenalidadFondoOrdinarioPrepagoMap.get("idTipoMonedaFondoOrdinario");
            logger.log(ADFLogger.WARNING, "Valor monto penalidad." + totalPenalidad);
            logger.log(ADFLogger.WARNING, "Valor monto intereses." + totalInteres);
            logger.log(ADFLogger.WARNING, "Id de la moneda :" + tipoMoneda);
            logger.log(ADFLogger.WARNING, "Descripcion de la moneda :" + nombreMoneda);
            atributosPenalidadPrepagoMap.put("totalMontoPenalidad", totalPenalidad);
            atributosPenalidadPrepagoMap.put("totalMontoInteres", totalInteres);
            atributosPenalidadPrepagoMap.put("idTcaTipoMOneda", tipoMoneda);
            atributosPenalidadPrepagoMap.put("nombreMoneda", nombreMoneda);

            //            atributosPenalidadPrepagoMap.put("totalMontoPenalidadFondoOrdinario", totalMontoPenalidadFondoOrdinario);
            //            atributosPenalidadPrepagoMap.put("idTipoMonedaPenalidadFondoOrdinario", idTipoMonedaPenalidadFondoOrdinario);

        } catch (Exception e) {
            logger.log(ADFLogger.ERROR, "Error en obtenerPenalidadPrepago" + e.getClass() + "." + e.getMessage());
        }
        return atributosPenalidadPrepagoMap;

    }
    
    public Map obtenerCargoPenalidadPrepagoByFondo(){
        
        logger.log(ADFLogger.WARNING, "INTO  obtenerCargoPenalidadPrepagoByFondo.");
        
        Map<String,Object> montoPenalidadPrepagoMap = new HashMap<String,Object>();
        //Variables para monto Penalidad con Fondos Ordinarios
        BigDecimal montoPenalidadFondoOrdinario = new BigDecimal(0);
        BigDecimal totalPenalidadFondoOrdinario = new BigDecimal(0);
        
        Integer idTipoMonedaFondoOrdinario = null;
        
        try {
            //Criterio de busqueda para obtener penalidades de contratos de desembolsos con Fondos Ordinarios
            ViewCriteria criteria =this.getViewCriteriaManager().getViewCriteria("CalculoCargoPenalidadPrepagoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pFondo", FenixModelConstants.FONDO);
            this.applyViewCriteria(criteria);
            this.executeQuery();
            
            RowSetIterator rowsCategoriaVo = createRowSetIterator(null);
            rowsCategoriaVo.reset();
                while (rowsCategoriaVo.hasNext()) {
                    CalculoCargoPenalidadPrepagoVORowImpl rowL = (CalculoCargoPenalidadPrepagoVORowImpl) rowsCategoriaVo.next();
                    if(null != rowL.getAttribute("MontoPenalidad")){
                        montoPenalidadFondoOrdinario = (BigDecimal)rowL.getAttribute("MontoPenalidad");
                        totalPenalidadFondoOrdinario = totalPenalidadFondoOrdinario.add(montoPenalidadFondoOrdinario);
                    }else{
                        logger.warning("Valor MontoPenalidad es nulo.");
                    }
                    if(null != rowL.getAttribute("IdTcaTipoMoneda")){
                        idTipoMonedaFondoOrdinario = (Integer)rowL.getAttribute("IdTcaTipoMoneda");
                    }else{
                        logger.warning("Valor IdTcaTipoMoneda es nulo.");
                    }
                    
                        logger.warning("Monto penalidad con Fondo Ordinario :" + rowL.getAttribute("MontoPenalidad"));
                    }
            
            rowsCategoriaVo.closeRowSetIterator();
            //Se agregan valores de Contratos con Fondos Ordinarios al MAPA
            montoPenalidadPrepagoMap.put("totalPenalidadFondoOrdinario", totalPenalidadFondoOrdinario);
            montoPenalidadPrepagoMap.put("idTipoMonedaFondoOrdinario", idTipoMonedaFondoOrdinario);
            
            logger.log(ADFLogger.WARNING, "Monto totalPenalidadFondoOrdinario :" + totalPenalidadFondoOrdinario);
            
        } catch (Exception ex) {
            logger.log(ADFLogger.ERROR, "Error en consultarPrepagoById " + ex.getClass() + ":" + ex.getMessage());
        } finally {
            //This takes care of removing the applied VC.
            this.getViewCriteriaManager().removeApplyViewCriteriaName("CalculoCargoPenalidadPrepagoVOCriteria");
        }
        return montoPenalidadPrepagoMap;
    }

    public void obtenerDatosFuentesExternas(Long idLineaCredito) {
        logger.warning("Inicia metodo obtenerDatosFuentesExternas");
        FenixAMImpl fenixAMImpl = null;
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        String wsdl = fenixAMImpl.getWsdl(IWsdlLocation.LINEA_CREDITO);
        ConsultarFuentesRequestType request = new ConsultarFuentesRequestType();
        ConsultarFuentesResponseType response = null;
        
        Long idContrato = new Long(0);
        List<Long> contratos = new ArrayList<Long>();
        //idLineaCreditoLong = new Long(idLineaCredito.longValue());
        idLineaCredito = new Long(61);

        LineaCredito lineaCredito = IWsdlLocation.Service.getInstance(LineaCredito.class, wsdl);
        LineaCreditoPT lineaCreditoPT = lineaCredito.getLineaCredito12Bnd();

        request.setLineaCredito(new org.bcie.lineacreditobo.LineaCredito());
        request.getLineaCredito().setIdLineaCredito(idLineaCredito);
        request.getLineaCredito().setNumeroLineaCredito("1675");

        try {
            logger.warning("Ejecutando servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE);
            Date horaInicio = ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_CONSULTAR_FUENTE);
            response = lineaCreditoPT.consultarFuentes(request);
            ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_CONSULTAR_FUENTE, horaInicio);
            logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE + " ejecutado correctamente");
        } catch (Exception e) {
            logger.warning("Error al ejecutar servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE);
        }
        if(null != response){
            if (null != response.getResultado()) {
                if (response.getResultado().getResult().value() == "OK") {
                    if (null != response.getLineaCredito()) {
                        logger.warning("Obteniendo datos de servicio.");
                        if (null != response.getLineaCredito().getFuente() ||
                            response.getLineaCredito().getFuente().size() > 0) {
                            for (org.bcie.lineacreditobo.Fuente fuente : response.getLineaCredito().getFuente()) {
                                if(fuente.getIdContrato() > 0 && idContrato != fuente.getIdContrato()){
                                idContrato = fuente.getIdContrato();
                                contratos.add(idContrato);
                             System.out.println("Valor de id Contrato Desembolso :" + idContrato);
                                }else{
                                    System.out.println("Valor de Contrato Se repite." + idContrato);
                                }
                            }
                        } else {
                            logger.warning("La lista de Fuentes de la LineaCredito del servicio " +
                                           FenixModelConstants.WSC_CONSULTAR_FUENTE + " es vacia.");
                        }
                    } else {
                        logger.warning("El objeto LineaCredito del servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE +
                                       " es NULL.");
                    }
                } else {
                    logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE + " devuelve ERROR >> " +
                                   response.getResultado().getMessage());
                }
            } else {
                logger.warning("getResultado de servicio " + FenixModelConstants.WSC_CONSULTAR_FUENTE + " es NULL.");
            }
        }else{
            logger.warning("ERROR: Response es null.");
        }
        System.out.println("Tamaño del arreglo de Contratos :" + contratos.size());
        logger.warning("Registros de Fuentes Obtenidas: " + getEstimatedRowCount());
        logger.warning("Termina metodo obtenerDatosFuentesExternas");
    }

}

