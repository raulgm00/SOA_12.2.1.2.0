package org.bcie.fenix.common.model.vo;

import java.sql.SQLException;

import java.sql.Timestamp;

import java.text.SimpleDateFormat;

import java.util.ArrayList;
import java.util.Date;

import java.util.GregorianCalendar;
import java.util.List;

import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.XMLGregorianCalendar;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.JboException;
import oracle.jbo.Key;
import oracle.jbo.NameValuePairs;
import oracle.jbo.Row;
import oracle.jbo.RowIterator;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.domain.Array;
import oracle.jbo.domain.Number;
import oracle.jbo.server.SequenceImpl;
import oracle.jbo.server.ViewObjectImpl;

import org.bcie.atributobo.Accion;
import org.bcie.atributobo.EntidadMinima;
import org.bcie.atributobo.EstadoTCC;
import org.bcie.catalogobo.Catalogo;
import org.bcie.condicionbo.CatalogoCondicion;
import org.bcie.condicionbo.CategoriaCondicion;
import org.bcie.condicionbo.Condicion;
import org.bcie.condicionbo.ObservacionCondicion;
import static org.bcie.fenix.common.model.FenixModelConstants.BANESTATUS_FALSE;
import static org.bcie.fenix.common.model.FenixModelConstants.BANESTATUS_TRUE;
import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.utils.IWsdlLocation;
import org.bcie.fenix.common.model.utils.ModelUtils;
import org.bcie.fenix.common.model.vo.common.TccCondicionVO;
import org.bcie.matriztccbo.ListaTCC;
import org.bcie.matriztccbo.TCC;
import org.bcie.matriztccbo.Tipo;
import org.bcie.matriztccmo.ActualizarEstadoTCCRequestType;
import org.bcie.matriztccmo.ActualizarEstadoTCCResponseType;
import org.bcie.matriztccmo.ActualizarTCCRequestType;
import org.bcie.matriztccservice.MatrizTCC12BndQSService;
import org.bcie.matriztccservice.MatrizTCCPT;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Wed Feb 10 16:18:26 CST 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class TccCondicionVOImpl extends ViewObjectImpl implements TccCondicionVO {
    
    /**
     * Log de la aplicacion
     */
    private static ADFLogger logger = ADFLogger.createADFLogger(TccCondicionVOImpl.class);
    
    /**
     * Define nombre de view criteria para realizar busqueda por Id de Condicion
     */
    public static final String BUSCAR_POR_ID_VC = "CondicionByIdVC";
    
    /**
     * Define ID de Estado TCC para Nuevo Elemento
     */
    public static final Integer ID_ESTADO_TCC_NUEVO = 7;
    
    /**
     * This is the default constructor (do not remove).
     */
    public TccCondicionVOImpl() {
    }

    /**
     * Returns the variable value for pId.
     * @return variable value for pId
     */
    public Long getpId() {
        return (Long) ensureVariableManager().getVariableValue("pId");
    }

    /**
     * Sets <code>value</code> for variable pId.
     * @param value value to bind as pId
     */
    public void setpId(Long value) {
        ensureVariableManager().setVariableValue("pId", value);
    }
    
    /**
     * Ejecuta la busqueda de Condicion por Id
     * @param id contiene clave primaria del registro
     */
    public void buscarCondicionPorId(Number id){
        logger.entering(TccCondicionVOImpl.class.getName(), "buscarCondicionPorId", id);
        
        //Refresca VO
        executeQuery();
        Row row = null;
        
        if(id != null) { 
            //Row row = this.getRow(new Key(new Object[]{id.longValue()}));
            row = buscarCondicionPorIdVC(id);
            if(row != null){
                logger.warning("Asigna current row");
                setCurrentRow(row);    
            }
        }
                
        logger.exiting(TccCondicionVOImpl.class.getName(), "buscarCondicionPorId");
    }
    
    private Row buscarCondicionPorIdVC(Number idCondicion){
        logger.warning("Entra en buscarCondicionPorIdVC");
        Row row = null;
        ViewCriteria vc = null;
        Long idCondicionLong = null;
        try{
            idCondicionLong = idCondicion.longValue();
            vc = getViewCriteria(BUSCAR_POR_ID_VC);
            vc.ensureVariableManager().setVariableValue("pId", idCondicionLong);
            applyViewCriteria(vc);
            executeQuery();
            
            if(this.getEstimatedRowCount() > 0){
                logger.warning("Se obtiene row de condicion por criterio de busqueda");
                setCurrentRow(first());
                row = first();
            }else{
                logger.warning("No se encontro row por criterio de busqueda.");
            }
            
        }catch(Exception e){
            logger.warning("Error en buscarCondicionPorIdVC.", e);
        }finally{
            logger.warning("Se remueve criterio");
            vc.getViewCriteriaManager().removeApplyViewCriteriaName(BUSCAR_POR_ID_VC);
        }
        return row;
    }
    
    /**
     * Asigna a configuracion del catalogo tipo condicion al registro actual de condicion
     */
    public void asignarConfigTipoCondicion(){
        
        TccCondicionVORowImpl row = null;
        row = (TccCondicionVORowImpl) getCurrentRow();
        if(row != null){
            
            FenixAMImpl fenixAM = null;
            fenixAM = (FenixAMImpl) getApplicationModule();
            
            if(fenixAM != null){
                
                Boolean esEditableForm = null;
                Boolean esDispensaEnm = null;
                
                if(fenixAM.getTccTcaTerminoVO() != null){
                                        
                    if(row.getIdTcaCondicion() != null){
                        fenixAM.getTcaCondicionLOV().buscarTcaCondicionPorId(row.getIdTcaCondicion());    
                        if(fenixAM.getTcaCondicionLOV().getCurrentRow() != null){
                            
                            TcaCondicionLOVRowImpl tcaRow = null;
                            tcaRow = (TcaCondicionLOVRowImpl) fenixAM.getTcaCondicionLOV().getCurrentRow();
                            
                            if(tcaRow != null){
                                
                                if(tcaRow.getEsEditableEnFormalizacion() != null){
                                    if(tcaRow.getEsEditableEnFormalizacion().equals(new Integer(0))){
                                        logger.warning("El valor bandera de campo Es Editable en Formalizacion es negativo = 0");
                                        esEditableForm = false;
                                    }else{
                                        if(tcaRow.getEsEditableEnFormalizacion().equals(new Integer(1))){
                                            logger.warning("El valor bandera de campo Es Editable en Formalizacion es positivo = 1");
                                            esEditableForm = true;
                                        }else{
                                            logger.warning("Valor de campo Es Editable en Formalizacion no es valido");
                                        }
                                    }
                                }else{
                                    logger.warning("El valor del campo Es Editable en Formalizacion es NULL");
                                }
                                
                                
                                if(tcaRow.getSePuedeDispensar() != null){
                                    if(tcaRow.getSePuedeDispensar().equals(new Integer(0))){
                                        esDispensaEnm = false;
                                    }else{
                                        if(tcaRow.getSePuedeDispensar().equals(new Integer(1))){
                                            esDispensaEnm = true;
                                        }else{
                                            logger.warning("Valor de campo Se Puede Dispensar no es valido");
                                        }
                                    }
                                }else{
                                    logger.warning("El valor del campo Se Puede Dispensar en Enmiendas es NULL");
                                }
                            }
                        }else{
                            logger.warning("No se encontro registro de catalogo Condicion");
                        }
                    }
                }
                
                if(esEditableForm != null){
                    logger.warning("Asigna configuracion de campo Es Editable en Formalizacion: " + esEditableForm);
                    row.setEditableFormalizacion(esEditableForm);    
                }
                if(esDispensaEnm != null){
                    logger.warning("Asigna configuracion de campo Es Dispensa en Enmienda: " + esDispensaEnm);
                    row.setDispensaEnmienda(esDispensaEnm);
                }
            }else{
                logger.warning("No se pudo obtener instancia de Application Module");    
            }
        }else{
            logger.warning("No hay registro actual que asignar configuracion de catalogo tcc");
        }
    }
    
    /**
     * Inicializa los valores de la Condicion
     */
    public void inicializaTccCondicion(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "inicializaTccCondicion");
        
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        
        
        if(row != null){
            
            FenixAMImpl am = (FenixAMImpl) getApplicationModule();
            if(null != idModalidad){
                if(new Integer(1).equals(idModalidad)){
                    if(am != null){
                        //Incializa VO de Categorias Condicion
                        logger.warning("Incializa Catalogos de COndiciones en modalidad TREE");
                        logger.warning("Realiza la busqueda del Catalogo de Categoria Condicion");
                        am.getTccTcaCategoriaCondicionVO().buscarCategoriaCondicionActivos();
                        
                        //Inicializa VO de Eventos Condicion
                        logger.warning("Realiza la busqueda del Catalogo de Eventos Condicion");
                        am.getTccTcaEventoCondicionLOV().buscarEventosCondicionActivos();
                        
                        //logger.warning("Realiza la busqueda de observacion principal de la Condicion");
                        //am.getTccObservacionCondicionVO().buscarPrincipal();
                        
                        logger.warning("Realiza la busqueda de Fuentes de Condicion");
                        am.getTccFuenteCondicionLOV().buscarPorIdCondicion(row.getId());
                        
                        logger.warning("Realiza la busqueda de Lineas de Credito de Condicion");
                        am.getTccLineaCreditoCondicionLOV().buscarLineaCreditoPorIdCondicion(row.getId());
                    }
                } else {
                    if(am != null){
                        //Incializa VO de Categorias Condicion
                        logger.warning("Incializa Catalogos de COndiciones en modalidad GRID");
                        logger.warning("Realiza la busqueda del Catalogo de Categoria Condicion");
                        am.getTccTcaCategoriaCondicionGridVO().buscarCategoriaCondicionActivos();
                        
                        //Inicializa VO de Eventos Condicion
                        logger.warning("Realiza la busqueda del Catalogo de Eventos Condicion");
                        am.getTccTcaEventoCondicionGridLOV().buscarEventosCondicionActivos();
                        
                        //logger.warning("Realiza la busqueda de observacion principal de la Condicion");
                        //am.getTccObservacionCondicionVO().buscarPrincipal();
                        
                        logger.warning("Realiza la busqueda de Fuentes de Condicion");
                        am.getTccFuenteCondicionGridLOV().buscarPorIdCondicion(row.getId());
                        
                        logger.warning("Realiza la busqueda de Lineas de Credito de Condicion");
                        am.getTccLineaCreditoCondicionGridLOV().buscarLineaCreditoPorIdCondicion(row.getId());
                    }
                }
                    
                logger.warning("Llama el metodo para obtener los Id de Categoria Condicion");
                obtenerIdCategoriaCond(idModalidad);
                logger.warning("Llama el metodo para obtener los Id de Evento Condicion");
                obtenerIdEventoCond(idModalidad);
                
                logger.warning("Llama el metodo para obtener las descripciones de Categoria Condicion");
                obtenerDescCategoriaCond(idModalidad);
                logger.warning("Llama el metodo para obtener las descripciones de Evento Condicion");
                obtenerDescEventoCond(idModalidad);
                    
                TccObservacionCondicionVORowImpl rowObservacion = obtenerObservacionPrincipal();
                if(rowObservacion != null){
                    logger.warning("Asigna observacion principal a atributo temporal de la Condicion");
                    row.setDescObservacionPrincipal(rowObservacion.getObservacion());
                }
                
            }else{
                logger.warning("idModalidad es null");
            }
        }else{
            logger.warning("No se obtuvo current row de Condicion que inicializar");
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "inicializaTccCondicion");
    }
    
    public Boolean evaluarEventoDesembolso(){
        logger.warning("Inicia metodo evaluarEventoDesembolso.");
        Boolean existeEventoDesembolso = Boolean.FALSE;
        Row row = getCurrentRow();
        oracle.jbo.domain.Array arrayEventos = null;
        List<Number> eventosList = new ArrayList<Number>();
        
        if(null != row){
            try{
                arrayEventos = (Array) row.getAttribute(TccCondicionVORowImpl.IDEVENTOCONDLIST);
            }catch(Exception e){
                logger.warning("ERROR al recuperar la lista de eventos de la Condicion.", e);
            }
            
            logger.warning("arrayEventos: " + arrayEventos);
            logger.warning("eventosList: " + eventosList);
            
            /* if(null != eventosList && eventosList.size() > 0){
                logger.warning("eventosList: " + eventosList);
                for(Number idEvento : eventosList){
                    if(idEvento.compareTo(2)==0 || idEvento.compareTo(3)==0){
                        logger.warning("Evento de desembolso existente.");
                        existeEventoDesembolso = Boolean.TRUE;
                        break;
                    }
                }
            }else{
                logger.warning("La lista de eventos es NULL o vacia.");
            } */
            
            if(null != arrayEventos && arrayEventos.getSize() > 0){
                logger.warning("arrayEventos: " + arrayEventos);
                List listaEventosObj = new ArrayList();
                listaEventosObj = arrayEventos.getList();
                Integer idEvento = null;
                for(Object objetoEvento : listaEventosObj){
                    idEvento = Integer.parseInt(objetoEvento.toString());
                    if(idEvento.compareTo(2)==0 || idEvento.compareTo(3)==0){
                        logger.warning("Evento de desembolso existente.");
                        existeEventoDesembolso = Boolean.TRUE;
                        break;
                    }
                }
            }else{
                logger.warning("La lista de eventos es NULL o vacia.");
            }
        }
        
        logger.warning("Termina metodo evaluarEventoDesembolso.");
        return existeEventoDesembolso;
    }
    
    private void obtenerIdCategoriaCond(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "obtenerIdCategoriaCond");
        
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        if(am != null){
            
            TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
            if(row != null){
                
                if(new Integer(1).equals(idModalidad)){
                    logger.warning("Obteniendo ID de categroia en modo TREE");
                    if(am.getTreCategoriaCondicionVO().getEstimatedRowCount() > 0){
                        
                        logger.warning("Cantidad de registros detalle de Categoria Condicion: " + 
                                       am.getTreCategoriaCondicionVO().getEstimatedRowCount());
                        
                        List<Number> idCategoriasList = null;
                        
                        RowSetIterator iter = null;
                        try{
                            iter = am.getTreCategoriaCondicionVO().createRowSetIterator(null);
                            if(iter != null){
                                
                                
                                Number idCategoria = null;
                                TreCategoriaCondicionVORowImpl rowCategoria = null;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    rowCategoria = (TreCategoriaCondicionVORowImpl) iter.next();
                                    if(rowCategoria.getIdTcaCategoria() != null){
                                        
                                        try{
                                            idCategoria = new Number(rowCategoria.getIdTcaCategoria());
                                        }catch(Exception e){
                                            logger.severe("Error al convertir el Id TCA Categoria", e);
                                        }
                                        
                                        if(idCategoria != null){
                                            
                                            if(idCategoriasList == null){
                                                idCategoriasList = new ArrayList<Number>();
                                            }
                                            idCategoriasList.add(idCategoria);
                                        }
                                    }
                                }
                            }
                        }catch(Exception e){
                            logger.severe("Error al procesar el detalle Categoria Condicion", e);
                        }finally{
                            if(iter != null){
                                iter.closeRowSetIterator();
                            }
                        }
                        
                        if(idCategoriasList != null){
                            oracle.jbo.domain.Array arrayCategoria = null;
                            arrayCategoria = new oracle.jbo.domain.Array(idCategoriasList);
                            logger.warning("Asigna Array List de Id de Categoria Condicion");
                            row.setIdCategoriaCondList(arrayCategoria);
                        }
                    }else{
                        logger.warning("No se encontro detalle Categoria Condicion");
                    }
                } else {
                    logger.warning("Obteniendo ID de categroia en modo GRID");
                    if(am.getTreCategoriaCondicionGridVO().getEstimatedRowCount() > 0){
                        
                        logger.warning("Cantidad de registros detalle de Categoria Condicion: " + 
                                       am.getTreCategoriaCondicionGridVO().getEstimatedRowCount());
                        
                        List<Number> idCategoriasList = null;
                        
                        RowSetIterator iter = null;
                        try{
                            iter = am.getTreCategoriaCondicionGridVO().createRowSetIterator(null);
                            if(iter != null){
                                
                                
                                Number idCategoria = null;
                                TreCategoriaCondicionVORowImpl rowCategoria = null;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    rowCategoria = (TreCategoriaCondicionVORowImpl) iter.next();
                                    if(rowCategoria.getIdTcaCategoria() != null){
                                        
                                        try{
                                            idCategoria = new Number(rowCategoria.getIdTcaCategoria());
                                        }catch(Exception e){
                                            logger.severe("Error al convertir el Id TCA Categoria", e);
                                        }
                                        
                                        if(idCategoria != null){
                                            
                                            if(idCategoriasList == null){
                                                idCategoriasList = new ArrayList<Number>();
                                            }
                                            idCategoriasList.add(idCategoria);
                                        }
                                    }
                                }
                            }
                        }catch(Exception e){
                            logger.severe("Error al procesar el detalle Categoria Condicion", e);
                        }finally{
                            if(iter != null){
                                iter.closeRowSetIterator();
                            }
                        }
                        
                        if(idCategoriasList != null){
                            oracle.jbo.domain.Array arrayCategoria = null;
                            arrayCategoria = new oracle.jbo.domain.Array(idCategoriasList);
                            logger.warning("Asigna Array List de Id de Categoria Condicion");
                            row.setIdCategoriaCondList(arrayCategoria);
                        }
                    }else{
                        logger.warning("No se encontro detalle Categoria Condicion");
                    }
                }
            }else{
                logger.severe("No se obtuvo registro actual de Condicion");
            }
        }else{
            logger.severe("No se obtuvo Application Module");
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "obtenerIdCategoriaCond");
    }
    
    /**
     * Lee el detalle de Evento Condicion de la condicion actual y obtiene los Id de catalogo Evento Condicion para 
     * almacenarlos en atributo temporal de la Condicion para facilitar su visualizacion en pantalla
     */
    private void obtenerIdEventoCond(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "obtenerIdEventoCond");
        
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        if(am != null){
            
            TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
            if(row != null){
                
                if(new Integer(1).equals(idModalidad)){
                    logger.warning("Obteniendo ID de Evenetos en modo TREE");
                    if(am.getTreTcaEventoCondicionVO().getEstimatedRowCount() > 0){
                        
                        logger.warning("Cantidad de registros detalle de Evento Condicion: " + 
                                       am.getTreTcaEventoCondicionVO().getEstimatedRowCount());
                        
                        List<Number> idEventosList = null;
                        
                        RowSetIterator iter = null;
                        try{
                            iter = am.getTreTcaEventoCondicionVO().createRowSetIterator(null);
                            if(iter != null){
                                
                                
                                Number idEvento = null;
                                TreTcaEventoCondicionVORowImpl rowEvento = null;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    rowEvento = (TreTcaEventoCondicionVORowImpl) iter.next();
                                    if(rowEvento.getIdTcaEvento() != null){
                                        
                                        try {
                                            idEvento = new Number(rowEvento.getIdTcaEvento());
                                        } catch (SQLException e) {
                                            logger.severe("Error al convertir el Id TCA Evento", e);
                                        }
                                        
                                        if(idEvento != null){
                                            if(idEventosList == null){
                                                idEventosList = new ArrayList<Number>();
                                            }
                                            idEventosList.add(idEvento);
                                        }
                                    }
                                }
                            }
                        }catch(Exception e){
                            logger.severe("Error al procesar el detalle Evento Condicion", e);
                        }finally{
                            if(iter != null){
                                iter.closeRowSetIterator();
                            }
                        }
                        
                        if(idEventosList != null){
                            oracle.jbo.domain.Array arrayEventos = null;
                            arrayEventos = new oracle.jbo.domain.Array(idEventosList);
                            logger.warning("Asigna Array List de Id de Evento Condicion");
                            row.setIdEventoCondList(arrayEventos);
                        }
                    }else{
                        logger.warning("No se encontro detalle Evento Condicion");
                    }
                } else {
                    logger.warning("Obteniendo ID de Evenetos en modo GRID");
                    if(am.getTreTcaEventoCondicionGridVO().getEstimatedRowCount() > 0){
                        
                        logger.warning("Cantidad de registros detalle de Evento Condicion: " + 
                                       am.getTreTcaEventoCondicionGridVO().getEstimatedRowCount());
                        
                        List<Number> idEventosList = null;
                        
                        RowSetIterator iter = null;
                        try{
                            iter = am.getTreTcaEventoCondicionGridVO().createRowSetIterator(null);
                            if(iter != null){
                                
                                
                                Number idEvento = null;
                                TreTcaEventoCondicionVORowImpl rowEvento = null;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    rowEvento = (TreTcaEventoCondicionVORowImpl) iter.next();
                                    if(rowEvento.getIdTcaEvento() != null){
                                        
                                        try {
                                            idEvento = new Number(rowEvento.getIdTcaEvento());
                                        } catch (SQLException e) {
                                            logger.severe("Error al convertir el Id TCA Evento", e);
                                        }
                                        
                                        if(idEvento != null){
                                            if(idEventosList == null){
                                                idEventosList = new ArrayList<Number>();
                                            }
                                            idEventosList.add(idEvento);
                                        }
                                    }
                                }
                            }
                        }catch(Exception e){
                            logger.severe("Error al procesar el detalle Evento Condicion", e);
                        }finally{
                            if(iter != null){
                                iter.closeRowSetIterator();
                            }
                        }
                        
                        if(idEventosList != null){
                            oracle.jbo.domain.Array arrayEventos = null;
                            arrayEventos = new oracle.jbo.domain.Array(idEventosList);
                            logger.warning("Asigna Array List de Id de Evento Condicion");
                            row.setIdEventoCondList(arrayEventos);
                        }
                    }else{
                        logger.warning("No se encontro detalle Evento Condicion");
                    }
                }
            }else{
                logger.severe("No se obtuvo registro actual de Condicion");
            }            
        }else{
            logger.severe("No se obtuvo Application Module");
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "obtenerIdEventoCond");
    }
    
    private void obtenerDescCategoriaCond(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "obtenerDescCategoriaCond");
        
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        
        if(row != null){
            //Obtiene descripcion de categorias condicion
            List<String> descCategoriaList = null;
            
            if(new Integer(1).equals(idModalidad)){
                if(row.getTreCategoriaCondicionVO().getRowCount() > 0){
                    
                    RowSetIterator iter = null;
                    Row[] rowsCat = null;
                    try{
                        
                        rowsCat = row.getTreCategoriaCondicionVO().getAllRowsInRange();
                        if(rowsCat != null){
                            
                            if(new Integer(1).equals(idModalidad)){
                                logger.warning("Obteniendo iterador para descripcion de categorias en modo TREE");
                                iter = am.getTccTcaCategoriaCondicionVO().createRowSetIterator(null);
                            }else{
                                logger.warning("Obteniendo iterador para descripcion de categorias en modo GRID");
                                iter = am.getTccTcaCategoriaCondicionGridVO().createRowSetIterator(null);
                            }
                            for(Row rowCat : rowsCat){
                                
                                TreCategoriaCondicionVORowImpl rowCatCond =  null;
                                TcaCategoriaCondicionVORowImpl rowTcaCat = null;
                                
                                rowCatCond = (TreCategoriaCondicionVORowImpl) rowCat;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    rowTcaCat = (TcaCategoriaCondicionVORowImpl) iter.next();
                                    if(rowCatCond.getIdTcaCategoria() != null &&
                                       rowTcaCat.getId() != null){
                                        
                                        Integer id = rowTcaCat.getId().intValue();
                                        if(rowCatCond.getIdTcaCategoria().equals(id)){
                                            
                                            if(descCategoriaList == null){
                                                descCategoriaList = new ArrayList<String>();
                                            }
                                            descCategoriaList.add(rowTcaCat.getDescripcion());
                                        }
                                    }
                                }
                            }
                        }
                    }catch(Exception e){
                        logger.severe("Error al iterar y obtener las descripcion de Categoria Condicion", e);
                    }finally{
                        
                        if(iter != null){
                            iter.closeRowSetIterator();
                        }
                    }
                }
                
                if(descCategoriaList != null &&
                   descCategoriaList.size() > 0){
                    row.setDescCategoriaCondList(descCategoriaList.toString());
                }else{
                    logger.warning("No se obtuvieron descripciones de Categoria Condicion");
                }
            } else {
                if(row.getTreCategoriaCondicionVO().getRowCount() > 0){
                    
                    RowSetIterator iter = null;
                    Row[] rowsCat = null;
                    try{
                        
                        rowsCat = row.getTreCategoriaCondicionVO().getAllRowsInRange();
                        if(rowsCat != null){
                            
                            iter = am.getTccTcaCategoriaCondicionGridVO().createRowSetIterator(null);
                            for(Row rowCat : rowsCat){
                                
                                TreCategoriaCondicionVORowImpl rowCatCond =  null;
                                TcaCategoriaCondicionVORowImpl rowTcaCat = null;
                                
                                rowCatCond = (TreCategoriaCondicionVORowImpl) rowCat;
                                
                                iter.reset();
                                while(iter.hasNext()){
                                    rowTcaCat = (TcaCategoriaCondicionVORowImpl) iter.next();
                                    if(rowCatCond.getIdTcaCategoria() != null &&
                                       rowTcaCat.getId() != null){
                                        
                                        Integer id = rowTcaCat.getId().intValue();
                                        if(rowCatCond.getIdTcaCategoria().equals(id)){
                                            
                                            if(descCategoriaList == null){
                                                descCategoriaList = new ArrayList<String>();
                                            }
                                            descCategoriaList.add(rowTcaCat.getDescripcion());
                                        }
                                    }
                                }
                            }
                        }
                    }catch(Exception e){
                        logger.severe("Error al iterar y obtener las descripcion de Categoria Condicion", e);
                    }finally{
                        
                        if(iter != null){
                            iter.closeRowSetIterator();
                        }
                    }
                }
                
                if(descCategoriaList != null &&
                   descCategoriaList.size() > 0){
                    row.setDescCategoriaCondList(descCategoriaList.toString());
                }else{
                    logger.warning("No se obtuvieron descripciones de Categoria Condicion");
                }
            }
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "obtenerDescCategoriaCond");
    }
    
    private void obtenerDescEventoCond(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "obtenerDescEventoCond");
        
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        
        if(row != null){
            //Obtiene descripcion de eventos condicion
            List<String> descEventosList = null;
            if(row.getTreTcaEventoCondicionVO().getRowCount() > 0){
                
                RowSetIterator iter = null;
                Row[] rowsEvent = null;
                try{
                    rowsEvent = row.getTreTcaEventoCondicionVO().getAllRowsInRange();
                    if(rowsEvent != null){
                        
                        if(new Integer(1).equals(idModalidad)){
                            logger.warning("Obteniendo iterador para descripcion de eventos en modo TREE");
                            iter = am.getTccTcaEventoCondicionLOV().createRowSetIterator(null);
                        } else {
                            logger.warning("Obteniendo iterador para descripcion de eventos en modo GRID");
                            iter = am.getTccTcaEventoCondicionGridLOV().createRowSetIterator(null);
                        }
                        for(Row rowEvent : rowsEvent){
                            
                            TreTcaEventoCondicionVORowImpl rowEventCond = null;
                            TcaEventoCondicionLOVRowImpl rowTcaEvento = null;
                            
                            rowEventCond = (TreTcaEventoCondicionVORowImpl) rowEvent;
                            
                            iter.reset();
                            while(iter.hasNext()){
                                rowTcaEvento = (TcaEventoCondicionLOVRowImpl) iter.next();
                                if(rowEventCond.getIdTcaEvento() != null &&
                                   rowTcaEvento.getTecId() != null){
                                    
                                    Integer id = rowTcaEvento.getTecId().intValue();
                                    if(rowEventCond.getIdTcaEvento().equals(id)){
                                        
                                        if(descEventosList == null){
                                            descEventosList = new ArrayList<String>();
                                        }
                                        descEventosList.add(rowTcaEvento.getTecDescripcion());
                                    }
                                }
                            }
                        }
                    }
                }catch(Exception e){
                    logger.severe("Error al iterar y obtener las descripciones de Eventos Condicion", e);
                }finally{
                    
                    if(iter != null){
                        iter.closeRowSetIterator();
                    }
                }
            }
            
            if(descEventosList != null &&
               descEventosList.size() > 0){
                row.setDescEventosCondList(descEventosList.toString());
            }else{
                logger.warning("No se obtuvieron descripcion de Eventos Condicion");
            }
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "obtenerDescEventoCond");
    }
    
    /**
     * Consume el WS para actualizar el estado TCC de Condiciones
     * @return devuelve valor booleano, true indica que el proceso fue exitoso o false en caso contrario
     */
    public boolean actualizarEstadoCondicion(){
        
        logger.entering(TccCondicionVOImpl.class.getName(), 
                        "actualizarEstadoCondicion");
        
        boolean esError = false;
        ActualizarEstadoTCCRequestType request = null;
        ListaTCC listaTcc = null;
        List<TCC> tcc = null;
        String mensajeError = null;
        
        RowSetIterator iter = createRowSetIterator(null);
        if(iter != null){
            TccCondicionVORowImpl row = null;
            TCC element = null;
            
            iter.reset();
            while(iter.hasNext()){
                
                row = (TccCondicionVORowImpl) iter.next();
                
                element = new TCC();
                //Mapeo de atributos de VO con Objeto de WS
                element.setId(row.getId().longValue());
                element.setEstado(row.getIdTcaEstadoTcc());
                element.setSubEstado(row.getIdTcaSubEstadoTcc());
                element.setTipo(Tipo.CONDICION);
                
                if(tcc == null){
                    tcc = new ArrayList<TCC>();
                }
                tcc.add(element);
            }
            iter.closeRowSetIterator();    
        }
        
        if(tcc != null){
            listaTcc = new ListaTCC();
            listaTcc.getTCC().addAll(tcc);
        }
        
        if(listaTcc != null &&
           listaTcc.getTCC() != null &&
           listaTcc.getTCC().size() > 0){
            
            // Invocacion a servicio
            try {
                FenixAMImpl fenixAM = (FenixAMImpl)this.getRootApplicationModule();
                String wsdl = null;
                wsdl = fenixAM.getWsdl(IWsdlLocation.MATRIZ);
                
                /*
                MatrizTCC12BndQSService matrizTCC12BndQSService = IWsdlLocation.Service.getInstance(MatrizTCC12BndQSService.class, wsdl);
                MatrizTCCPT matrizTccPT = null;
                matrizTccPT = matrizTCC12BndQSService.getMatrizTCC12BndQSPort();
                
                request = new ActualizarEstadoTCCRequestType();
                request.setListaTCC(listaTcc);
                
                Date horaInicio = ModelUtils.logStartWS(logger, request, "MatrizTCCService");
                ActualizarEstadoTCCResponseType response = null;
                //response = matrizTccPT.actualizarEstadoTCC(request);
                ModelUtils.logEndWS(logger, response, "Response", horaInicio);
                
                if(response.getResultado() != null &&
                   response.getResultado().getResult() != null &&
                   response.getResultado().getResult().value() != null &&
                   response.getResultado().getResult().value().equals("ERROR")){
                    esError = Boolean.TRUE;
                    mensajeError = response.getResultado().getMessage();
                    mensajeError = mensajeError.concat(". ");
                    mensajeError = mensajeError.concat(response.getResultado().getError().getErrorDescription());
                }
                */
            } catch(Exception e){
                logger.severe("Error al actualizar estado de condiciones", e);
                esError = Boolean.TRUE;
            } finally {
                if (esError) {
                    JboException exception = new JboException("Error: " + mensajeError);
                    throw exception;
                }
            }
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(), 
                       "actualizarEstadoCondicion",
                       !esError);
        return !esError;
    }
    
    /**
     * Realiza una actualizacion del detalle de Eventos Condicion por medio del atributo temporal que contiene una 
     * lista de Id de Catalogo de Eventos Condicion, si el detalle existente no se encuentra en la lista son eliminados, 
     * si elementos de la lista no se encuentran en el detalle se crea el nuevo detalle de Evento Condicion
     * @param idModalidad Contiene id de Modalidad
     * @return devuelve valor booleano, true si el proceso es exitoso o false en caso contrario
     */
    @SuppressWarnings("unchecked")
    public boolean actualizaRelacionEventosCondicion(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(), 
                        "actualizaRelacionEventosCondicion");
        
        boolean exito = true;
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        if(am != null){
            
            TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
            if(row != null){
                Array eventosList = row.getIdEventoCondList();
                
                //Elimina registros obsoletos
                RowSetIterator iter = null;
                try{
                    if(new Integer(1).equals(idModalidad)){
                        iter = am.getTreTcaEventoCondicionVO().createRowSetIterator(null);
                    } else {
                        iter = am.getTreTcaEventoCondicionGridVO().createRowSetIterator(null);
                    }
                    if(iter != null){
                        
                        TreTcaEventoCondicionVORowImpl eventoRow = null;
                        
                        iter.reset();
                        while(iter.hasNext()){
                            
                            eventoRow = (TreTcaEventoCondicionVORowImpl) iter.next();
                            if(eventoRow.getIdTcaEvento() != null){
                                
                                boolean exists = false;
                                if(eventosList != null &&
                                   eventosList.getList() != null &&
                                   eventosList.getList().size() > 0){
                                    
                                    for(Number idEvento : (List<Number>) eventosList.getList()){
                                        
                                        Integer intIdEvento = idEvento.intValue();
                                        if(eventoRow.getIdTcaEvento().equals(intIdEvento)){
                                            exists = true;
                                            break;
                                        }
                                    }
                                }
                                
                                
                                if(!exists){
                                    logger.warning("Elimina el Registro Obsoleto de Evento Condicion. Id: " + 
                                                   eventoRow.getId() + 
                                                   " Id TCA Evento: " + 
                                                   eventoRow.getIdTcaEvento());
                                    eventoRow.remove();
                                }
                            }else{
                                logger.warning("Elimina el Registro Obsoleto de Evento Condicion. Id: " + 
                                               eventoRow.getId() + 
                                               " Id TCA Evento: " + 
                                               eventoRow.getIdTcaEvento());
                                eventoRow.remove();
                            }
                        }
                    } 
                }catch(Exception e){
                    logger.severe("Error al actualizar y eliminar los Eventos obsoletos", e);
                    exito = false;
                }finally{
                    if(iter != null){
                        iter.closeRowSetIterator();
                    }
                }
                
                TreTcaEventoCondicionVOImpl eventoCondImpl = null;
                if(new Integer(1).equals(idModalidad)){
                    //Asigna Evento VO Impl cuando es Modalidad Tree
                    eventoCondImpl = am.getTreTcaEventoCondicionVO();
                }else{
                    //Asigna Evento VO Impl cuando es Modalidad Grid
                    eventoCondImpl = am.getTreTcaEventoCondicionGridVO();
                }
                
                //Agrega registros nuevos
                try{
                    iter = eventoCondImpl.createRowSetIterator(null);
                    if(iter != null){
                        
                        if(eventosList != null &&
                           eventosList.getList() != null &&
                           eventosList.getList().size() > 0){
                            
                            TreTcaEventoCondicionVORowImpl eventoRow = null;
                            for(Number idEvento : (List<Number>) eventosList.getList()){
                                
                                boolean notExists = true;
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    eventoRow = (TreTcaEventoCondicionVORowImpl) iter.next();
                                    if(eventoRow.getIdTcaEvento() != null){
                                        if(idEvento.equals(new Number(eventoRow.getIdTcaEvento()))){
                                            notExists = false;
                                            break;
                                        }
                                    }
                                }
                                
                                if(notExists){
                                    logger.warning("Crea el nuevo registro de Evento Condicion");
                                    TreTcaEventoCondicionVORowImpl nuevoRow = 
                                        (TreTcaEventoCondicionVORowImpl) eventoCondImpl.createRow();
                                    
                                    SequenceImpl sqEvento = null;
                                    sqEvento = new SequenceImpl("TRE_TCA_EVENTO_CONDICION_SEQ", getDBTransaction());
                                    nuevoRow.setId(sqEvento.getSequenceNumber().longValue());
                                    
                                    nuevoRow.setIdCondicion(row.getId());
                                    nuevoRow.setIdTcaEvento(idEvento.intValue());
                                    nuevoRow.setNewRowState(Row.STATUS_NEW);
                                    eventoCondImpl.insertRow(nuevoRow);
                                }
                            }
                        }
                    }
                }catch(Exception e){
                    logger.severe("Error al actualizar y crear los Eventos Condicion Nuevos", e);
                    exito = false;
                }finally{
                    if(iter != null){
                        iter.closeRowSetIterator();
                    }
                }
            }else{
                logger.severe("No obtuvo registro actual");
            }
        }else{
            logger.severe("No obtuvo Application Module");
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(), 
                       "actualizaRelacionEventosCondicion",
                       exito);
        return exito;
    }

    /**
     * Realiza una actualizacion del detalle de Categorias Condicion por medio del atributo temporal que contiene una 
     * lista de Id de Catalogo de Categorias Condicion, si el detalle existente no se encuentra en la lista son eliminados, 
     * si elementos de la lista no se encuentran en el detalle se crea el nuevo detalle de Categoria Condicion
     * @param idModalidad Contiene id de Modalidad
     * @return devuelve valor booleano, true si el proceso es exitoso o false en caso contrario
     */
    @SuppressWarnings("unchecked")
    public boolean actualizaRelacionCategoriasCondicion(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(), 
                        "actualizaRelacionCategoriasCondicion");
        
        boolean exito = true;
        FenixAMImpl am = (FenixAMImpl) getApplicationModule();
        if(am != null){
            TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
            if(row != null){
                Array categoriasList = row.getIdCategoriaCondList();
                
                //Elimina registros obsoletos
                RowSetIterator iter = null;
                try{
                    if(new Integer(1).equals(idModalidad)){
                        iter = am.getTreCategoriaCondicionVO().createRowSetIterator(null);
                    } else {
                        iter = am.getTreCategoriaCondicionGridVO().createRowSetIterator(null);
                    }
                    if(iter != null){
                        
                        TreCategoriaCondicionVORowImpl categoriaRow = null;
                        
                        iter.reset();
                        while(iter.hasNext()){
                            
                            categoriaRow = (TreCategoriaCondicionVORowImpl) iter.next();
                            if(categoriaRow.getIdTcaCategoria() != null){
                                
                                boolean exists = false;
                                if(categoriasList != null &&
                                   categoriasList.getList() != null &&
                                   categoriasList.getList().size() > 0){
                                    for(Number idCategoria : (List<Number>)categoriasList.getList()){
                                        
                                        Integer intIdCategoria = idCategoria.intValue();
                                        if(categoriaRow.getIdTcaCategoria().equals(intIdCategoria)){
                                            exists = true;
                                            break;
                                        }
                                    }
                                }
                                
                                if(!exists){
                                    logger.warning("Elimina el Registro Obsoleto de Evento Condicion. Id: " +
                                                   categoriaRow.getId() + 
                                                   " Id TCA Categoria: " + 
                                                   categoriaRow.getIdTcaCategoria());
                                    categoriaRow.remove();
                                }
                            }else{
                                logger.warning("Elimina el Registro Obsoleto de Evento Condicion. Id: " +
                                               categoriaRow.getId() + 
                                               " Id TCA Categoria: " + 
                                               categoriaRow.getIdTcaCategoria());
                                categoriaRow.remove();
                            }
                        }
                    }
                }catch(Exception e){
                    logger.severe("Error al actualizar y eliminar las categorias obsoletas", e);
                    exito = false;
                }finally{
                    if(iter != null){
                        iter.closeRowSetIterator();
                    }
                }
                
                TreCategoriaCondicionVOImpl categoriaCondImpl = null;
                if(new Integer(1).equals(idModalidad)){
                    //Asigna Categoria VO Impl cuando es Modalidad Tree
                    categoriaCondImpl = am.getTreCategoriaCondicionVO();
                }else{
                    //Asigna Categoria VO Impl cuando es Modalidad Grid
                    categoriaCondImpl = am.getTreCategoriaCondicionGridVO();
                }
                
                //Agrega registros nuevos
                try{
                    iter = categoriaCondImpl.createRowSetIterator(null);
                    if(iter != null){
                        
                        if(categoriasList != null &&
                           categoriasList.getList() != null &&
                           categoriasList.getList().size() > 0){
                            TreCategoriaCondicionVORowImpl categoriaRow = null;
                            for(Number idCategoria : (List<Number>)categoriasList.getList()){
                                
                                boolean notExists = true;
                                iter.reset();
                                while(iter.hasNext()){
                                    
                                    categoriaRow = (TreCategoriaCondicionVORowImpl) iter.next();
                                    if(categoriaRow.getIdTcaCategoria() != null){
                                        
                                        if(idCategoria.equals(new Number(categoriaRow.getIdTcaCategoria()))){
                                            notExists = false;
                                            break;
                                        }
                                    }
                                }
                                
                                if(notExists){
                                    logger.warning("Crea el nuevo registro de Categoria Condicion");
                                    TreCategoriaCondicionVORowImpl nuevoRow = 
                                        (TreCategoriaCondicionVORowImpl) categoriaCondImpl.createRow();
                                    
                                    SequenceImpl sqCategoria = null;
                                    sqCategoria = new SequenceImpl("TRE_CATEGORIA_CONDICION_SEQ", getDBTransaction());
                                    nuevoRow.setId(sqCategoria.getSequenceNumber().longValue());
                                    
                                    nuevoRow.setIdCondicion(row.getId());
                                    nuevoRow.setIdTcaCategoria(idCategoria.intValue());
                                    nuevoRow.setNewRowState(Row.STATUS_NEW);
                                    categoriaCondImpl.insertRow(nuevoRow);
                                }
                            }
                        }
                    }
                }catch(Exception e){
                    logger.severe("Error al actualizar y crear las Categorias Condicion Nuevas", e);
                    exito = false;
                }finally{
                    if(iter != null){
                        iter.closeRowSetIterator();
                    }
                }
            }else{
                logger.severe("No obtuvo registro actual");
            }
        }else{
            logger.severe("No obtuvo Application Module");
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(), 
                       "actualizaRelacionCategoriasCondicion",
                       exito);
        return exito;
    }
    
    /**
     * Busca del detalle de Observacion Condicion y obtiene el registro de Observacion Condicion Principal
     * @return devuelve el registro de Observacion Condicion Principal
     */
    public TccObservacionCondicionVORowImpl obtenerObservacionPrincipal(){
        
        logger.entering(TccCondicionVOImpl.class.getName(),
                        "obtenerObservacionPrincipal");
        
        TccObservacionCondicionVORowImpl rowObservacionPrincipal = null;
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        if(row != null){
            
            RowIterator iter = row.getTccObservacionCondicionVO();
            if(iter != null){
                logger.warning("Cantidad de registros de observacion condicion: " + iter.getRowCount());
                
                iter.reset();
                if(iter.getRowCount() > 0){
                    rowObservacionPrincipal = (TccObservacionCondicionVORowImpl) iter.first();
                    for(int index = 0; index < iter.getRowCount(); index++){
                        
                        if(rowObservacionPrincipal != null){
                            if(TccObservacionCondicionVOImpl.ID_ES_PRINCIPAL.equals(rowObservacionPrincipal.getEsPrincipal())){
                                break;
                            }
                        }
                        rowObservacionPrincipal = (TccObservacionCondicionVORowImpl) iter.next();
                    }
                }else{
                    logger.warning("No tiene observaciones de condicion");
                }
                
                if(rowObservacionPrincipal != null){
                    logger.warning("Se encontro observacion condicion principal");
                }else{
                    logger.warning("No se encontro observacion condicion principal");
                }
            }else{
                logger.warning("No se encontro iterator de Observacion Condicion");    
            }
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(),
                       "obtenerObservacionPrincipal",
                       rowObservacionPrincipal);
        return rowObservacionPrincipal;
    }
    
    /**
     * Actualiza o crea el registro de Observacion Condicion Principal
     * @param idModalidad Contiene id de Modalidad
     * @return devuelve valor booleano, true si el proceso es exitoso o false en caso contrario
     */
    public boolean actualizarObservacionPrincipal(Integer idModalidad){
        
        logger.entering(TccCondicionVOImpl.class.getName(), 
                        "actualizarObservacionPrincipal");
        
        boolean exito = false;
        
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        if(row != null){
            
            String observacion = null;
            if(null != row.getDescObservacionPrincipal()){
                observacion = row.getDescObservacionPrincipal();
            }
            
            logger.warning("Verifica Observacion Principal: " + observacion);
                
            FenixAMImpl am = (FenixAMImpl) getApplicationModule();
            TccObservacionCondicionVORowImpl rowObservacion = null;
                
            TccObservacionCondicionVOImpl observacionImpl = null;
            if(idModalidad != null){
                if(new Integer(1).equals(idModalidad)){
                    //Asigna Observacion VO Impl cuando es Modalidad Tree
                    observacionImpl = am.getTccObservacionCondicionVO();
                }else{
                    //Asigna Observacion VO Impl cuando es Modalidad Grid
                    observacionImpl = am.getTccObservacionCondicionGridVO();
                }
            }
                
            TccTcaProcesoTareaBpmVORowImpl rowProBpm = 
                (TccTcaProcesoTareaBpmVORowImpl) am.getTccTcaProcesoTareaBpmVO().getCurrentRow();
            logger.warning("Verifica Registro de Proceso BPM actual");
            if(rowProBpm != null){
                if(rowProBpm.getTareaId() != null){
                        
                    rowObservacion = obtenerObservacionPrincipal();
                    if(rowObservacion != null){
                            
                        logger.warning("Realiza la busqueda del Registro de Observacion Condicion Principal");
                        observacionImpl.buscarPrincipal();
                        logger.warning("Cantidad encontrada de Registros de Observacion Condicion Principal: " +
                                        am.getTccObservacionCondicionVO().getEstimatedRowCount());
                        if(observacionImpl.getEstimatedRowCount() > 0){
                                
                            TccObservacionCondicionVORowImpl rowObservacionTmp = null;
                            rowObservacionTmp = 
                                (TccObservacionCondicionVORowImpl) observacionImpl.getCurrentRow();
                            if(rowObservacionTmp.getId() != null){
                                logger.warning("Verifica Id de Registros de Observacion Principal a Modificar");
                                logger.warning("Id Row 1: " + rowObservacionTmp.getId());
                                logger.warning("Id Row 2: " + rowObservacion.getId());
                                if(rowObservacionTmp.getId().equals(rowObservacion.getId())){
                                        
                                    //Actualiza Row existente
                                    logger.warning("Ejecuta la actualizacion de Registro actual de Observacion Condicion");
                                        
                                    exito = observacionImpl.actualizarRegistro(observacion, 
                                                                                rowProBpm.getTareaId());
                                }else{
                                    logger.severe("Los registros de Condicion Observacion Principal no coinciden");
                                }
                            }
                        }else{
                            logger.severe("No se encontraron registros de Observacion Condicion Principal");
                        }
                    }else{
                        if(null != observacion){    
                            //Crea nuevo row
                            logger.warning("Ejecuta la creacion de Registro de Observacion Condicion");
                            exito = observacionImpl.crearRegistro(observacion,
                                                                    row.getId().longValue(),
                                                                    rowProBpm.getTareaId(),
                                                                    true);
                        } else {
                            logger.warning("Observaciones son NULL, no hay registros que crear.");
                            exito = true;
                        }
                    }
                }else{
                    logger.severe("Error no se pudo obtener el Id de Tarea en el registro de Proceso BPM actual");
                }
            }else{
                logger.severe("Error no se pudo obtener Registro del Proceso BPM actual");
            }
        }
        
        logger.exiting(TccCondicionVOImpl.class.getName(), 
                       "actualizarObservacionPrincipal",
                       exito);
        return exito;
    }
    
    /**
     * Crea nuevo registro, inicializa su estado e inserta al Modelo
     */
    public void crearInsertar(){
        
        TccCondicionVORowImpl nuevoRow = (TccCondicionVORowImpl) createRow();
        nuevoRow.setId(new Long(-1));
        nuevoRow.setNewRowState(Row.STATUS_INITIALIZED);
        insertRow(nuevoRow);
    }
    
    public Long crearCondicionEnmendada(Number idTcc, Integer idTcaEstadoTcc, Integer idTcaSubEstadoTcc) {
        logger.log(ADFLogger.TRACE, "Inside crearCondicionEnmendada.");

        // Creamos una nueva Condicin Enmendada en base al idTcc enviado (debe ser un clon de l)
        oracle.jbo.domain.Number idCondicion = null;
        NameValuePairs nvpCondicion = null;
        SequenceImpl seqCondicion = null;
        Row rowPadre = null;
        Row rowEnmendado = null;
        
        // Obtenemos row padre
        rowPadre = this.getRow(new Key(new Object[]{idTcc.longValue()}));
        
        // Asignamos todos los atributos del row padre al row enmendado 
        // (excepto BanEstatus, FechaRegistro, Id, IdTcaEstadoTcc, IdTcaSubEstadoTcc y IdCondicionEnmendada)
        if(rowPadre != null) {
            
            seqCondicion = new SequenceImpl("CONDICION_SEQ", getDBTransaction());
            idCondicion = seqCondicion.getSequenceNumber();
            nvpCondicion = new NameValuePairs();
            
            for(String nombreAtributo : rowPadre.getAttributeNames()) {
                // Clonamos row
                nvpCondicion.setAttribute(nombreAtributo, rowPadre.getAttribute(nombreAtributo));
            }
            
            // Sobreescribimos atributos diferentes, especficos al enmendado
            nvpCondicion.setAttribute("BanEstatus", BANESTATUS_FALSE);
            nvpCondicion.setAttribute("FechaRegistro", new java.sql.Timestamp(System.currentTimeMillis()));
            nvpCondicion.setAttribute("Id", idCondicion);
            
            if(idTcaEstadoTcc != null) // Si el estado es null, le dejamos el mismo que el del padre
                nvpCondicion.setAttribute("IdTcaEstadoTcc", idTcaEstadoTcc);
            
            nvpCondicion.setAttribute("IdTcaSubEstadoTcc", idTcaSubEstadoTcc);
            nvpCondicion.setAttribute("IdCondicionEnmendada", idTcc);

            Long idPadreCondicion=idTcc.longValue();
            FenixAMImpl am = (FenixAMImpl) getApplicationModule();
            
            rowEnmendado = this.createAndInitRow(nvpCondicion);             
              
            //Agregar Eventos
            //am.getTreeCategoriaEnmiendaVO().crearEnmendadasCategoria(idPadreCondicion, idCondicion.longValue());
            //Agregar Categorias
            //am.getTreeTcaEventoEnmienda().crearEnmendadaEvento(idPadreCondicion, idCondicion.longValue());
                        
            getDBTransaction().commit();    
            
            // Re-ejecutamos el query debido a que se cre un nuevo registro
            this.executeQuery();
        }
        
        // Regresamos el id de la Condicin Enmendada
        if(rowEnmendado != null)
            return (Long)rowEnmendado.getAttribute("Id");
        else
            return null;
    }
    
    public Long crearCondicion(Long idOperacion, String nombreCondicion, Integer idTcaCondicion, Integer idTcaEstadoTcc, 
                               Integer idTcaSubEstadoTcc, Integer banEstatus) {
        logger.warning("Inside crearCondicion.");
        oracle.jbo.domain.Number idCondicion = null;
        NameValuePairs nvpCondicion = null;
        SequenceImpl seqCondicion = null;
        Row rowNuevo = null;
                
        // Asignacin de variables      
        seqCondicion = new SequenceImpl("CONDICION_SEQ", getDBTransaction());
        idCondicion = seqCondicion.getSequenceNumber();
        nvpCondicion = new NameValuePairs();
                
        logger.warning("id de la condicion a insertar: "+idCondicion);
        
        // Creamos un nuevo Termino en base a los parmetros enviados
        nvpCondicion.setAttribute("BanEstatus", banEstatus);
        nvpCondicion.setAttribute("FechaRegistro", new java.sql.Timestamp(System.currentTimeMillis()));
        nvpCondicion.setAttribute("Id", idCondicion);
        nvpCondicion.setAttribute("IdOperacion", idOperacion);
        nvpCondicion.setAttribute("IdTcaEstadoTcc", idTcaEstadoTcc);
        nvpCondicion.setAttribute("IdTcaSubEstadoTcc", idTcaSubEstadoTcc);
        nvpCondicion.setAttribute("IdTcaCondicion", idTcaCondicion);
        nvpCondicion.setAttribute("Nombre", nombreCondicion);

        rowNuevo = this.createAndInitRow(nvpCondicion);        
        getDBTransaction().commit();        
        
        // Re-ejecutamos el query debido a que se cre un nuevo registro
        this.executeQuery();
        
        // Regresamos el id del nuevo Trmino
        if(rowNuevo != null)
            return Long.valueOf(rowNuevo.getAttribute("Id").toString());
        else
            return null;
    }
    
    @SuppressWarnings("unchecked")
    public void mappearCondicionRequestType(ActualizarTCCRequestType request, Accion accion){
        logger.warning("Entra a metodo mappearCondicionRequestType");
        TccCondicionVORowImpl row = (TccCondicionVORowImpl) getCurrentRow();
        Condicion condicion = new Condicion();
        
        request.setTipo(Tipo.CONDICION);
        if(null != accion)
            condicion.setAccion(accion);
        
        if(null != row){
            try{
            logger.warning("Mapeando atributos del Row a atributos del objeto Condicion");
            FenixAMImpl am = (FenixAMImpl) getApplicationModule();
            if(null != row.getId()){
                condicion.setIdCondicion(row.getId());
                //Buscar FuenteCondicion y LineaCreditoCondicion en base a Id
                
//                if(null != am){
//                    TccFuenteCondicionLOVImpl fuenteCondicionLOV = am.getTccFuenteCondicionLOV();
//                    fuenteCondicionLOV.buscarPorIdCondicion(row.getId());
//                    Row fuenteRow[] = fuenteCondicionLOV.getAllRowsInRange();
//                    if(null != fuenteRow && fuenteRow.length > 0){
//                        for(Row fuenteCondicionRow : fuenteRow){
//                            logger.warning("Mapeando fuenteCondicion " + fuenteCondicionRow.getAttribute(TccFuenteCondicionLOVRowImpl.FTID).toString());
//                            Long idFuente = new Long(fuenteCondicionRow.getAttribute(TccFuenteCondicionLOVRowImpl.FTID).toString());
//                            condicion.getFuente().add(cargarIdEntidadMinima(idFuente));
//                        }
//                    }
//                    TccLineaCreditoCondicionLOVImpl lineaCreditoLOV = am.getTccLineaCreditoCondicionLOV();
//                    lineaCreditoLOV.buscarLineaCreditoPorIdCondicion(row.getId());
//                    Row lineaRow[] = lineaCreditoLOV.getAllRowsInRange();
//                    if(null != lineaRow && lineaRow.length > 0){
//                        for(Row lineaCreditoRow : lineaRow){
//                            logger.warning("Mapeando lineaCreditoCondicion " + lineaCreditoRow.getAttribute(TccLineaCreditoCondicionLOVRowImpl.LCID).toString());
//                            Long idLinea = new Long(lineaCreditoRow.getAttribute(TccLineaCreditoCondicionLOVRowImpl.LCID).toString());
//                            condicion.getLineaCredito().add(cargarIdEntidadMinima(idLinea));
//                        }
//                    }
//                }
            }
            
            if(null != row.getIdOperacion())
                condicion.setOperacion(row.getIdOperacion());
            
            if(null != row.getNombre() && !row.getNombre().equals(""))
                condicion.setNombre(row.getNombre());
            
            if(null != row.getDescripcion() && !row.getDescripcion().equals(""))
                condicion.setDescripcion(row.getDescripcion());
            
            if(null != row.getBanEstatus()){
                if(row.getBanEstatus() == 1){
                    condicion.setEstado(Boolean.TRUE);
                }else{
                    condicion.setEstado(Boolean.FALSE);
                }
            }
            
            if(null != row.getIdTcaCondicion()){
                CatalogoCondicion catalogoCondicion = new CatalogoCondicion();
                catalogoCondicion.setIdCatCondicion(row.getIdTcaCondicion().longValue());
                condicion.setTipoCondicion(catalogoCondicion);
            }
            
            if(null != row.getIdTcaControlCondicion())
                condicion.setControlCondicion(cargarIdCatalogo(row.getIdTcaControlCondicion().longValue()));
                        
            if(null != row.getIdTcaTipoFechaInicio())
                condicion.setTipoFechaInicio(cargarIdCatalogo(row.getIdTcaTipoFechaInicio().longValue()));
            
            if(null != row.getFechaInicio())
                condicion.setFechaInicio(obtenerFormatoFecha(row.getFechaInicio().getTime()));
            
            if(null != row.getPlazo())
                condicion.setPlazo(row.getPlazo());
            
            if(null != row.getIdTcaFrecuenciaPlazo())
                condicion.setFrecuenciaPlazo(cargarIdCatalogo(row.getIdTcaFrecuenciaPlazo().longValue()));
            
            if(null != row.getFechaFinal())
                condicion.setFechaFinal(obtenerFormatoFecha(row.getFechaFinal().getTime()));
            
            //Mapeo de Estados TCC
            /*
            if(row.getIdTcaEstadoTcc() != null){
                EstadoTCC estado = new EstadoTCC();
                estado.setId(new Long(row.getIdTcaEstadoTcc().toString()));
                condicion.setEstadoTCC(estado);
            }
            
            if(row.getIdTcaSubEstadoTcc() != null){
                EstadoTCC estado = new EstadoTCC();
                estado.setId(new Long(row.getIdTcaSubEstadoTcc().toString()));
                condicion.setSubEstadoTCC(estado);
            }
            */
            
            if(null != am.getTreCategoriaCondicionVO()){
                logger.warning("Entra a mapeo de categorias");
                RowSetIterator iter = am.getTreCategoriaCondicionVO().createRowSetIterator(null);
                if(null != iter){
                    iter.reset();
                    TreCategoriaCondicionVORowImpl categoriaRow = null;
                    while(iter.hasNext()){
                        logger.warning("Entra a While categorias");
                        categoriaRow = (TreCategoriaCondicionVORowImpl) iter.next();
                        if(null != categoriaRow.getId()){
                            logger.warning("IdCategora: " + categoriaRow.getId());
                            CategoriaCondicion catCondicion = new CategoriaCondicion();
                            catCondicion.setId(categoriaRow.getId());
                            condicion.getCategoriaCondicion().add(catCondicion);
                        }
                    }
                    iter.closeRowSetIterator();
                }
            }
            
            if(null != am.getTreTcaEventoCondicionVO()){
                logger.warning("Entra a mapeo de evento");
                RowSetIterator iter = am.getTreTcaEventoCondicionVO().createRowSetIterator(null);
                if(null != iter){
                    iter.reset();
                    TreTcaEventoCondicionVORowImpl eventoRow = null;
                    while(iter.hasNext()){
                        logger.warning("Entra a While eventos");
                        eventoRow = (TreTcaEventoCondicionVORowImpl) iter.next();
                        if(null != eventoRow.getId()){
                            logger.warning("IdEvento: " + eventoRow.getId());
                            condicion.getEventoCondicion().add(cargarIdCatalogo(eventoRow.getId()));
                        }
                    }
                    iter.closeRowSetIterator();
                }
            }
            
            TccObservacionCondicionVORowImpl rowObservacion = obtenerObservacionPrincipal();
            if(null != rowObservacion){                
                ObservacionCondicion observacionCondicion = new ObservacionCondicion();
                observacionCondicion.setId(rowObservacion.getId());
                condicion.getObservaciones().add(observacionCondicion);
            }
            } catch (DatatypeConfigurationException e) {
                logger.warning("Error en el mapeo de los atributos de Condicion");
            }
        }
        request.getCondicion().add(condicion);
        logger.warning("Finaliza metodo mappearCondicionRequestType");
    }
    
    private Catalogo cargarIdCatalogo(Long id){
        logger.warning("Entra a metodo cargarIdCatalogo");
        Catalogo catalogo = new Catalogo();
        catalogo.setId(id);
        logger.warning("Termina metodo cargarIdCatalogo");
        return catalogo;
    }
    
    private XMLGregorianCalendar obtenerFormatoFecha(Long fecha) throws DatatypeConfigurationException {
        Date date = new Date(fecha);
        SimpleDateFormat simpleDateFormat = new SimpleDateFormat("yyyy-MM-dd");
        String stringDate = simpleDateFormat.format(date);
        logger.warning("La fecha con formato es: " + stringDate);
        return DatatypeFactory.newInstance().newXMLGregorianCalendar(stringDate);
    }
    
    private EntidadMinima cargarIdEntidadMinima(Long id){
        logger.warning("Entra a metodo cargarIdEntidadMinima");
        EntidadMinima entidadMinima = new EntidadMinima();
        entidadMinima.setId(id);
        logger.warning("Termina metodo cargarIdEntidadMinima");
        return entidadMinima;
    }
    
    /**
     * Mtodo genrico para eliminar el current row de la VO.
     * Si falla la eliminacin, hace rollback y regresa el current row al elemento que no pudo ser eliminado.
     * 
     * @author Francisco Cuevas Pineda 
     * @since 23/junio/2016
     */
    public void eliminarCondicionActual() {
        logger.log(ADFLogger.WARNING, "Inside eliminarCondicionActual.");
        boolean esError = false;
        Long idCurrentRow = null;
        Row currentRow = null;
        
        try {
            currentRow = this.getCurrentRow();
            if(currentRow != null) {
                idCurrentRow = (Long)currentRow.getAttribute("Id");
                currentRow.remove();
                this.getDBTransaction().commit();
            }
        }
        catch(Exception ex){
            logger.log(ADFLogger.ERROR, "Error al eliminar la Condicin actual: " + ex.getMessage());
            this.getDBTransaction().rollback();
            esError = true;
            
            throw new JboException(ex); // Mandamos excepcin a pantalla
        }
        finally{
            if(esError) {
                // Regresa el current row al elemento que no pudo ser eliminado
                setCurrentRow(getRow(new Key(new Object[]{idCurrentRow}))); 
            }
        }
    }
    
    public void actualizarSubEstado(Long idCondicion) {
        logger.warning("Into actualizarSubEstado.");
        logger.warning("value idPrepago : " + idCondicion);

        Row condicionRow = null;
        condicionRow = this.getRow(new Key(new Object[] { idCondicion }));

        if (condicionRow != null) {

            condicionRow.setAttribute(TccCondicionVORowImpl.IDTCASUBESTADOTCC, null);
            getDBTransaction().commit();
        } else {
            logger.log(ADFLogger.WARNING, "No record found in TccCondicionVO with idCondicion : " + idCondicion);
        }
    }
    
    public void setIdEvento(Number idEvento){
        logger.warning("Dentro de setIdEvento");
        logger.warning("idEvento :"+idEvento);
        Row row = this.getCurrentRow();
        row.setAttribute("IdEvento", idEvento);
        logger.warning("Fuera de setIdEvento");
    }
}

