package org.bcie.fenix.common.model.am;

import com.bcie.xmlns.usuarioservice.Usuario12BndQSService;
import com.bcie.xmlns.usuarioservice.UsuarioPT;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Objects;

import oracle.adf.share.logging.ADFLogger;
import oracle.jbo.JboException;
import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.server.ApplicationModuleImpl;
import oracle.jbo.server.ViewObjectImpl;
import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.am.common.FenixGestorOperacionesAM;
import org.bcie.fenix.common.model.utils.IWsdlLocation;
import org.bcie.fenix.common.model.utils.ModelUtils;
import org.bcie.fenix.common.model.vo.ConfiguracionVOImpl;
import org.bcie.fenix.common.model.vo.TcaAppExternaVOImpl;
import org.bcie.fenix.common.model.vo.TcaAppExternaVORowImpl;
import org.bcie.fenix.common.model.vo.TcaParametrosAppVOImpl;
import org.bcie.fenix.common.model.vo.TcaParametrosAppVORowImpl;
import org.bcie.fenix.common.model.vo.common.TcaAppExternaVO;
import org.bcie.fenix.common.model.vo.common.TcaParametrosAppVO;
import org.bcie.fenix.common.model.vo.gestoroperaciones.ReasignarResponsableOperacionVOImpl;
import org.bcie.usuariobo.ListaNombres;
import org.bcie.usuariobo.ListaUsuarios;
import org.bcie.usuariobo.Usuario;
import org.bcie.usuariomo.ConsultarAtributosUsuarioRequestType;
import org.bcie.usuariomo.ConsultarAtributosUsuarioResponseType;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Thu Jul 13 18:00:15 CDT 2017
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class FenixGestorOperacionesAMImpl extends ApplicationModuleImpl implements FenixGestorOperacionesAM {

    private static ADFLogger logger = null;

    /**
     * This is the default constructor (do not remove).
     */
    public FenixGestorOperacionesAMImpl() {
        if (logger == null) {
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }

    public void testObtenerUrlParametrizada() {
        obtenerUrlParametrizada(3, 500010L, "302");
    }
    
    public void testObtenerTodasLasLlavesParametros() {
        obtenerTodasLasLlavesParametros();
    }
    
    public String obtenerUrlParametrizada(int idTcaAppExterna, Long idOperacion, String idCliente) {
        logger.log(ADFLogger.WARNING, "Entrando en obtenerUrlParametrizada.");
        logger.log(ADFLogger.WARNING, "idTcaAppExterna: " + idTcaAppExterna);
        logger.log(ADFLogger.WARNING, "idOperacion: " + idOperacion);
        logger.log(ADFLogger.WARNING, "idCliente: " + idCliente);

        String urlAppExterna = "";
        
        String url = obtenerUrlAppExterna(idTcaAppExterna);
        
        List<String> listaParametros = obtenerLlavesParametros(url);
        
        for(String llave: listaParametros) {
            logger.warning("llave: " + llave);
            Row rowParametro = obtenerRowParametroAppExterna(llave);
            
            String valor = obtenerParametroAppExterna(rowParametro, idOperacion, idCliente);
            url = url.replace(llave, valor);
        }

        logger.log(ADFLogger.WARNING, "url: " + url);
        urlAppExterna = url;
        
        return urlAppExterna;
    }
    
    private List<String> obtenerLlavesParametros(String url) {
        logger.warning("Entrando en obtenerLlavesParametros.");
        logger.warning("url: " + url);
        List<String> listaFiltada = new ArrayList<>();
        
        if (null != url) {
            List<String> listaLlaves = obtenerTodasLasLlavesParametros();
            
            for(String llave :  listaLlaves) {
                
                if (null != url && url.contains(llave)) {
                    listaFiltada.add(llave);
                }
            }
        } else {
            logger.warning("URL nula.");
        }
        
         
        return listaFiltada;
    }
    
    private List<String> obtenerTodasLasLlavesParametros() {
        List<String> lista = new ArrayList<>();

        TcaParametrosAppVO tcaParametrosAppVO = getTcaParametrosAppVO();

        tcaParametrosAppVO.setpBanEstatus(FenixModelConstants.BANESTATUS_TRUE);
        tcaParametrosAppVO.executeQuery();
        RowSetIterator rowSetIterator = tcaParametrosAppVO.createRowSetIterator(null);

        rowSetIterator.reset();

        while (rowSetIterator.hasNext()) {
            Row row = rowSetIterator.next();

            if (null != row) {
                logger.warning("Llaves -> " + row.getAttribute("Llave"));
                lista.add((String) row.getAttribute("Llave"));
            }
        }
        
        rowSetIterator.closeRowSetIterator();
        
        return lista;
    }

    private Row obtenerRowParametroAppExterna(String llave) {
        logger.log(ADFLogger.WARNING, "Entrando en obtenerIteradorParametrosAppExterna.");

        Row row = null;
        TcaParametrosAppVO tcaParametrosAppVO = getTcaParametrosAppVO();
        ViewCriteria asociadasVOCriteria =
            tcaParametrosAppVO.getViewCriteriaManager().getViewCriteria("BuscarTcaParametrosAppVOPorLlaveCriteria");
        asociadasVOCriteria.ensureVariableManager().setVariableValue("pLlave", llave);
        tcaParametrosAppVO.setpBanEstatus(FenixModelConstants.BANESTATUS_TRUE);
        tcaParametrosAppVO.applyViewCriteria(asociadasVOCriteria);
        tcaParametrosAppVO.executeQuery();

        if (tcaParametrosAppVO.getEstimatedRowCount() > 0) {
            row = tcaParametrosAppVO.first();
        }

        tcaParametrosAppVO.getViewCriteriaManager().removeApplyViewCriteriaName("BuscarTcaParametrosAppVOPorLlaveCriteria");

        return row;
    }

    private String obtenerParametroAppExterna(Row row, Long idOperacion, String idCliente) {
        logger.log(ADFLogger.WARNING, "Entrando en obtenerParametroAppExterna.");

        String valorParametro = "";
        if (null != row.getAttribute(TcaParametrosAppVORowImpl.SQLQUERY)) {
            String nombreParametro = (String) row.getAttribute(TcaParametrosAppVORowImpl.LLAVE);
            String query = (String) row.getAttribute(TcaParametrosAppVORowImpl.SQLQUERY);

            //logger.log(ADFLogger.WARNING, "nombreParametro: " + nombreParametro);

            switch (nombreParametro) {
            case FenixModelConstants.APP_EXTERNA_LLAVE_ID_CLIENTE:
                if (null != idCliente) {
                    query = query.replace(FenixModelConstants.APP_EXTERNA_LLAVE_ID_PARAMETRO, idCliente);
                    valorParametro = ejecutarConsultaParamAppExterna(query);
                }
                break;
            case FenixModelConstants.APP_EXTERNA_LLAVE_ID_OPERACION:
                if (null != idOperacion) {
                    query = query.replace(FenixModelConstants.APP_EXTERNA_LLAVE_ID_PARAMETRO, idOperacion.toString());
                    valorParametro = ejecutarConsultaParamAppExterna(query);
                }
                break;
            case FenixModelConstants.APP_EXTERNA_LLAVE_CONSTANTE:
                valorParametro = query;
                break;
            default:
                logger.log(ADFLogger.WARNING, "Tipo de parametro recibido no se reconoce.");
                break;
            }
        }

        return valorParametro;
    }

    private String ejecutarConsultaParamAppExterna(String query) {
        logger.log(ADFLogger.WARNING, "Entrando en ejecutarConsultaParamAppExterna.");
        logger.log(ADFLogger.WARNING, "query: " + query);

        String resultado = "";

        try {
            PreparedStatement preparedStatement = getDBTransaction().createPreparedStatement(query, 0);
            ResultSet rs = preparedStatement.executeQuery();

            if (rs.next()) {
                resultado = rs.getString(1);
            }
        } catch (Exception e) {
            logger.log(ADFLogger.WARNING, "Error al consultar el valor para el parametro de AppExternas.", e);
        }

        logger.log(ADFLogger.WARNING, "resultado: " + resultado);
        return resultado;
    }
    
    private String obtenerUrlAppExterna(int idTcaAppExterna) {
        String descripcion = "";

        // Utilizamos un instancia diferente a la que muestra
        // la lista de aplicaciones en gestor de operaciones
        TcaAppExternaVO tcaAppExternaVO = getTcaAppExternaUnicaVO();

        ViewCriteria criteria =
            tcaAppExternaVO.getViewCriteriaManager().getViewCriteria("TcaAppExternaVOCriteriaPorId");
        criteria.ensureVariableManager().setVariableValue("pIdTcaAppExterna", idTcaAppExterna);
        tcaAppExternaVO.applyViewCriteria(criteria);
        tcaAppExternaVO.executeQuery();

        if (tcaAppExternaVO.getRowCount() > 0) {
            Row row = tcaAppExternaVO.first();
            descripcion = (String) row.getAttribute(TcaAppExternaVORowImpl.DESCRIPCION);
        }

        return descripcion;
    }

    @SuppressWarnings("unused")
    private String obtenerDescripcionUrlAppExterna(int idTcaAppExterna) {
        String descripcion = "";

        // Utilizamos un instancia diferente a la que muestra
        // la lista de aplicaciones en gestor de operaciones
        TcaAppExternaVO tcaAppExternaVO = getTcaAppExternaUnicaVO();

        ViewCriteria criteria =
            tcaAppExternaVO.getViewCriteriaManager().getViewCriteria("TcaAppExternaVOCriteriaPorId");
        criteria.ensureVariableManager().setVariableValue("pIdTcaAppExterna", idTcaAppExterna);
        tcaAppExternaVO.applyViewCriteria(criteria);
        tcaAppExternaVO.executeQuery();

        if (tcaAppExternaVO.getRowCount() > 0) {
            Row row = tcaAppExternaVO.first();
            descripcion = (String) row.getAttribute(TcaAppExternaVORowImpl.DESCRIPCIONCORTA);
        }

        return descripcion;
    }
    
    public List<String> obtenerGerentePais(String pUsuario) {
        logger.warning("Entrando en obtenerGerentePais" + pUsuario);
        
        UsuarioPT usuarioPT = UsuarioPT();
        ConsultarAtributosUsuarioRequestType request = ConsultarAtributosUsuarioRequest(pUsuario);
        ConsultarAtributosUsuarioResponseType response = new ConsultarAtributosUsuarioResponseType();
        
        try {
            Date horaInicio = ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_CONSULTAR_GERENTE_PAIS);
            response = usuarioPT.consultarAtributosUsuario(request);
            ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_CONSULTAR_GERENTE_PAIS, horaInicio);
        } catch (Exception e) {
            logger.log(ADFLogger.ERROR, "Error al obtener el gerente de pais", e);
            JboException ex = new JboException(e);
            ex.addToExceptions(new Exception("Error al obtener lo atributos del usuario. Intentelo más tarde."));
            throw ex;
        }
        
        return mapeoGerentePaisResponse(response);
    }
    
    private ConsultarAtributosUsuarioRequestType ConsultarAtributosUsuarioRequest(String usuario) {
        ConsultarAtributosUsuarioRequestType request = new ConsultarAtributosUsuarioRequestType();

        if (usuario == null) {
            usuario = this.getUserPrincipalName();
        }
        
        ListaNombres listaNombres = new ListaNombres();
        listaNombres.getNombreUsuario().add(usuario);
        request.setListaNombres(listaNombres);
        
        return request;
    }
    
    private UsuarioPT UsuarioPT() {
        String wsdl = getWsdl(IWsdlLocation.USUARIO);
        
        Usuario12BndQSService usuario12BndQSService =
            IWsdlLocation.Service.getInstance(Usuario12BndQSService.class, wsdl);
        UsuarioPT usuarioPT = usuario12BndQSService.getUsuario12BndQSPort();
        
        return usuarioPT;
    }
    
    private List<String> mapeoGerentePaisResponse(ConsultarAtributosUsuarioResponseType response) {
        ListaUsuarios usuarios = new ListaUsuarios();
        List<String> listaGerentesPais = new ArrayList<>();

        if (response.getResultado().getResult().value().equalsIgnoreCase("OK")) {
            usuarios = response.getListaUsuarios();
            for (Usuario usuario : usuarios.getUsuario()) {
                if (usuario.getManager() != null) {
                    listaGerentesPais.add(usuario.getManager());    
                    logger.warning("manager: " + usuario.getManager());
                }
            }
        }
        
        return listaGerentesPais;
    }
    
    public String getWsdl(String key) {
        ConfiguracionVOImpl vo = this.getConfiguracionVO();
        Row row = vo.getValor(key);
        String wsdl = row == null ? null : (String) row.getAttribute("Valor");
        return wsdl;
    }

    /**
     * Container's getter for TcaAppExternaVO.
     * @return TcaAppExternaVO
     */
    public TcaAppExternaVOImpl getTcaAppExternaVO() {
        return (TcaAppExternaVOImpl) findViewObject("TcaAppExternaVO");
    }

    /**
     * Container's getter for TcaParametrosAppVO.
     * @return TcaParametrosAppVO
     */
    public TcaParametrosAppVOImpl getTcaParametrosAppVO() {
        return (TcaParametrosAppVOImpl) findViewObject("TcaParametrosAppVO");
    }

    /**
     * Container's getter for TcaAppExternaVO.
     * @return TcaAppExternaVO
     */
    public TcaAppExternaVOImpl getTcaAppExternaUnicaVO() {
        return (TcaAppExternaVOImpl) findViewObject("TcaAppExternaUnicaVO");
    }

    /**
     * Container's getter for ConfiguracionVO.
     * @return ConfiguracionVO
     */
    public ConfiguracionVOImpl getConfiguracionVO() {
        return (ConfiguracionVOImpl) findViewObject("ConfiguracionVO");
    }


    /**
     * Container's getter for CatPaisesVO1.
     * @return CatPaisesVO1
     */
    public ViewObjectImpl getCatPaisesVO() {
        return (ViewObjectImpl) findViewObject("CatPaisesVO");
    }


    /**
     * Container's getter for ReasignarResponsableOperacionVO1.
     * @return ReasignarResponsableOperacionVO1
     */
    public ReasignarResponsableOperacionVOImpl getReasignarResponsableOperacionVO() {
        return (ReasignarResponsableOperacionVOImpl) findViewObject("ReasignarResponsableOperacionVO");
    }

    /**
     * Container's getter for EnmiendasXFormalizarVO1.
     * @return EnmiendasXFormalizarVO1
     */
    public ViewObjectImpl getEnmiendasXFormalizarVO() {
        return (ViewObjectImpl) findViewObject("EnmiendasXFormalizarVO");
    }


    /**
     * Retorna las enmiendas de la operación pasada como param que requieren formalización.
     *
     * @param idOperacion Operación de la cual se desea conocer sus enmiendas que requieren formalización.
     * @return Listado con los idEnmienda de cada enmienda de la operación que requiera formaliación.
     */
    public List<Long> obtenerEnmiendasXFormalizar(Long idOperacion){
        Objects.requireNonNull(idOperacion, "Param idOperacion no puede ser nulo.");
        
        ViewObjectImpl vo = getEnmiendasXFormalizarVO();
        vo.setNamedWhereClauseParam("pIdOperacion", idOperacion);
        vo.executeQuery();

        List<Long> resultado = new ArrayList<>();
        RowSetIterator rsi = null;
        try{
            
            rsi = vo.createRowSetIterator(null);
            while(rsi.hasNext()){
                Row row = rsi.next();
                resultado.add((Long)row.getAttribute("IdEnmienda"));
            }
            
        } finally{
            if (rsi != null){
                rsi.closeRowSetIterator();
            }
        }
        
        return resultado;        
    }
}

