package org.bcie.fenix.common.model.vo;

import java.sql.ResultSet;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;

import java.util.ResourceBundle;

import oracle.adf.share.logging.ADFLogger;

import oracle.javatools.resourcebundle.BundleFactory;

import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.domain.Number;
import oracle.jbo.server.ViewObjectImpl;
import oracle.jbo.server.ViewRowImpl;
import oracle.jbo.server.ViewRowSetImpl;

import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.vo.common.GrupoRolAprobacionVO;
import org.bcie.solicitudaprobacionbo.MiembroReunion;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Fri Nov 27 19:59:07 CST 2015
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class GrupoRolAprobacionVOImpl extends ViewObjectImpl implements GrupoRolAprobacionVO {
    
    /**
     * Define classpath y Resource Bundle
     */
    public static final String BUNDLE = "org.bcie.fenix.common.model.FenixModelBundle";
    
    /**
     * Define la clave de Bundle para obtener informacion de los Id o Descripcion corta de los roles que no votan
     */
    public static final String ROL_VOTO_DENEGADO_BKEY = "org.bcie.fenix.common.model.rol.voto.denegado";
    
    public static final String NOMBRE_USUARIO_OTRO = "Otro";
    public static final String NOMBRE_USUARIO_EXCUSADO = "Excusado";
    
    /**
     * Lista de registros de la VO programatica
     */
    private List<GrupoRolAprobacionVORowImpl> rows = null;

    /**
     * This is the default constructor (do not remove).
     */
    private static ADFLogger logger = null;
    public GrupoRolAprobacionVOImpl() {
        super();
        if(null == logger){
            logger = ADFLogger.createADFLogger(this.getClass());
        }
        rows = new ArrayList<GrupoRolAprobacionVORowImpl>();
    }
    
    /**
     * create - overridden for custom java data source support.
     */
    @Override
    protected void create() {
        super.create();
        getViewDef().setQuery(null);
        getViewDef().setSelectClause(null);
        setQuery(null);
    }

    /**
     * executeQueryForCollection - overridden for custom java data source support.
     */
    @Override
    protected void executeQueryForCollection(Object qc, Object[] params, int noUserParams) {
        
        if(rows.size() > 0){
            setFetchPosition(qc, 0);
        }
        super.executeQueryForCollection(qc, params, noUserParams);
    }

    /**
     * hasNextForCollection - overridden for custom java data source support.
     */
    @Override
    protected boolean hasNextForCollection(Object qc) {
        //boolean bRet = super.hasNextForCollection(qc);
        
        boolean bRet = false;
        if(rows.size() > 0){
            bRet = getFetchPosition(qc) < rows.size();
        }else{
            bRet = super.hasNextForCollection(qc);
        }
        
        return bRet;
    }

    /**
     * createRowFromResultSet - overridden for custom java data source support.
     */
    @Override
    protected ViewRowImpl createRowFromResultSet(Object qc, ResultSet resultSet) {
        //ViewRowImpl value = super.createRowFromResultSet(qc, resultSet);
        
        ViewRowImpl value = null;
        GrupoRolAprobacionVORowImpl row = null;
        
        if(rows.size() > 0){
            
            //Obtiene la posicion actual del current Row
            int fetchPosition = getFetchPosition(qc);
            
            //Crea un nuevo registro de VO
            value = createNewRowForCollection(qc);

            //Obtiene elemento de la colleccion de datos externa
            row = rows.get(fetchPosition);
            
            //Asigna el registro externo al registro de la VO
            value = row;
            
            //Actualiza la posicion del current Row
            setFetchPosition(qc, fetchPosition + 1);
        }else{
            value = super.createRowFromResultSet(qc, resultSet);
        }
        
        return value;
    }

    /**
     * getQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getQueryHitCount(ViewRowSetImpl viewRowSet) {
        //long value = super.getQueryHitCount(viewRowSet);
        
        long value = 0;
        if(rows.size() > 0 ){
            value = rows.size();
        }else{
            value = super.getQueryHitCount(viewRowSet);    
        }
        return value;
    }

    /**
     * getCappedQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getCappedQueryHitCount(ViewRowSetImpl viewRowSet, Row[] masterRows, long oldCap, long cap) {
        long value = super.getCappedQueryHitCount(viewRowSet, masterRows, oldCap, cap);
        return value;
    }
    
    /**
     * Method to set the new fetch position
     * @param rowset
     * @param position
     * To set the position on the nextRecord to fetch i.e. next record of arrayList
     */
    private void setFetchPosition(Object rowset, int position) {
        
        if(rows.size() > 0){
            if (position == rows.size() - 1) {
                setFetchCompleteForCollection(rowset, true);
            }
            setUserDataForCollection(rowset, new Integer(position));
        }
    }

    /**
     * Method to get the current fetch position
     * @param rowset
     * @return
     *
     * This method gets the fetchPosition to fetch the row from the arrayList to retrieve the data
     */
    private int getFetchPosition(Object rowset) {
        int value = 0;
        try{
            value = ((Integer)getUserDataForCollection(rowset)).intValue();    
        }catch(Exception e){
            e.printStackTrace();
        }
        return value;
    }
    
    /**
     * Actualiza los registros de Grupo de Roles BPM
     * @param rows contiene lista de Grupo de Roles BPM
     */
    public void setRows(List<GrupoRolAprobacionVORowImpl> rows, 
                        Number idNivelAprob) {
        this.rows.clear();
        logger.warning("entra en setRows en GrupoRolAprobacionVO");
        logger.warning("idNivelAprob : " + idNivelAprob);
        rows = ordenarGrupos(rows);
        
        
        
        this.rows.addAll(rows);
        for(GrupoRolAprobacionVORowImpl row : this.rows){
            row.setIdNivelAprobacion(idNivelAprob);
            
            String nombreUsuario = actualizarNombreUsuarioByLogin(row.getUsuario()) ;
            
            if(nombreUsuario != null){
                 row.setNombreMiembro(nombreUsuario);
             }
            
            insertRow(row);
        }
        
        if(getEstimatedRowCount() > 0){
            //Asigna el primer registro como registro actual
            GrupoRolAprobacionVORowImpl row = (GrupoRolAprobacionVORowImpl) first();
            setCurrentRow(row);
        }
    }
    
    
    public String actualizarNombreUsuarioByLogin(String loginUsuario){
        logger.warning("Inicia metodo actualizarNombreUsuarioByLogin");
        String nombreUsuario = null; 
       
        if(loginUsuario == null){
            logger.warning("parametro loginUsuario resulto a null no se realizara la actualizacion");
            return null;
        }
       
        FenixAMImpl fenixAMImpl = null;
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        
        nombreUsuario =
           fenixAMImpl.getComiteVotoReunionVO().getNombreUsuarioByLogin(loginUsuario);
        
        
        logger.warning("termina metodo actualizarNombreUsuarioByLogin nombreUsuario: "+nombreUsuario); 
        return nombreUsuario;
    }
    
    /**
     * Asigna el miembro de aprobacion por defecto para el grupo de miembros por medio
     * del valor del atributo propiedad
     * @param miembros contiene lista de miembros de aprobacion
     */
    public void setMiembroGrupoPorDefecto(List<MiembrosAprobacionVORowImpl> miembros){
        logger.warning("Entra en setMiembroGrupoPorDefecto en GrupoRolAprobacionVO");
        RowSetIterator iter = createRowSetIterator(null);
        while(iter.hasNext()){
            GrupoRolAprobacionVORowImpl grupo = null;
            grupo = (GrupoRolAprobacionVORowImpl) iter.next();
            if(grupo != null){
                for(MiembrosAprobacionVORowImpl rowMiembro : miembros){
                    if(grupo.getIdRolBpm().equals(rowMiembro.getIdTcaRolBpm())){
                        
                        String nombreUsuario = actualizarNombreUsuarioByLogin(rowMiembro.getUsuario()) ;
                        
                        if(nombreUsuario != null){
                             rowMiembro.setNombre(nombreUsuario);
                         }
                    
                        logger.warning("Valor propietario : " + rowMiembro.getPropietario());
                        logger.warning("nombre usuario :"+rowMiembro.getNombre());
                        logger.warning("usuario :"+rowMiembro.getUsuario());
                        
                        if(rowMiembro.getPropietario() != null &&
                           Boolean.TRUE.equals(rowMiembro.getPropietario())){
                            if(rowMiembro.getNombre() != null &&
                               rowMiembro.getUsuario() != null){
                                
                                if(!MiembrosAprobacionVOImpl.OTRO_VALUE_KEY.equals(rowMiembro.getUsuario()) &&
                                   !MiembrosAprobacionVOImpl.EXCUSADO_VALUE_KEY.equals(rowMiembro.getUsuario())){                                    
                                    grupo.setNombreMiembro(rowMiembro.getNombre());
                                    grupo.setUsuario(rowMiembro.getUsuario());                                    
                                    break;
                                }else{
                                    logger.warning("rowMiembro.getNombre()" + rowMiembro.getNombre());
                                    grupo.setNombreMiembro(rowMiembro.getNombre());
                                    grupo.setUsuario(rowMiembro.getUsuario());
                                    break;
                                }
                            }else{
                                if(rowMiembro.getNombre()  == null){
                                    logger.warning("nombre es nulo");
                                }
                                
                                if(rowMiembro.getUsuario() == null){
                                    logger.warning("usuario es nulo");
                                }
                            }
                        }else{
                            logger.warning("No es propietario");
                        }
                        logger.warning("Nombre usuario : " + rowMiembro.getNombre());
                        logger.warning("usuario : " + rowMiembro.getUsuario());
                        if(NOMBRE_USUARIO_OTRO.equalsIgnoreCase(rowMiembro.getNombre())){
                            logger.warning("Entra en nombre de usuario otro.");
                            grupo.setNombreMiembro(rowMiembro.getNombre());
                            grupo.setUsuario(MiembrosAprobacionVOImpl.OTRO_VALUE_KEY);    
                            break;
                        }
                        if(NOMBRE_USUARIO_EXCUSADO.equalsIgnoreCase(rowMiembro.getNombre())){
                            logger.warning("Entra en nombre de usuario excusado.");
                            grupo.setNombreMiembro(rowMiembro.getNombre());
                            grupo.setUsuario(MiembrosAprobacionVOImpl.EXCUSADO_VALUE_KEY);    
                            break;
                        }
                    }
                }
            }else{
                logger.warning("El objeto grupo es nulo.");
            }
        }
        iter.closeRowSetIterator();
        
        logger.warning("Fuera de setMiembroGrupoPorDefecto");
    }

    public List<GrupoRolAprobacionVORowImpl> getRows() {
        return rows;
    }
    
    /**
     * Configura y asigna grupos de Roles BPM del analisis de una lista de Miembros de Aprobacion quienes
     * tienes definidos roles en sus atributos
     * @param miembros contiene lista de Miembros de Aprobacion
     */
    public void configGrupoPorMiembrosAprob(List<MiembrosAprobacionVORowImpl> miembros,
                                            Number idNivelAprob){
        
        if(miembros == null ||
           miembros.size() == 0){
            return;
        }
        
        List<GrupoRolAprobacionVORowImpl> grupoList = null;
        int id = 0;
        Number idTcaRolBpm = null;
        String cveRolBpm = null;
        String descRolBpm = null;
        Boolean emiteVoto = false;
        
        for(MiembrosAprobacionVORowImpl row : miembros){
            idTcaRolBpm = row.getIdTcaRolBpm();
            cveRolBpm = row.getCveRolBPM();
            descRolBpm = row.getDescRolBPM();
            emiteVoto = row.getEmiteVoto();
            
            if(idTcaRolBpm == null){
                continue;
            }
            
            cveRolBpm = cveRolBpm.trim();
            descRolBpm = descRolBpm != null ? descRolBpm.trim() : descRolBpm;
            
            if(grupoList == null){
                id = id + 1;
                grupoList = new ArrayList<GrupoRolAprobacionVORowImpl>();
                GrupoRolAprobacionVORowImpl nuevoGrupo = createRow(new Number(id),
                                                                   new Number(id),
                                                                   idTcaRolBpm,
                                                                   cveRolBpm,
                                                                   descRolBpm,
                                                                   emiteVoto,
                                                                   idNivelAprob);
                if(nuevoGrupo != null){
                    grupoList.add(nuevoGrupo);    
                }
            }else{
                
                boolean blnAgregar = true;
                for(GrupoRolAprobacionVORowImpl grupo : grupoList){
                    
                    if(idTcaRolBpm.equals(grupo.getIdRolBpm()) ||
                       cveRolBpm.equals(grupo.getCveRolBpm())){
                        blnAgregar = false;
                    }
                }
                
                if(blnAgregar){
                    id = grupoList.size() + 1;
                    GrupoRolAprobacionVORowImpl nuevoGrupo = createRow(new Number(id),
                                                                       new Number(id),
                                                                       idTcaRolBpm,
                                                                       cveRolBpm,
                                                                       descRolBpm,
                                                                       emiteVoto,
                                                                       idNivelAprob);
                    if(nuevoGrupo != null){
                        grupoList.add(nuevoGrupo);
                    }
                }
            }
        }
        
        if(grupoList != null){
            setRows(grupoList, idNivelAprob);
        }
    }
    
    /**
     * Crea un nuevo registro de Grupo de Rol para Aprobacion
     * @param id Identificador de registro de grupo
     * @param idTcaRolBpm Identificador de Rol de BPM
     * @param cveRolBpm Descripcion corta del Rol de BPM, puede aplicar como clave alterna
     * @param descRolBpm Descripcion a mostrar del Rol de BPM
     * @return devuelve objeto Row
     */
    public GrupoRolAprobacionVORowImpl createRow(Number id,
                                                 Number orden,
                                                 Number idTcaRolBpm,
                                                 String cveRolBpm,
                                                 String descRolBpm,
                                                 Boolean emiteVoto,
                                                 Number idNivelAprob){
        logger.warning("Entra en createRow Grupo Rol Aprobacion");
        GrupoRolAprobacionVORowImpl grupo = null;
        logger.warning("id : " + id);
        logger.warning("idTcaRolBpm : " + idTcaRolBpm);
        logger.warning("descRolBpm : " + descRolBpm);
        if(id != null &&
           idTcaRolBpm != null &&
           descRolBpm != null){
            
            grupo = (GrupoRolAprobacionVORowImpl) createRow();
            grupo.setId(id);
            grupo.setOrden(orden);
            grupo.setIdRolBpm(idTcaRolBpm);
            grupo.setCveRolBpm(cveRolBpm);
            grupo.setDesRolBpm(descRolBpm);    
            grupo.setEmiteVoto(emiteVoto);
            grupo.setIdNivelAprobacion(idNivelAprob);
        }else{
           logger.warning("Se recibieron valores nulos"); 
        }
        
        return grupo;
    }
    
    /**
     * Ordena los grupos por id de Orden
     * @param grupoList contiene lista de grupos
     * @return devuelve lista
     */
    private List<GrupoRolAprobacionVORowImpl> ordenarGrupos(List<GrupoRolAprobacionVORowImpl> grupoList){
        
        Collections.sort(grupoList, new Comparator<GrupoRolAprobacionVORowImpl>(){
            public int compare(GrupoRolAprobacionVORowImpl grupo1, GrupoRolAprobacionVORowImpl grupo2) {
                return grupo2.getIdRolBpm().compareTo(grupo1.getIdRolBpm());
            }
        });
        
        return grupoList;
    }
    
    /**
     * Busca el registro de Grupo por Id de Rol BPM
     * @param id contiene id de Rol
     * @return devuelve registro
     */
    public GrupoRolAprobacionVORowImpl getGrupoPorIdRol(Long id){
        
        GrupoRolAprobacionVORowImpl row = null;
        
        RowSetIterator rsIterator = createRowSetIterator(null);  
        rsIterator.reset();  
        boolean esEncontrado = false;
        while (rsIterator.hasNext()) {
            row = (GrupoRolAprobacionVORowImpl) rsIterator.next();
            if(id != null &&
               id.equals(row.getIdRolBpm().longValue())){
                esEncontrado = true;
                break;
            }
        }
        if(!esEncontrado){
            row = null;
        }
        rsIterator.closeRowSetIterator();  
        
        return row;
    }
    
    public Boolean validarLista(){
        Boolean respuesta=Boolean.FALSE;
            GrupoRolAprobacionVORowImpl row = null;
            int contador=0;
            RowSetIterator rsIterator = createRowSetIterator(null);  
            rsIterator.reset();  
            boolean esEncontrado = false;
            while (rsIterator.hasNext()) {
                row = (GrupoRolAprobacionVORowImpl) rsIterator.next();
                if(null!=row){
                    if(null != row.getNombreMiembro()){
                        contador=contador+1;
                        }
                }
            }
            if(contador == this.getEstimatedRowCount()){
                    respuesta=Boolean.TRUE;
                }
            rsIterator.closeRowSetIterator();  
        return respuesta;
        }
    
    /**
     * Valida si un miembro de aprobacion pertenece a un rol que no debe votar
     * @param miembroReunion contiene datos del miembro de aprobacion
     * @return devuelve valor booleano, true si vota o false en caso contrario
     */
    public boolean emitirVoto(MiembroReunion miembroReunion){
        logger.warning("Entra en emitirVoto.");
        boolean emiteVoto = true;
        if(miembroReunion != null){
            
            //Obtiene roles que no votan
            if(miembroReunion.getRol() != null){
                
                Long id = miembroReunion.getRol().getId();
                String descC = miembroReunion.getRol().getDescripcionCorta();
                descC = descC != null ? descC.trim() : null;
                
                //Obtiene referencia de Id o descripcion corta de roles via Bundle
                ResourceBundle rb = BundleFactory.getBundle(BUNDLE);
                String value = rb.getString(ROL_VOTO_DENEGADO_BKEY);
                String[] values = value.split(",");
                logger.warning("Tamaño de los roles : " + values.length);
                for(String rol : values){
                    
                    rol = rol != null ? rol.trim() : "";
                    if(id != null){
                        if(id.toString().equals(rol)){
                            emiteVoto = false;
                            break;
                        }
                    }else{
                        logger.warning("El id del rol es nulo.");
                    }
                    if(descC != null){
                        if(descC.equals(rol)){
                            emiteVoto = false;
                            break;
                        }
                    }
                }
            }
        }else{
            logger.warning("El valor del objeto miembroReunion es nulo.");
        }
        logger.warning("Emite voto : " + emiteVoto);
        return emiteVoto;
    }
}

