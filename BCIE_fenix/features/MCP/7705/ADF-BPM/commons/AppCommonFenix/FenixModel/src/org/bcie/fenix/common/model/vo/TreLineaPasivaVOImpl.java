package org.bcie.fenix.common.model.vo;

import com.asn1c.core.Bool;

import java.math.BigDecimal;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.NameValuePairs;
import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.server.SequenceImpl;
import oracle.jbo.server.ViewObjectImpl;

import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.am.FenixGestorDesembolsosAMImpl;
import org.bcie.fenix.common.model.vo.common.TreLineaPasivaVO;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Fri Sep 09 13:09:03 CDT 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class TreLineaPasivaVOImpl extends ViewObjectImpl implements TreLineaPasivaVO {
    
    private static ADFLogger logger = null;
    
    /**
     * This is the default constructor (do not remove).
     */
    public TreLineaPasivaVOImpl() {
        if (logger == null) {
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }
    
    private void aplicarCriteriaIdContratoIdFuente(Long idContrato, Long idFuente) {
        logger.log(ADFLogger.WARNING, "Entrado en aplicarCriteriaIdContratoIdFuente.");
        logger.log(ADFLogger.WARNING, "idContrato: " + idContrato);
        logger.log(ADFLogger.WARNING, "idFuente: " + idFuente);
        
        ViewCriteria criteria = null;
        criteria = getViewCriteriaManager().getViewCriteria("LineaPasivaPorIdContratoIdFuenteVC");
        criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
        criteria.ensureVariableManager().setVariableValue("pIdFuente", idFuente);
        
        applyViewCriteria(criteria);
        
        logger.log(ADFLogger.WARNING, "Saliendo de aplicarCriteriaIdContratoIdFuente.");
    }
    
    private void removerCriteriaIdContratoIdFuente() {
        logger.log(ADFLogger.WARNING, "Entrado en removerCriteriaIdContratoIdFuente.");
        getViewCriteriaManager().removeApplyViewCriteriaName("LineaPasivaPorIdContratoIdFuenteVC");
        logger.log(ADFLogger.WARNING, "Saliendo de removerCriteriaIdContratoIdFuente.");
    }
    
    public Row obtenerLineaPasiva(Long idContrato, Long idFuente){
        logger.warning("Inicia metodo obtenerLineaPasiva");
        Row row = null;
        
        if(null == idContrato && null == idFuente){
            logger.warning("Parametros requeridos son NULL");
            logger.warning("IdContrato: " + idContrato);
            logger.warning("IdFuente: " + idFuente);
            return row;
        }
        
        aplicarCriteriaIdContratoIdFuente(idContrato, idFuente);
        executeQuery();
        
        logger.warning("Registros de TreLineaPasiva: " + getEstimatedRowCount());
        if(getEstimatedRowCount() > 0){
            RowSetIterator iter = createRowSetIterator(null);
            if(null != iter){
                iter.reset();
                while(iter.hasNext()){
                    row = iter.next();
                    if(null != row){
                        logger.warning("ID DEL CONTRATO: " + idContrato + ", ID DE LA FUENTE: " + idFuente);
                        if(idContrato.compareTo(new Long(row.getAttribute("IdContrato").toString()))==0 &&
                           idFuente.compareTo(new Long(row.getAttribute("IdFuente").toString()))==0){
                            logger.warning("Row con idContrato y idFuente correspondiente obtenido");
                            logger.warning("Id de Fuente: " + row.getAttribute("Id"));
                            break;
                        }else{
                            logger.warning("No se encontro coincidencia en el registro.");
                            row = null;
                        }
                    }else{
                        logger.warning("El row es NULL.");
                    }
                }
            }else{
                logger.warning("Iterador NULL");
            }
            iter.closeRowSetIterator();
        }else{
            logger.warning("No se encontraron registros de Linea pasiva.");
        }
        
        removerCriteriaIdContratoIdFuente();
        
        logger.warning("Termina metodo obtenerLineaPasiva");
        return row;
    }
    
    public Boolean guardarMontoDesembolsarLineaPasiva(Long idContrato, Long idFuente, BigDecimal montoDesembolsar,
                                                      BigDecimal montoDisponible, BigDecimal reservaTotal){
        logger.warning("Inicia metodo guardarMontoDesembolsarLineaPasiva");
        Boolean resultado = Boolean.FALSE;
        Row row = null;
        FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAM = null;
        
        if(null == idContrato || null == idFuente){
            logger.warning("Parametros requeridos son NULL");
            logger.warning("IdContrato: " + idContrato);
            logger.warning("IdFuente: " + idFuente);
            return resultado;
        }
        
        aplicarCriteriaIdContratoIdFuente(idContrato, idFuente);
        executeQuery();
        
        Boolean marcadorRegistroExiste = Boolean.FALSE;
        logger.warning("Registros de Lineas Pasivas: " + getEstimatedRowCount());
        if(getEstimatedRowCount() > 0){
            RowSetIterator iter = createRowSetIterator(null);
            if(null != iter){
                iter.reset();
                while(iter.hasNext()){
                    logger.warning("Iniciando iteracion de row");
                    row = iter.next();
                    if(null != row){
                        logger.warning("Evaluando row con idContrato: " + idContrato + " y idFuente " + idFuente);
                        logger.warning("IdContrato de row: " + row.getAttribute("IdContrato").toString());
                        logger.warning("IdFuente de row: " + row.getAttribute("IdFuente").toString());
                        if(idContrato.compareTo(new Long(row.getAttribute("IdContrato").toString()))==0 &&
                            idFuente.compareTo(new Long(row.getAttribute("IdFuente").toString()))==0){
                            logger.warning("Monto a desembolsar: " + montoDesembolsar);

                            try {
                                logger.warning("Instanciando FenixGestorDesembolsosAMImpl");
                                fenixGestorDesembolsosAM = (FenixGestorDesembolsosAMImpl) this.getApplicationModule();
                            } catch (Exception e) {
                                logger.warning("Error al instanciar FenixGestorDesembolsosAMImpl ", e);
                            }
                            
                            if(null != montoDesembolsar){
                                logger.warning("Asignando nuevo monto a desembolsar: " + montoDesembolsar);
                                row.setAttribute("MontoDesembolsar", montoDesembolsar);  
                                resultado = Boolean.TRUE;
                            }else{
                                if(null != fenixGestorDesembolsosAM){
                                    Long idTreLineaPasiva = null;
                                    try{
                                        idTreLineaPasiva = (Long) row.getAttribute("Id");
                                    }catch(Exception e){
                                        logger.warning("ERROR al obtener el IdTreLineaPasiva del row", e);
                                    }
                                    fenixGestorDesembolsosAM.getTransferenciaRecursosVO().borrarRegistroTransferenciaPorIdLineaPasiva(idTreLineaPasiva);
                                }
                                
                                logger.warning("Borrando registro de Linea Pasiva: " + row.getAttribute("Id"));
                                row.remove();
                            }
                            marcadorRegistroExiste = Boolean.TRUE;
                        }
                    }else{
                        logger.warning("Row NULL");
                    }
                }
                if(!marcadorRegistroExiste){
                    logger.warning("Invocando metodo para crear");
                    resultado = crearNuevoRegistro(idContrato, idFuente, montoDisponible, montoDesembolsar, reservaTotal);
                    if(!resultado){
                        logger.warning("No se pudo crear el registro faltante");
                    }
                    marcadorRegistroExiste = Boolean.FALSE;
                    resultado = Boolean.TRUE;
                }
            }else{
                logger.warning("Iterador NULL.");
            }
            iter.closeRowSetIterator();
        }else{
            logger.warning("No se encontraron Lineas Pasivas para filtrar.");
            resultado = crearNuevoRegistro(idContrato, idFuente, montoDisponible, montoDesembolsar, reservaTotal);
            if(!resultado){
                logger.warning("No se pudo crear el registro faltante");
            }
            
        }
        
        removerCriteriaIdContratoIdFuente();
        
        logger.warning("Termina metodo guardarMontoDesembolsarLineaPasiva");
        return resultado;
    }
    
    public Boolean crearNuevoRegistro(Long idContrato, Long idFuente, BigDecimal montoDisponible,
                                   BigDecimal montoDesembolsar, BigDecimal reservaTotal){
        logger.warning("Inicia metodo crearNuevoRegistro");
        Boolean resultado = Boolean.FALSE;
        Row treLineaPasivaRow = null;
        Long idTreLineaPasiva = null;
        NameValuePairs nvpTreLineaPasiva = null;
        SequenceImpl seqTreLineaPasiva = null;
        
        if(null == idContrato || null == idFuente){
            logger.warning("Parametros requeridos son NULL");
            return resultado;
        }
        
        if(null != montoDesembolsar){        
            seqTreLineaPasiva = new SequenceImpl("TRE_LINEA_PASIVA_SEQ", getDBTransaction());
            try{
                idTreLineaPasiva = seqTreLineaPasiva.getSequenceNumber().longValue();
            }catch(Exception e){
                logger.warning("ERROR al generar la sequencia", e);
                return resultado;
            }
            logger.warning("Nuevo registro de TreLineaPasiva: " + idTreLineaPasiva);
            nvpTreLineaPasiva = new NameValuePairs();
            nvpTreLineaPasiva.setAttribute("Id", idTreLineaPasiva);
            nvpTreLineaPasiva.setAttribute("IdContrato", idContrato);
            nvpTreLineaPasiva.setAttribute("IdFuente", idFuente);
            nvpTreLineaPasiva.setAttribute("MontoDesembolsar", montoDesembolsar);
            nvpTreLineaPasiva.setAttribute("MontoDisponible", montoDisponible);
            nvpTreLineaPasiva.setAttribute("ReservaTotal", reservaTotal);
            nvpTreLineaPasiva.setAttribute("BanEstatus", 1);
        
            treLineaPasivaRow = this.createAndInitRow(nvpTreLineaPasiva);
        }else{
            logger.warning("No se ha creado el registro de la fuente con id: " + idFuente);
        }
        resultado = Boolean.TRUE;
        
        logger.warning("Termina metodo crearNuevoRegistro");
        return resultado;
    }
    
    public Boolean guardarFuentesCambioTab(){
        logger.warning("Inicia metodo guardarFuentesCambioTab");
        Boolean resultado = Boolean.FALSE;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        
        gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) this.getApplicationModule();
        if(null != gestorDesembolsosAMImpl){
            logger.warning("Invocando configuracion para guardar los registors de Fuentes externas.");
            resultado = gestorDesembolsosAMImpl.getFuentesExternasContratoDesembolsoVO().guardarMontoDesembolsarFuentesExternas();
            if(resultado){
                try{
                    logger.warning("Ejecutando COMMIT");
                    getDBTransaction().commit();
                    logger.warning("commit exitoso en guardarFuentesCambioTab");
                }catch(Exception e){
                    logger.warning("error en commit en guardarFuentesCambioTab:"+e);
                    try{
                        getDBTransaction().commit();
                        logger.warning("segundo commit exitoso en guardarFuentesCambioTab");
                    }catch(Exception ex){
                        logger.warning("error en commit de guardarFuentesCambioTab:",ex);
                        resultado = Boolean.FALSE;
                    }
                }
            }else{
                logger.warning("No se han preparado los registros para guardar las fuentes externas.");
            }
        }else{
            logger.warning("Instancia del FenixAMImpl es NULL.");
        }
        
        logger.warning("Termina metodo guardarFuentesCambioTab");
        return resultado;
    }
    
    public Row buscarRowByIdContrato(Long idContrato) {
        logger.warning("*** Inicia metodo buscarRowByIdContrato TreLineaPasiva");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        
        Row filaRecuperada = null;
        ViewCriteria criteria = null;

        if (idContrato == null) {
            logger.warning("*** El parametro idContrato es requerido para la busqueda");
            return null;
        }
        try {
            criteria = getViewCriteriaManager().getViewCriteria("BuscarByIdContratoVC");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            applyViewCriteria(criteria);
            executeQuery();

            if (getEstimatedRowCount() > 0) {
                setCurrentRow(first());
                filaRecuperada = getCurrentRow();
                logger.warning("Beneficiario recuperado ->" + filaRecuperada.getAttribute("IdFuente"));
            } else {
                logger.warning("El row recuperado es Null no hay coincidencias en la busqueda");
                getViewCriteriaManager().removeApplyViewCriteriaName("BuscarByIdContratoVC");
                executeQuery();
            }

        } catch (Exception e) {
            logger.log(ADFLogger.WARNING, "*** Error al BuscarPorNumCuenta  ->" + e.getClass() + ":" + e.getMessage());
        } finally {
            getViewCriteriaManager().removeApplyViewCriteriaName("BuscarByIdContratoVC");
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/1000; //Calculamos los milisegundos de diferencia
        logger.warning("*** Termina metodo buscarRowByIdContrato en TreLineaPasiva con una duracion de: "+tiempo+" segundos");
        return filaRecuperada;
    }
    
    public Boolean montoDesembolsarLineaPasivaVsContrato(Long idContrato){
        logger.warning("Inicia metodo montoDesembolsarLineaPasivaVsContrato");
        Boolean esIgual = Boolean.FALSE;
        BigDecimal sumaMontoLineaPasiva = null;
        BigDecimal montoDesembolsarContrato = null;
        ViewCriteria criteria = null;
        Row row = null;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAM = (FenixGestorDesembolsosAMImpl) getApplicationModule();
        
        logger.warning("IdContrato a evaluar: " + idContrato);
        if(null == idContrato){
            logger.warning("El parametro idContrato requerido es NULL.");
            return esIgual;
        }
        
        gestorDesembolsosAM.getContratoDesembolsoVO().ejecutarQuerty();
        montoDesembolsarContrato = gestorDesembolsosAM.getContratoDesembolsoQueryVO().obtenerMontoDesembolsarContrato(idContrato);
        
        setpIdContrato(idContrato);
        criteria = getViewCriteria("LineaPasivaPorIdContratoVC");
        applyViewCriteria(criteria);
        executeQuery();
        
        logger.warning("Registros de Lineas Pasivas encontradas: " + getEstimatedRowCount());
        if(getEstimatedRowCount() > 0){
            RowSetIterator iter = createRowSetIterator(null);
            if(null != iter){
                iter.reset();
                while(iter.hasNext()){
                    logger.warning("Iniciando iteracion de row");
                    row = iter.next();
                    if(null != row){
                        Long idContratoRow = null;
                        BigDecimal montoDesembolsar = null;
                        
                        try{
                            idContratoRow = (Long) row.getAttribute("IdContrato");
                        }catch(Exception e){
                            logger.warning("No se pudo obtener el valor del contrato del row.");
                        }
                        
                        if(null != idContratoRow){
                            if(idContrato.compareTo(idContratoRow)==0){
                                logger.warning("Obteniendo el monto de la linea pasiva.");
                                try{
                                    montoDesembolsar = (BigDecimal) row.getAttribute("MontoDesembolsar");
                                }catch(Exception e){
                                    logger.warning("No se pudo obtener el monto a desembolsar de la Linea pasiva.");
                                }
                                
                                logger.warning("Sumando montos de lineas pasivas.");
                                if(null != sumaMontoLineaPasiva){
                                    sumaMontoLineaPasiva = sumaMontoLineaPasiva.add(montoDesembolsar);
                                }else{
                                    sumaMontoLineaPasiva = montoDesembolsar;
                                }
                            }
                        }else{
                            logger.warning("idContratoRow es null.");
                        }
                    }else{
                        logger.warning("El row es NULL.");
                    }
                }
                
                logger.warning("El monto total a desembolsar de las lineas pasivas del contrato es: " + sumaMontoLineaPasiva);
                logger.warning("El monto a desembolsar del contrato es: " + montoDesembolsarContrato);
                if(null != montoDesembolsarContrato){
                    /* if(!(montoDesembolsarContrato.compareTo(new BigDecimal(0.0))==0)){ */
                        if(montoDesembolsarContrato.compareTo(sumaMontoLineaPasiva)==0){
                            logger.warning("Monto de contrato de desembolso y monto a desembolsar de la linea pasiva es igual.");
                            esIgual = Boolean.TRUE;
                        }else{
                            logger.warning("Los montos del contrato y de la linea pasiva no son iguales.");
                        }
                    /* }else{
                        logger.warning("EL CONTRATO ES DESESTIMADO. EVALUANDO A TRUE.");
                        esIgual = Boolean.TRUE;
                    } */
                }else{
                    logger.warning("El monto a desembolsar del contrato es NULL.");
                }
            }else{
                logger.warning("Iterador NULL.");
            }
            iter.closeRowSetIterator();
        }else{
            logger.warning("No existen registros de lineas pasivas para el contrato.");
            esIgual = Boolean.TRUE;
        }
        
        removeApplyViewCriteriaName("LineaPasivaPorIdContratoVC");
        logger.warning("Termina metodo montoDesembolsarLineaPasivaVsContrato");
        return esIgual;
    }
    
    public Long recuperarIdTreLineaPasivaPorContratoFuente(Long idContrato, Long idFuente){
        logger.warning("Inicia metodo recuperarIdTreLineaPasivaPorContratoFuente");
        Long idTreLineaPasiva = null;
        Row row = null;
        
        aplicarCriteriaIdContratoIdFuente(idContrato, idFuente);
        executeQuery();
        
        logger.warning("Registros obtenidos del filtro: " + getEstimatedRowCount());
        if(getEstimatedRowCount() > 0){
            row = first();
            
            if(null != row){
                try{
                    idTreLineaPasiva = (Long) row.getAttribute("Id");
                }catch(Exception e){
                    logger.warning("ERROR al obtener el idTreLineaPasiva.", e);
                }
            }
        }
        
        removerCriteriaIdContratoIdFuente();
        
        logger.warning("IdTreLineaPasiva recuperada: " + idTreLineaPasiva);
        logger.warning("Termina metodo recuperarIdTreLineaPasivaPorContratoFuente");
        return idTreLineaPasiva;
    }
    
    /**
     * Returns the variable value for pIdContrato.
     * @return variable value for pIdContrato
     */
    public Long getpIdContrato() {
        return (Long) ensureVariableManager().getVariableValue("pIdContrato");
    }

    /**
     * Sets <code>value</code> for variable pIdContrato.
     * @param value value to bind as pIdContrato
     */
    public void setpIdContrato(Long value) {
        ensureVariableManager().setVariableValue("pIdContrato", value);
    }

    /**
     * Returns the variable value for pIdFuente.
     * @return variable value for pIdFuente
     */
    public Long getpIdFuente() {
        return (Long) ensureVariableManager().getVariableValue("pIdFuente");
    }

    /**
     * Sets <code>value</code> for variable pIdFuente.
     * @param value value to bind as pIdFuente
     */
    public void setpIdFuente(Long value) {
        ensureVariableManager().setVariableValue("pIdFuente", value);
    }
}

