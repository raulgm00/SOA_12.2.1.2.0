var jsEncode = {
    encode: function(s) {

        var str = "";
        var k = Math.floor((Math.random() * 100));
        var enc = "" + k + "a";

        str = s.toString();
        for (var i = 0; i < s.length; i++) {

            var a = s.charCodeAt(i);
            var b = (parseInt(a) + parseInt(k));

            if (i == s.length - 1)
                enc = enc + b;
            else
                enc = enc + b + "a";
        }
        return enc;
    }
};

var storage = function() {
        var t, e;
        return e = {
            items: [],
            isActive: !1
        }, t = {
            getCID: function() {
                return Math.ceil((new Date).getTime() * Math.random(20), 2)
            },
            setItem: function(t, o) {
                var n = this;
                0 !== t.length || void 0 !== t ? "object" == typeof t && n.getItem(o) !== o && (e.items.push({
                    cid: n.getCID(),
                    object: t,
                    type: o
                }), e.isActive = !0) : console.log("Error el tipo de objeto no es soportado")
            },
            getItem: function(t) {
                var o;
                return $.each(e.items, function(n) {
                    e.items[n].type === t && (o = e.items[n])
                }), o ? o : !1
            },
            resetItems: function() {
                e.items.splice(0, e.items.length)
            },
            getActive: function() {
                return e.isActive
            },
            setLocalStorage: function(t, e) {
                localStorage.setItem(t, e)
            },
            getLocalStorage: function(t) {
                return localStorage.getItem(t)
            },
            clearLocalStorage: function() {
                return localStorage.clear()
            }
        }, {
            set: function(e, o) {
                t.setItem(e, o)
            },
            get: function(e) {
                return t.getItem(e)
            },
            reset: function() {
                t.resetItems()
            },
            isActive: function() {
                return t.getActive()
            },
            setLocal: function(e, o) {
                t.setLocalStorage(e, o)
            },
            getLocal: function(e) {
                return t.getLocalStorage(e)
            },
            clearStorage: function() {
                t.clearLocalStorage()
            }
        }
    }(storage),
    endPoint = function() {
        var t = window.location.hostname,
            e = window.location.port,
            o = window.location.protocol,
            n = {
                login: {
                    get: o + "//" + t + ":" + e + "/Canal/AutenticarUsuario/V1.0/GetAutenticarUsuario",
                    //post: o + "//" + t + ":" + e + "/Canal/AutenticarUsuario/V1.0/GetAutenticarUsuario/WSrecuperarpass-ViewController-context-root/resources/view/recuperar"
                    post: o + "//" + t + ":" + e +"/WSrecuperarpass-ViewController-context-root/resources/view/recuperar"
                },
                voto: {
                    put: o + "//" + t + ":" + e + "/Canal/CrearRegistroVotacion/V1.0/PutCrearRegistroVotacion",
                    post: o + "//" + t + ":" + e + "/Canal/CrearRegistroVotacion/V1.0/PostCrearRegistroVotacion",
                    get: o + "//" + t + ":" + e + "/Canal/ConsultarVotaciones/V1.0/GetConsultarVotaciones"
                },
                operacion: {
                    getDetalleOperacion: o + "//" + t + ":" + e + "/Canal/ConsultarOperacion/V1.0/GetConsultarOperacion",
                    getVotosEmitidos: o + "//" + t + ":" + e + "/Canal/ConsultarVotosEmitidos/V1.0/GetConsultarVotosEmitidos",
                    putRegistraComentario: o + "//" + t + ":" + e + "/Canal/CrearComentarioVotacion/V1.0/PutCrearComentarioVotacion"
                },
                documento: {
                    getDocumento: o + "//" + t + ":" + e + "/Canal/ObtenerDocumento/V1.0/GetDocumento"
                },
                bitacora: {
                    post: o + "//" + t + ":" + e +"/WSrecuperarpass-ViewController-context-root/resources/intentos/gestionarIntento"
                }
            };
        return {
            point: function() {
                return n
            }
        }
    }(endPoint),
    validator = function() {
        var t;
        return t = {
            initialize: function(t) {
                return $(t).validate({
                    highlight: function(t) {
                        var e = "#" + $(t).attr("id") + "1";
                        $(t).closest(".input-group").addClass("has-error"), $(e).removeClass("glyphicon-ok").addClass("glyphicon-remove")
                    },
                    unhighlight: function(t) {
                        var e = "#" + $(t).attr("id") + "1";
                        $(t).closest(".input-group").removeClass("has-error"), $(e).removeClass("glyphicon-remove").addClass("glyphicon-ok")
                    },
                    errorElement: "span",
                    errorClass: "help-block",
                    errorPlacement: function(t, e) {
                        e.parent(".input-group").length ? t.insertAfter(e.parent()) : t.insertAfter(e)
                    }
                })
            }
        }, {
            init: function(e) {
                return t.initialize(e)
            }
        }
    }(validator);
$(document).ajaxStart(function() {
    $("#loader").modal("show")
}), $(document).ajaxStop(function() {
    $("#loader").modal("hide"), $("body").removeAttr("style")
});
var common = function() {
        var t;
        return t = {
            elModal: null,
            initialize: function() {
                var t = this;
                t.elModal = $("#notificacion")
            },
            setMessage: function(t) {
                var e = this;
                e.elModal.find("#messageModal").html(t)
            },
            triggerModal: function(t) {
                var e = this;
                e.elModal.modal(t)
            },
            isReadOperation: function(t) {
                var e = {};
                return t === !0 ? (e.faClass = "fa-check", e.colorClass = "list-group-item blue-read") : (e.faClass = "fa-file-text-o", e.colorClass = "list-group-item"), e
            },
            replaceAll: function(t, e, o) {
                try {
                    return t.replace(new RegExp(e, "gi"), o)
                } catch (n) {
                    return t
                }
            }
        }, {
            init: function() {
                t.initialize()
            },
            message: function(e) {
                t.setMessage(e)
            },
            modal: function(e) {
                t.triggerModal(e)
            },
            getClass: function(e) {
                return t.isReadOperation(e)
            }
        }
    }(),
    loginController = function() {
        var t;
        return t = {
            el: null,
            uriParams: !1,
            initialize: function(t) {
                var e = this;
                t ? e.el = $(t) : null, validator.init(e.el), common.init(), e.events(), window.location.search && (e.uriParams = !0, e.getUriParams())
            },
            events: function() {
                var t = this,
                    e = $("#access");
                var rp = $("#resetpassword");
                var btncp = $("#change");
                var btnCloseCP=$("#closeChange");
                var i1 = $("#usrcp");
                var i2 = $("#emcp");
                e.on({
                    click: function() {
                        t.el.valid() && t.login()
                    }
                })
                rp.on({
                    click: function() {
                        t.changepwd()
                    }
                })
                btncp.on({
                    click: function() {
                        t.change()
                    }
                })
                btnCloseCP.on({
                    click: function() {
                        t.closeChange()
                    }
                })
                i1.on({
                    click: function() {
                        t.cleanmsg()
                    }
                })
                i2.on({
                    click: function() {
                        t.cleanmsg()
                    }
                })
            },
            redirect: function() {
                var t = this;
                t.uriParams ? window.location.href = "operacion.html" : window.location.href = "index.html"
            },
            login: function() {
                console.log('into funcion login');
                var t = this;
                var usuario =$("#user").val();
                var exito="0";//no autenticado-> exito =0,  atenticado -> exito =1
                $.ajax({
                    url: endPoint.point().login.get,
                    type: "get",
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        "Content-Type": "text/plain; charset=utf-8"
                    },
                    data: {
                        usuario: jsEncode.encode($("#user").val()),
                        password: jsEncode.encode($("#password").val())
                    },
                    cache: !1
                }).done(function(e, o, n) {
                    var a;
                    if (a = "object" == typeof e ? e : JSON.parse(e), a && "true" === a.respuesta) {
                        exito="1";
                        //- 26/11/2019 LA BITACORA SIEMPRE MANDA 0
                        t.registroBitacora(usuario,exito);
                        var i = {
                            nombreCompleto: a.NombreCompleto,
                            dependencia: a.dependencia,
                            nivelAprobacion: a.nivelAprobacion,
                            accessControl: !0,
                            usuario: $("#user").val().toLowerCase()
                        };
                        storage.setLocal("login", JSON.stringify(i)),
                            t.getOperaciones($("#user").val().toLowerCase())
                        
                        
                        //t.getOperacionesHistorial($("#user").val())
                        //t.getOperacionesSCR($("#user").val()), 
                        //t.getOperacionesHistorialSCR($("#user").val())
                    } else {
                    //- 26/11/2019 LA BITACORA SIEMPRE MANDA 0
                        t.registroBitacora(usuario,exito);
                        common.message("Usuario y/o Contrase&ntilde;a incorrectos."), common.modal("show"), $("#user, #password").val(null)
                    
                    }
                }).fail(function(t, e, o) {
                    common.message("Se ha detectado un problema en el servicio, favor de intentar nuevamente."), common.modal("show")
                })
                //- 26/11/2019 LA BITACORA SIEMPRE MANDA 0  this.registroBitacora(usuario,exito);
            },
            //agregar funcion recuperar password
            changepwd: function() {
                $("#changepwd").modal("show")
            },
            closeChange: function() {
                console.log("cerrar changepwd");
                $("#changepwd").modal("hide")
                //reset campos
                $("#usrcp").val(null);
                $("#emcp").val(null);
                //mostrar div de datos 
                var datosRecuperar = document.getElementById("datosRecuperar");
                datosRecuperar.style.display = "block";
                //ocultar boton closeChange y mostrar boton change
                var btnChange = document.getElementById("change");
                btnChange.style.display = "block";
                var btnCloseChange = document.getElementById("closeChange");
                btnCloseChange.style.display = "none";
                //ocultar texto respuesta
                var response_recupera = $("#response_recupera");
                response_recupera.html("");
            },
            change: function() {
                console.log("cambiar pwd")
                var usrcp = $("#usrcp").val();
                var emcp = $("#emcp").val();
                console.log("usrcp: " + usrcp);
                console.log("emcp: " + emcp);
                                   
                if (usrcp == "" || emcp == ""|| usrcp == null || emcp == null) {
                    console.log("campos incompletos")
                    var vcp = $("#vcp");
                    vcp.html('Ambos campos son obligatorios')
                    retun;
                } else {
                    console.log('ws recuerar password');
                    //invocacion
                    var body = {
                        userName: usrcp,
                        userNameAlt: emcp
                    };
                    console.log("cambios");
                    console.log("body", body);
                    console.log('url: '+endPoint.point().login.post+"?userName="+usrcp+"&userNameAlt="+emcp);
                    $.ajax({
                        url: endPoint.point().login.post+"?userName="+usrcp+"&userNameAlt="+emcp,
                        type: "post",
                        crossDomain: true,
                        xhrFields: {withCredentials: false},
                        mode:'cors',
                        headers: {
                            Accept: "application/x-www-form-urlencoded; charset=UTF-8",
                            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
                            "Access-Control-Allow-Origin": "*"
                            //"Access-Control-Request-Headers": "authorization,content-type,destination,user",
                            //"Access-Control-Request-Method":"GET, POST, PUT, DELETE, OPTIONS",
                            //"Host":"http://hn-obpm-qa-1.bcie.org",
                            //"Access-Control-Allow-Credentials":true,
                            //"Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS"
                        },
                        data: $.param(body)
                    }).done(function(e, o, n) {
                        console.log("response");
                        var a;
                        console.log("e", e);
                        console.log("o", o);
                        console.log("n", n);
                        //a = "object" == typeof e ? e : JSON.parse(e);
                        a = "object" == typeof e ? e : JSON.parse(e);

                        if (a.mensaje !== 'error') {
                            console.log(a);
                            /*var respuesta = JSON.parse(e);*/
                            var response_recupera = $("#response_recupera");
                            console.log('a.mensaje: '+a.mensaje);
                            
                            if(a.mensaje==="Se ha enviado a su correo electrónico el instructivo para realizar el cambio de contraseña."){
                                //ocultar inputs
                                console.log('entro en true');
                                response_recupera.html('<h6 id="response_recupera_label" style="color:Green;">'+a.mensaje+'</h6>');
                                
                                var datosRecuperar = document.getElementById("datosRecuperar");
                                datosRecuperar.style.display = "none";
                                //ocultar boton change y mostrar boton closeChange
                                var btnChange = document.getElementById("change");
                                btnChange.style.display = "none";
                                var btnCloseChange = document.getElementById("closeChange");
                                btnCloseChange.style.display = "block";
                                
                            }else{
                                console.log('entro en false');
                                response_recupera.html('<h6 id="response_recupera" style="color:Red;">'+a.mensaje+'</h6>');
                                $("#usrcp").val(null);
                                $("#emcp").val(null);
                            }
                            
                        } else {
                            var vcp = $("#vcp");
                            vcp.html('Correo|Usuario o Número Empleado incorrectos');
                            $("#usrcp, #emcp").val(null);
                        }


                    }).fail(function(t, e, o) {
                        console.log("e", e);
                        console.log("t", t);
                        console.log("o", o);
                        common.message("Se ha detectado un problema en el servicio, favor de intentar nuevamente."), common.modal("show")
                    })


                    ///
                }
            },
            cleanmsg: function() {
                var vcp = $("#vcp");
                vcp.html('')
            },
            getUriParams: function() {
                var t = window.location.search.split("&"),
                    e = [];
                $.each(t, function(o) {
                    var n = t[o].split("=");
                    e.push(n[1])
                });
                var o = '{"id":' + e[0] + ',"aprobacion":' + e[1] + ',"idUsuario":' + e[2] + "}";
                storage.setLocal("operacion-" + e[0], o), storage.setLocal("id", +e[0])
            },
            getOperaciones: function(t) {
                var e = this;
                var historial = 'false';
                var apCliente = 'false';
                $.ajax({
                    url: endPoint.point().voto.get,
                    type: "get",
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        "Content-Type": "text/plain; charset=utf-8"
                    },
                    data: {
                        Usuario: jsEncode.encode(t),
                        historial: jsEncode.encode(historial),
                        aprobacionCliente: jsEncode.encode(apCliente)
                    },
                    cache: !1
                }).done(function(t, o, n) {
                    var a;
                    a = "object" == typeof t ? t : JSON.parse(t), null !== a.Votaciones ? (storage.setLocal("votaciones", JSON.stringify(a.Votaciones)), e.redirect()) : (storage.setLocal("votaciones", JSON.stringify("1")), e.redirect(),console.log("No existen registros de operaciones"))
                }).fail(function(t, e, o) {
                    common.message("Se ha detectado un problema en el servicio, favor de intentar nuevamente."), common.modal("show")
                })
            },
            registroBitacora: function(usuario, exito) {
                console.log('regitrar en bitacora');
                console.log('usuario: '+usuario);
                console.log('exito: '+exito);
                var agente = navigator.appVersion;
                
                console.log('userAgent: '+agente);
                var app= 'WebMobileAprobacionBCIE';
                console.log('ws gestionarIntento');
                    //invocacion
                    var body = {
                        usuario: usuario,
                        usrAgent: agente,
                        app:app,
                        exito:exito
                    };
                    console.log("cambios");
                    console.log("body", body);
                    console.log('url: '+endPoint.point().bitacora.post+"?usuario="+usuario+"&usrAgent="+agente+"&app="+app+"&exito="+exito);
                    $.ajax({
                        url: endPoint.point().bitacora.post+"?usuario="+usuario+"&usrAgent="+agente+"&app="+app+"&exito="+exito,
                        type: "post",
                        //crossDomain: true,
                        //xhrFields: {withCredentials: false},
                        //mode:'cors',
                        headers: {
                            Accept: "application/x-www-form-urlencoded; charset=UTF-8",
                            contentType: "application/x-www-form-urlencoded",
                            "Access-Control-Allow-Origin": "*"
                            //"Access-Control-Request-Headers": "authorization,content-type,destination,user",
                            //"Access-Control-Request-Method":"GET, POST, PUT, DELETE, OPTIONS",
                            //"Host":"http://hn-obpm-qa-1.bcie.org",
                            //"Access-Control-Allow-Credentials":true,
                            //"Access-Control-Allow-Methods": "GET, POST, PUT, DELETE, OPTIONS"
                        },
                        data: $.param(body)
                    }).done(function(e, o, n) {
                        console.log("response");
                        var responsebody;
                        //console.log("e", e);
                        //console.log("o", o);
                        //console.log("n", n);
                        responsebody = "object" == typeof e ? e : JSON.parse(e);   
                        console.log('resultado ws bitacora :'+responsebody.mensaje);
                    }).fail(function(t, e, o) {
                        //console.log("e", e);
                        //console.log("t", t);
                        //console.log("o", o);
                        console.log("Se ha detectado un problema en el servicio, de bitacora.");
                    })
            }
            /**getOperacionesHistorial: function(t) {
                var e = this;
                var historial = true;
                var apCliente = false;
                $.ajax({
                    url: endPoint.point().voto.get,
                    type: "get",
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        "Content-Type": "text/plain; charset=utf-8"
                    },
                    data: {
                        Usuario: t,
                        historial: historial,
                        aprobacionCliente: apCliente
                    },
                    cache: !1
                }).done(function(t, o, n) {
                    var a;
                    a = "object" == typeof t ? t : JSON.parse(t), null !== a.Votaciones ? (storage.setLocal("votacionesHistorial", JSON.stringify(a.Votaciones)), e.redirect()) : (storage.setLocal("votacionesHistorial", JSON.stringify("1")), common.message("No existen votaciones asociadas al usuario por el momento."), common.modal("show"))
                }).fail(function(t, e, o) {
                    common.message("Se ha detectado un problema en el servicio, favor de intentar nuevamente."), common.modal("show")
                })
            }
            getOperacionesSCR: function(t) {
                var e = this;
                var historial = true;
                var apCliente = true;
                $.ajax({
                    url: endPoint.point().voto.get,
                    type: "get",
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        "Content-Type": "text/plain; charset=utf-8"
                    },
                    data: {
                        Usuario: t,
                        historial: historial,
                        aprobacionCliente: apCliente
                    },
                    cache: !1
                }).done(function(t, o, n) {
                    var a;
                    a = "object" == typeof t ? t : JSON.parse(t), null !== a.Votaciones ? (storage.setLocal("votacionesSCR", JSON.stringify(a.Votaciones)), e.redirect()) : (storage.setLocal("votacionesSCR", JSON.stringify("1")), common.message("No existen votosSCR asociadas al usuario por el momento."), common.modal("show"))
                }).fail(function(t, e, o) {
                    common.message("Se ha detectado un problema en el servicioSCR, favor de intentar nuevamente."), common.modal("show")
                })
            },
            getOperacionesHistorialSCR: function(t) {
                var e = this;
                var historial = true;
                var apCliente = true;
                $.ajax({
                    url: endPoint.point().voto.get,
                    type: "get",
                    headers: {
                        Accept: "application/json; charset=utf-8",
                        "Content-Type": "text/plain; charset=utf-8"
                    },
                    data: {
                        Usuario: t,
                        historial: historial,
                        aprobacionCliente: apCliente
                    },
                    cache: !1
                }).done(function(t, o, n) {
                    var a;
                    a = "object" == typeof t ? t : JSON.parse(t), null !== a.Votaciones ? (storage.setLocal("votacionesHistorialSCR", JSON.stringify(a.Votaciones)), e.redirect()) : (storage.setLocal("votacionesHistorialSCR", JSON.stringify("1")), common.message("No existen votaciones asociadas al usuario por el momento."), common.modal("show"))
                }).fail(function(t, e, o) {
                    common.message("Se ha detectado un problema en el servicio, favor de intentar nuevamente."), common.modal("show")
                })
            }**/
        }, {
            init: function(e) {
                t.initialize(e)
            }
        }
    }(loginController);
$(document).ready(function() {
    loginController.init("#loginAccess")
});