package org.bcie.fenix.common.model.vo;

import com.bcie.xmlns.operacionservice.Operacion12BndQSService;
import com.bcie.xmlns.operacionservice.Operacion12Port;

import java.math.BigDecimal;

import java.sql.ResultSet;
import java.sql.Timestamp;

import java.text.DateFormat;

import java.text.ParseException;
import java.text.SimpleDateFormat;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;

import java.util.Map;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.JboException;
import oracle.jbo.Key;
import oracle.jbo.NameValuePairs;
import oracle.jbo.Row;
import oracle.jbo.RowSetIterator;
import oracle.jbo.ViewCriteria;
import oracle.jbo.domain.Date;
import oracle.jbo.domain.Number;
import oracle.jbo.server.SequenceImpl;
import oracle.jbo.server.TransactionEvent;
import oracle.jbo.server.ViewObjectImpl;

import oracle.jbo.server.ViewRowImpl;
import oracle.jbo.server.ViewRowSetImpl;

import org.bcie.atributobo.NivelType;
import org.bcie.catalogobo.Catalogo;

import org.bcie.commonbo.MontoType;
import org.bcie.desembolso.DesembolsoPT;
import org.bcie.desembolso.DesembolsoPTSOAP12BindingQSService;
import org.bcie.desembolsobo.ContratoDesembolso;
import org.bcie.desembolsobo.EstimadoDesembolsoType;

import org.bcie.desembolsomo.AplicarCompensacionDesembolsoParametrosRequestType;
import org.bcie.desembolsomo.AplicarCompensacionDesembolsoRequestType;
import org.bcie.desembolsomo.AplicarCompensacionDesembolsoResponseType;
import org.bcie.desembolsomo.ConsultarDesembolsoBPELRequestType;
import org.bcie.desembolsomo.ConsultarDesembolsoBPELResponseType;
import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.am.FenixAMImpl;
import org.bcie.fenix.common.model.am.FenixGestorDesembolsosAMImpl;

import static org.bcie.fenix.common.model.FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO;
import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.am.FenixImplementacionPctAMImpl;
import org.bcie.fenix.common.model.am.FenixSeguimientoCrediticioAMImpl;
import org.bcie.fenix.common.model.utils.IWsdlLocation;
import org.bcie.fenix.common.model.utils.ModelUtils;
import org.bcie.fenix.common.model.vo.common.ContratoDesembolsoVO;
import org.bcie.operacionbo.Operacion;
import org.bcie.operacionmo.ConsultarOperacionByIdOperacionRequestType;
import org.bcie.operacionmo.ConsultarOperacionResponseType;
import org.bcie.reglatarea.ReglaTareaPT;
import org.bcie.reglatarea.ReglaTareaPTSOAP12BindingQSService;
import org.bcie.resultbo.Resultado;
// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Tue Aug 23 13:09:44 CDT 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class ContratoDesembolsoVOImpl extends ViewObjectImpl implements ContratoDesembolsoVO {

    private static ADFLogger logger = null;

    /**
     * This is the default constructor (do not remove).
     */
    public ContratoDesembolsoVOImpl() {
        if (logger == null) {
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }

    public Long crearContratoDesembolso(Long idOperacion, Long idSolicitud, Long idLineaCredito, String loginUsuario, Integer tarea) {
        logger.warning("*Inf, Inicia metodo crearContratoDesembolso parametros recibidos");
        logger.warning("*Inf, idOperacion: " + idOperacion);
        logger.warning("*Inf, idSolicitud: " + idSolicitud);
        logger.warning("*Inf, idLineaCredito: " + idLineaCredito);
        logger.warning("*Inf, usuario: " + loginUsuario);
        logger.warning("*Inf, tarea: " + tarea);
        
        Boolean resultado = Boolean.FALSE;
        Integer idTipoMoneda = null;
        Long idContratoDesembolsoLong = null;
        Integer estadoDesembolso=ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO;       
                        
        if (null == idOperacion || null == idSolicitud || null == idLineaCredito || null == loginUsuario|| null == tarea ) {
            logger.warning("***Error no se recibieron todos los parametros solicitados.");
            return idContratoDesembolsoLong;
        }
        
        if(tarea.compareTo(FenixModelConstants.ID_REALIZAR_AJUSTES_ASIGNACION)==0){
            logger.warning("el desembolso se cambia a  estado validacion de recursos");
            estadoDesembolso=FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_VALIDACION_RECURSOS;
         }
          
        FenixAMImpl fenixAMImpl = null;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        Map mapaDatosFondo = new HashMap();
        Long idLinea = idLineaCredito;
        String idFondoLinea = null;
        //Valida que el idOperacion es NULL
        //Retorna FALSE en caso de ser NULL
       
        Row row = null;
        oracle.jbo.domain.Number idContratoDesembolso = null;
        SequenceImpl seqContratoDesembolso = null;
        
        try {            
            logger.warning("*Inf, Creando nuevo id de contrato con un estado: "+estadoDesembolso);
            seqContratoDesembolso = new SequenceImpl("CONTRATO_DESEMBOLSO_SEQ", getDBTransaction());
            idContratoDesembolso = seqContratoDesembolso.getSequenceNumber();
            logger.warning("*Inf, sequence generado: " + idContratoDesembolso);
        } catch (Exception e) {
            logger.warning("***Error al crear el id del contrato ", e);
            new JboException(e);
            return idContratoDesembolsoLong;
        }
        idContratoDesembolsoLong = new Long(idContratoDesembolso.longValue());

        NameValuePairs nvpContrato = new NameValuePairs();
        nvpContrato.setAttribute("Id", idContratoDesembolsoLong);
        nvpContrato.setAttribute("IdTcaEstado", estadoDesembolso);
        nvpContrato.setAttribute("FechaRegistro", new Date().getCurrentDate());
        nvpContrato.setAttribute("BanEstatus", 1);
        nvpContrato.setAttribute("LoginUsuario", loginUsuario);

        row = createAndInitRow(nvpContrato);
        if(null == row){
            logger.warning("El row a insertar es NULL");
            idContratoDesembolsoLong = null;
        }else{
            insertRow(row);
            fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
            Boolean respuesta = Boolean.FALSE;
            if (null != fenixAMImpl) {
                try{
                    gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();                                 
                    respuesta = gestorDesembolsosAMImpl.getTreSolicitudLineaCreditoConsultaVO().crearRegistroTreeSolicitudLineaCredito(idSolicitud, idLineaCredito, idContratoDesembolsoLong);
                  }catch(Exception e){
                      new JboException(e);
                  }
                                  
                if(!respuesta){                   
                   idContratoDesembolsoLong = null;
                 }
             }
            
            
        }
        logger.warning("Termina metodo crearContratoDesembolso");
        return idContratoDesembolsoLong;
    }

    public Integer obtenerTipoMonedaMontoFormalizado(Long idOperacion) {
        logger.warning("Inicia metodo obtenerTipoMonedaMontoFormalizado");
        Integer idTipoMoneda = null;

        FenixAMImpl fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();

        if (null != fenixAMImpl) {
            idTipoMoneda = fenixAMImpl.getTccTerminoVO().obtenerTipoMonedaMontoFormalizado(idOperacion);

            if (null == idTipoMoneda) {
                logger.warning("El idTipoMoneda es NULL");
            } else {
                logger.warning("El idTipoMoneda es: " + idTipoMoneda);
            }
        } else {
            logger.warning("La instancia de FenixAMImpl es NULL");
        }

        logger.warning("Termina metodo obtenerTipoMonedaMontoFormalizado");
        return idTipoMoneda;
    }

    @SuppressWarnings("unchecked")
    public Map precargaInformacionContrato(Number idLineaCredito, Long idOperacion) {
        logger.warning("Inicia metodo precargaInformacionContrato");
        Map mapaDatosPrecarga = new HashMap();
        FenixAMImpl fenixAMImpl = null;
        
        if (null == idLineaCredito || null == idOperacion) {
            logger.warning("Parametros requeridos son NULL");
            return mapaDatosPrecarga;
        }

        logger.warning("Instanciado el AM principal");
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        Integer idTipoMonedaOperacion = null;
        String idFondoLinea = null;
        String descripcionFondo = null;
        Map mapaDatosFondo = new HashMap();

        logger.warning("Obteniendo idTipoMoneda");
        idTipoMonedaOperacion = fenixAMImpl.getTccTerminoVO().obtenerTipoMonedaMontoFormalizado(idOperacion);
        if (null != idTipoMonedaOperacion) {
            logger.warning("IdTipoMonedaOperacion: " + idTipoMonedaOperacion);
        } else {
            logger.warning("IdTipoMonedaOperacion es NULL");
        }

        Long idLineaNumber = new Long(idLineaCredito.longValue());
        mapaDatosFondo = fenixAMImpl.getConsultarLineaCreditoDesembolsoVO().obtenerFondoLinea(idLineaNumber);
        if (null != mapaDatosFondo) {
            idFondoLinea = (String) mapaDatosFondo.get("idFondo");
            if (null != idFondoLinea) {
                logger.warning("El Fondo obtenido es: " + idFondoLinea);
            } else {
                logger.warning("Se obtuvo un Fondo NULL");
            }

            descripcionFondo = (String) mapaDatosFondo.get("descripcionFondo");
            if (null != descripcionFondo) {
                logger.warning("La descripcion del Fondo obtenido es: " + descripcionFondo);
            } else {
                logger.warning("Se obtuvo una descripcion de Fondo NULL");
            }
        }        

        logger.warning("Valores de precarga por Default");
        logger.warning("IdTipoMoneda: " + idTipoMonedaOperacion);
        logger.warning("IdFondoLineaCredito: " + idFondoLinea);
        logger.warning("descripcionFondoLineaCredito: " + descripcionFondo);

        mapaDatosPrecarga.put("idTipoMoneda", idTipoMonedaOperacion);
            mapaDatosPrecarga.put("idFondo", idFondoLinea);
        mapaDatosPrecarga.put("descripcionFondo", descripcionFondo);

        logger.warning("Termina metodo precargaInformacionContrato");
        return mapaDatosPrecarga;
    }

    @SuppressWarnings("unchecked")
    public Map precargarContratoPorIdContrato(Long idContrato, Number idLineaCredito, Long idOperacion, Integer idTarea, Long idSolicitud) {
        logger.warning("Inicia metodo precargarContratoPorIdContrato");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        
        Row contratoDesembolsosRow = null;
        FenixAMImpl fenixAMImpl = null;
        String idFondoLinea = null;
        String idFondoContrato = null;
        String descripcionFondo = null;
        Integer idTipoMoneda = null;
        Integer idEstadoContrato = null;
        BigDecimal montoDisponible = null;
        Map mapaDatosDesembolso = new HashMap();
        Map mapaTasasMontosEnDesembolso = new HashMap();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        Row rowDetalleDesembolsoOperacion = null;
        ViewCriteria vc = null;
        
        if (null != idContrato) {
            contratoDesembolsosRow = obtenerContratoPorId(idContrato);
            if(getEstimatedRowCount() > 0){
                if (null != contratoDesembolsosRow) {
                    Long idContratoActivo = null;
                    
                    fenixAMImpl = (FenixAMImpl) getRootApplicationModule();
                    
                    if (null != idLineaCredito) {
                        if (null != fenixAMImpl) {                    
                            gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
                            idContratoActivo = gestorDesembolsosAMImpl.getConsultarContratoTreSolicitudLineaCreditoVO().obtenerPrimerContratoActivo(idSolicitud);
                                                        
                            setCurrentRow(contratoDesembolsosRow);
                            logger.warning("El id del currentRow: " + getCurrentRow().getAttribute("Id"));
                            
                            if(null != contratoDesembolsosRow.getAttribute("MontoDesembolsar") &&
                               null != contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda") &&
                               null != contratoDesembolsosRow.getAttribute("Fondo") &&
                               null != contratoDesembolsosRow.getAttribute("FechaEstimadaDesembolsar")){
                                logger.warning("Consumiendo servicio para obtener el campo PROGRAMADO actualizado.");
                                obtenerDatosConsultarDesembolso(idContrato);
                            }else{
                                logger.warning("Datos requeridos para el servicio de consultarDesembolso son NULL.");
                            }
                            
                            try{
                                idEstadoContrato = (Integer) contratoDesembolsosRow.getAttribute("IdTcaEstado");
                                logger.warning("El contrato tiene un estado: " + idEstadoContrato);
                            }catch(Exception e){
                                logger.warning("No se pudo obtener el estado del contrato.");
                            }
            
                            logger.warning("Instanciando el fenixAMImpl");
                    
                            Long idLineaNumber = new Long(idLineaCredito.longValue());
                            mapaDatosDesembolso = fenixAMImpl.getConsultarLineaCreditoDesembolsoVO().obtenerFondoLinea(idLineaNumber);
                            if (null != mapaDatosDesembolso) {
                                
                                if(null != idContratoActivo){
                                    
                                    if(idContrato.compareTo(idContratoActivo)==0){
                                        mapaDatosDesembolso.put("monedaSoloLectura", Boolean.FALSE);
                                    }else{
                                        mapaDatosDesembolso.put("monedaSoloLectura", Boolean.TRUE);
                                    }                            
                                    logger.warning("EsMonedaSOloLectura mapa: " + mapaDatosDesembolso.get("monedaSoloLectura"));
                                                                
                                    Row rowContratoActivo = null;
                                    logger.warning("Obtener registro de primer Contrato de la solicitud con estado activo");
                                    rowContratoActivo = consultarContratoPorId(idContratoActivo);
                                    if(null != rowContratoActivo){
                                        try{
                                            idTipoMoneda = (Integer) rowContratoActivo.getAttribute("IdTcaTipoMoneda");
                                            logger.warning("Inf, idTipoMoneda recuperado : "+idTipoMoneda);
                                        }catch(Exception e){
                                            logger.warning("ERROR al obtener IdTcaTipoMoneda ", e);
                                        }
                                        
                                        if(null != idTipoMoneda){
                                            logger.warning("Inf, seteando IdTcaTipoMoneda...");
                                            if(null == contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda")){
                                                //contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", idTipoMoneda);
                                                contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", idTipoMoneda);
                                            }else{
                                                try{
                                                    idTipoMoneda =
                                                        (Integer) contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda");
                                                }catch(Exception e){
                                                    logger.warning("ERROR al recuperar la moneda del contrato.", e);
                                                }
                                                logger.warning("IdTcaTipoMoneda de currentRow: " + idTipoMoneda);
                                                contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", idTipoMoneda);
                                            }
                                        }else{
                                            logger.warning("Inf, no se pudo recuperar el IdTcaMoneda se tomara por defecto USD ");
                                            //contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", FenixModelConstants.TIPO_MONEDA_USD);
                                            contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", FenixModelConstants.TIPO_MONEDA_USD);
                                        }
                                    }else{
                                        //contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", FenixModelConstants.TIPO_MONEDA_USD);
                                        contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", FenixModelConstants.TIPO_MONEDA_USD);
                                    }
                                }else{
                                    //Obtener el IdTipoMoneda a partir del Término 'Monto Formalizado'
                                    //En caso de ser NULL retorna el método FALSE
                                    idTipoMoneda = gestorDesembolsosAMImpl.getMonedaContratoVO1().monedaId(idSolicitud, idOperacion);
                                    if (null == idTipoMoneda) {
                                        logger.warning("El idTipoMoneda es NULL");
                                        //contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", FenixModelConstants.TIPO_MONEDA_USD);
                                        contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", FenixModelConstants.TIPO_MONEDA_USD);
                                    } else {
                                        logger.warning("El idTipoMoneda es: " + idTipoMoneda);
                                        logger.warning("IdTipoMoneda registrado en ROW de contrato: " + contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda"));
                                        if(null == contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda")){
                                            //contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", idTipoMoneda);
                                            contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", idTipoMoneda);
                                        }else{
                                            try{
                                                idTipoMoneda =
                                                    (Integer) contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda");
                                            }catch(Exception e){
                                                logger.warning("ERROR al recuperar la moneda del contrato.", e);
                                            }
                                            contratoDesembolsosRow.setAttribute("IdTcaTipoMonedaTransient", idTipoMoneda);
                                        }
                                    }
                                    mapaDatosDesembolso.put("monedaSoloLectura", Boolean.FALSE);
                                    logger.warning("EsMonedaSOloLectura mapa: " + mapaDatosDesembolso.get("monedaSoloLectura"));
                                }
                                
                                if (null != contratoDesembolsosRow.getAttribute("Fondo")) {
                                    idFondoContrato = (String) contratoDesembolsosRow.getAttribute("Fondo");
                                    logger.log(ADFLogger.WARNING,
                                               "El valor del fondo de contrato desembolso es. :" + idFondoContrato);
                                } else {
                                    logger.log(ADFLogger.WARNING, "El Fondo de contrato es nulo.");
                                }
                                
                                idFondoLinea = (String) mapaDatosDesembolso.get("idFondo");
                                if (null != idFondoContrato) {
                                    logger.log(ADFLogger.WARNING,
                                               "El valor del fondo de contrato es." + idFondoContrato);
                                    contratoDesembolsosRow.setAttribute("FondoTransient", idFondoContrato);
                                } else {
                                    if (null != idFondoLinea) {
                                        logger.warning("El Fondo obtenido es: " + idFondoLinea);
                                        //contratoDesembolsosRow.setAttribute("Fondo", idFondoLinea);
                                        contratoDesembolsosRow.setAttribute("FondoTransient", idFondoLinea);
                                    } else {
                                        logger.warning("Se obtuvo un Fondo NULL");
                                    }
                                }
                                
                                //Se calcula la fecha estimada de disponibilidad de recursos
                                obtenerFechaDisponibilidadRecPrecarga();
    
                                descripcionFondo = (String) mapaDatosDesembolso.get("descripcionFondo");
                                if (null != descripcionFondo) {
                                    logger.warning("La descripcion del Fondo obtenido es: " + descripcionFondo);
                                } else {
                                    logger.warning("Se obtuvo una descripcion de Fondo NULL");
                                }
                                
                                montoDisponible = null;
                                if (null != mapaDatosDesembolso.get("montoDisponible")) {
                                    montoDisponible = new BigDecimal(mapaDatosDesembolso.get("montoDisponible").toString());
                                }
                                
                                if(null != montoDisponible){
                                    logger.warning("MontoDisponible de la linea: " + montoDisponible);
                                }else{
                                    logger.warning("Monto disponible de la linea es NULL.");
                                }
                                                            
                                rowDetalleDesembolsoOperacion = gestorDesembolsosAMImpl.getDetalleDesembolsosOperacionVO().getCurrentRow();
                                if(null != rowDetalleDesembolsoOperacion){
                                    logger.warning("Recuperando datos de operacion y cliente:");
                                    try{
                                        logger.warning("Cuenta con la no objecion: " + rowDetalleDesembolsoOperacion.getAttribute("NoObjecion"));
                                        mapaDatosDesembolso.put("noObjecion", rowDetalleDesembolsoOperacion.getAttribute("NoObjecion").toString());
                                    }catch(Exception e){
                                        logger.warning("Error al añadir No Objecio a mapa");
                                    }
                                    
                                    try{
                                        logger.warning("SCR: " + rowDetalleDesembolsoOperacion.getAttribute("Scr"));
                                        mapaDatosDesembolso.put("scr", rowDetalleDesembolsoOperacion.getAttribute("Scr").toString());
                                    }catch(Exception e){
                                        logger.warning("Error al añadir SCR a mapa");
                                    }
                                    
                                    try{
                                        logger.warning("Mora: " + rowDetalleDesembolsoOperacion.getAttribute("Mora"));
                                        mapaDatosDesembolso.put("mora", rowDetalleDesembolsoOperacion.getAttribute("Mora").toString());
                                    }catch(Exception e){
                                        logger.warning("Error al añadir Mora a mapa");
                                    }
                                    
                                    try{
                                        logger.warning("Sector: " + rowDetalleDesembolsoOperacion.getAttribute("Sector"));
                                        mapaDatosDesembolso.put("sector", rowDetalleDesembolsoOperacion.getAttribute("Sector"));
                                    }catch(Exception e){
                                        logger.warning("Error al añadir Sector a mapa");
                                    }
                                }else{
                                    logger.warning("Row de DetalleDesembolsoOperacion es NULL.");
                                }
                            } else {
                                logger.warning("No se obtuvieron datos del Fondo de la Linea de credito: " + idLineaNumber);
                            }
                            if(null != idOperacion){
                                logger.warning("Invocando metodo obtenerTccTerminoEnDesembolsos con idOperacion: " + idOperacion);
                                mapaTasasMontosEnDesembolso = fenixAMImpl.getTccTerminoVO().obtenerTccTerminoEnDesembolsos(idOperacion);
                                mapaDatosDesembolso.put("montoMaximo", mapaTasasMontosEnDesembolso.get("montoMaximo"));
                                mapaDatosDesembolso.put("montoMinimo", mapaTasasMontosEnDesembolso.get("montoMinimo"));
                                mapaDatosDesembolso.put("tasaMaxima", mapaTasasMontosEnDesembolso.get("tasaMaxima"));
                                mapaDatosDesembolso.put("tasaMinima", mapaTasasMontosEnDesembolso.get("tasaMinima"));
                                
                                logger.warning("Monto Maximo Desembolso: " + mapaTasasMontosEnDesembolso.get("montoMaximo"));
                                logger.warning("Monto Minimo Desembolso: " + mapaTasasMontosEnDesembolso.get("montoMinimo"));
                                logger.warning("Tasa Maxima Desembolso: " + mapaTasasMontosEnDesembolso.get("tasaMaxima"));
                                logger.warning("Tasa Minima Desembolso: " + mapaTasasMontosEnDesembolso.get("tasaMinima"));
                            }else{
                                logger.warning("El parametro idContrato es NULL. No se puede obtener informacion de Tasas y Montos Maximos y Minimos");
                            }
                            mapaDatosDesembolso.put("idEstadoContrato", idEstadoContrato);
                            logger.warning("idEstadoContrato: " + mapaTasasMontosEnDesembolso.get("idEstadoContrato"));
                        } else {
                            logger.warning("Instancia de fenixAMImpl es NULL");
                        }
                    } else {
                        logger.warning("El parametro idLineaCredito es NULL. No se puede obtener informacion de Fondo de Linea de credito");
                    }
                } else {
                    logger.warning("Row con idContrato: " + idContrato + "es NULL");
                }
            }else{
                logger.warning("No se encontraron registros con idContrato: " + idContrato);
            }
        } else {
            logger.warning("El parametro idContrato es NULL. No se puede obtener informacion de contratos.");
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/ 1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo precargarContratoPorIdContrato con una duracion de: "+tiempo+" segundos");
        return mapaDatosDesembolso;
    }
    
    public Row obtenerContratoPorId(Long idContrato){
        logger.warning("Inicia metodo obtenerContratoPorId.");      
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio        
        Row row = null;
        ViewCriteria criteria = null;
        
        if(null == idContrato){
            logger.warning("El idContrato es NULL");
            return row;
        }
        
        /* if(getRootApplicationModule().getTransaction() != null){
            logger.warning("El Modelo tiene transacciones pendientes: " + getRootApplicationModule().getTransaction().isDirty());    
        } */
        
        executeQuery();
        try{  
            logger.warning("Ejecutando criteria de busqueda de contrato.");
            criteria = this.getViewCriteriaManager().getViewCriteria("ContratoDesembolsoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            this.applyViewCriteria(criteria);
            this.executeQuery();
        
            logger.warning("Registros de contratos encontrados: " + getEstimatedRowCount());
            if(getEstimatedRowCount() > 0){
                row = first();
            }
        }catch(Exception e){
            logger.warning("ERROR al ejecutar el crietria ContratoDesembolsoVOCriteria.", e);
        }finally{
            //Eliminamos el ViewCriteria
            this.getViewCriteriaManager().removeApplyViewCriteriaName("ContratoDesembolsoVOCriteria");
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/ 1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo obtenerContratoPorId con una duracion de: "+tiempo+" segundos");
        return row;
    }
    
    /**
     *Metodo para consultar contrato por id ContratoDesembolsoQueryVO
     * @param idContrato
     * @return Row
     */
    public Row consultarContratoPorId(Long idContrato){
        logger.warning("Inicia metodo obtenerContratoPorId.2");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        Row row = null;
        ViewCriteria criteria = null; 
        
        FenixAMImpl fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl =
        (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
        
        if(null == idContrato){
            logger.warning("El idContrato es NULL");
            return row;
        }
        try{
            row = gestorDesembolsosAMImpl.getContratoDesembolsoQueryVO().obtenerContratoPorId(idContrato);
        }catch(Exception e){
            logger.warning("ERROR al ejecutar metodo para recuperarContrato.", e);
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/ 1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo consultarContratoPorId con una duracion de: "+tiempo+" segundos");
        return row;
    }

    public Boolean actualizarDatosContratoDesembolso() {
        logger.warning("Inicia metodo actualizarDatosContratoDesembolso");
        Boolean resultado = Boolean.FALSE;
        FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAM = null;
        Row row = null;
        row = getCurrentRow();

        logger.warning("Instanciando fenixGestorDesembolsosAM");
        try {
            fenixGestorDesembolsosAM = (FenixGestorDesembolsosAMImpl) this.getApplicationModule();

        } catch (Exception e) {
            logger.warning("Error al instanciar fenixGestorDesembolsosAM ", e);
        }
        
        if (null != fenixGestorDesembolsosAM) {
            logger.warning("Invocando guardado de Fuentes externas.");
            resultado =
                fenixGestorDesembolsosAM.getFuentesExternasContratoDesembolsoVO().guardarMontoDesembolsarFuentesExternas();
        } else {
            logger.warning("Instancia de fenixGestorDesembolsosAM es NULL");
        }

        if (null != row) {
            
            //Metodo para asignar OrigenTransferenciaCliente y CuentaCliente de Transient a EO
            asignarTransientCuentaClienteOrigenTransferencia();
            
            //Modificacion para prevenir el bloqueo de la tabla de LINEA_CREDITO por la referencia de View Link Accessor de LineaCreditoDesembolsosVO
            //ContratoDesembolsoVORowImpl contRow = (ContratoDesembolsoVORowImpl)row;
            //contRow.setLineaCreditoDesembolsosVO(null);
            
            logger.warning("IdContrato a actualizar: " + row.getAttribute("Id"));
            try {
                logger.warning("Realizando COMMIT para actualizar el contrato desembolso");
                getDBTransaction().commit();
                logger.warning("Commit realizado con exito");
                resultado = Boolean.TRUE;
            } catch (Exception e) {
                
                logger.warning("Reintentado Commit. " + e.getMessage());
                try{
                    this.getDBTransaction().commit();
                    logger.warning("Segundo commit realizado con exito");
                    resultado = Boolean.TRUE;
                }catch(Exception ex){
                    logger.warning("Ocurrió un problema al realizar el COMMIT: ", ex);
                    try{
                        this.getDBTransaction().rollback();
                        logger.warning("Rollback realizado con exito");
                        resultado = Boolean.TRUE;
                    }catch(Exception exr){
                        logger.warning("Ocurrió un problema al realizar el Rollback: ", exr);
                        resultado = Boolean.FALSE;
                    }
                }
            }
        } else {
            logger.warning("El registro para actualizar el contratoDesembolso es NULL");
            resultado = Boolean.FALSE;
        }

        logger.warning("Inicia metodo actualizarDatosContratoDesembolso");
        return resultado;
    }
    
    /**
     * Metodo para actulaizar el estado del contrato desembolsado a por liquidar
     * @param idContrato
     * @return esActualizado
     */
    public Boolean actualizarEstadoContratoAPorLiquidar(Long idContrato){
        logger.warning("Entra en actualizarEstadoContratoAPorValidar.");
        
        Boolean esActualizado = Boolean.TRUE;
        Row row = null;
        Integer idEstado = null;
        
        try{
            row = this.obtenerContratoPorId(idContrato);
            
            if(null != row){
                row.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_POR_LIQUIDAR);
                try{
                    this.getDBTransaction().commit();
                    idEstado = (Integer)row.getAttribute("IdTcaEstado");
                }catch(Exception e){
                    logger.warning("error en el primer commit :" + e.getMessage());
                    try{
                        getDBTransaction().commit();
                        logger.warning("Segundo commit realizado con exito");
                        idEstado = (Integer)row.getAttribute("IdTcaEstado");
                    }catch(Exception ex){
                        logger.warning("Ocurrió un problema al realizar el COMMIT: ", ex);
                        esActualizado = Boolean.FALSE;
                    }
                }
            }else{
                logger.warning("No se obtuvo registro con el id de contrato :" + idContrato);
            } 
            
        }catch(Exception e){
            //this.getDBTransaction().rollback();
            esActualizado = Boolean.FALSE;
            logger.warning("Error al actualizar estado a por liquidar.", e);
        }
        
        logger.warning("Se actualizo el registro." + esActualizado + "Con estado :" + idEstado);
        return esActualizado;
    }
    
    /**
     * Metodo para actulaizar el estado del contrato
     * @param idContrato
     * @return esActualizado
     */
    public Boolean estadoImplementacionDesembolso(Long idContrato, Integer estado){
        logger.warning("Entra en estadoImplementacionDesembolso.");
        Boolean esActualizado = Boolean.TRUE;
        Row row = null;
        Integer idEstado = null;
        
        try{
            row = this.obtenerContratoPorId(idContrato);
            
            if(null != row){
                logger.warning("Estado anterior : " + row.getAttribute("IdTcaEstado") + ", Estado nuevo : " + estado);
                row.setAttribute("IdTcaEstado", estado);
            }else{
                esActualizado = Boolean.FALSE;
                logger.warning("No se obtuvo registro con el id de contrato :" + idContrato);
            } 
            
        }catch(Exception e){
            esActualizado = Boolean.FALSE;           
            logger.warning("Error al actualizar el estado del contrato.", e);
        }
        
        logger.warning("Se actualizo el registro." + esActualizado + "Para el contrato : " + idContrato + "Con estado :" + estado);
        return esActualizado;
    }
    
    public Boolean commitDesembolso(){
            Boolean esActualizado = Boolean.TRUE;
            try{
                this.getDBTransaction().commit();
                logger.warning("commit exitoso");
            }catch(Exception e){
                logger.warning("error en commit :"+e);
                try{
                    this.getDBTransaction().commit();
                    logger.warning("segundo commit exitoso");
                }catch(Exception ex){
                    esActualizado = Boolean.FALSE;
                    logger.warning("Error en el segundo commit :", ex);
                }
            }
            return esActualizado;    
        }
    
    /**
     * Para un contrato de desembolso que no cuente con ningun proceso iniciado o terminado se realiza una eliminacion 
     * fisica de lo contratio si ceunta con almenos un proceso iniciado el estado del contrato desembolso cambia a 
     * "Desestimado" y se guarda como historico 
     * 
     * @param idContrato
     * @return TRUE = fallo durante el desestimado 
     * @since 14/09/2016
     */
    public boolean desestimarContratoDesembolso(Long idContrato){
        logger.log(ADFLogger.WARNING, "Inside desestimarContratoDesembolso" + idContrato);
        
        boolean error = Boolean.TRUE;
        Row row = null;
        ViewCriteria criteria = null;
        Integer idTcaEstado = null;
        Long idContratoOnTreSolicitud = null;
        Row rowTreSolicitud = null;
        FenixAMImpl fenixAMImpl = null;
        
        //Si el idContrato viene null retornamos false y no se elimana nada.
        if(null == idContrato){
            logger.log(ADFLogger.WARNING, "El IdContrato NULL");
            return true;
        }
        try{
            fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
            FenixGestorDesembolsosAMImpl gestorDesembolsoAMImpl =
            (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
            rowTreSolicitud = gestorDesembolsoAMImpl.getTreSolicitudLineaCreditoVO().getTreSolicitudLineaCredito(idContrato);
            if(rowTreSolicitud != null){
                idContratoOnTreSolicitud = (Long) rowTreSolicitud.getAttribute("IdContratoDesembolso");                
            }
            
            criteria = this.getViewCriteriaManager().getViewCriteria("ContratoDesembolsoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            this.applyViewCriteria(criteria);
            this.executeQuery();
            
            //Vamos por el Row del contrato
            if(this.getEstimatedRangePageCount() > 0){
                this.setCurrentRow(first());
                row = this.getCurrentRow();
                logger.log(ADFLogger.WARNING, "Contrato seleccionado con id: " + idContrato);
                idTcaEstado = (Integer) row.getAttribute("IdTcaEstado");
                
                //Vamos y consultamos el TcaEstado si esta en Creado se Elimina el registro en otro caso se actualisa
                if(idTcaEstado.equals(FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO)){
                    logger.log(ADFLogger.WARNING, "<* ID contrato a Eliminar " + idContrato + " *>");
                    rowTreSolicitud.remove();
                    row.remove();
                    try{
                        this.getDBTransaction().commit();
                        error = Boolean.FALSE;
                        logger.warning("commit exitoso");
                    }catch(Exception e){
                        logger.warning("error en commit :"+e);
                        try{
                            this.getDBTransaction().commit();
                            error = Boolean.FALSE;
                            logger.warning("segundo commit exitoso");
                        }catch(Exception ex){
                            logger.warning("error en segundo commit :"+ex);
                        }
                    }
                }else{
                    logger.log(ADFLogger.WARNING, "<* ID contrato a Desestimado " + idContrato + " *>");
                    row.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO);
                    try{
                        this.getDBTransaction().commit();
                        error = Boolean.FALSE;
                        logger.warning("commit exitoso");
                    }catch(Exception e){
                        logger.warning("error en commit :"+e);
                        try{
                            this.getDBTransaction().commit();
                            error = Boolean.FALSE;
                            logger.warning("segundo commit exitoso");
                        }catch(Exception ex){
                            logger.warning("error en segundo commit :"+ex);
                        }
                    }
                }
            }else{
                logger.log(ADFLogger.WARNING, "Row de Contrato Null o bacio");   
            }            
        }catch(Exception ex){
            logger.log(ADFLogger.WARNING, "Problemas al recuperar el Contrato para eliminar" + ex);
        }
        
        //Eliminamos el ViewCriteria y retornamos el valor: true si la operacion fue exitosa de lo contrario false.
        this.getViewCriteriaManager().removeApplyViewCriteriaName("ContratoDesembolsoVOCriteria");
        return error;
    }
    
    /**
     * Vamos por los contratos en ESTADO 'Creado' y los desestimamos haciendo un upDate en el campo TcaEstado a 
     * desestimado siempre y cuando cumplan la condicion de IdTcaEstado = 10.
     * 
     * @return TRUE si la operacion desestimo contratos / False si se presento algun error.
     * @since 15/09/2016
     */
    public Boolean desestimarContratosEnCascada(){
        logger.log(ADFLogger.WARNING, "Inside desestimarContratosEnCascada");
        boolean esDesestimado = Boolean.FALSE;
        Row[] rowContratos = null;
        Integer tcaEstado = null;
        Long idContrato = null;
        Integer idTcaEstado = (Integer) FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO;
        
        try{
            rowContratos = this.getAllRowsInRange();
            if(rowContratos.length > 0){
                for(int i=0; i < rowContratos.length; i++){
                    tcaEstado = (Integer) rowContratos[i].getAttribute("IdTcaEstado");
                    idContrato = (Long) rowContratos[i].getAttribute("Id");
                    //Comprobamos si el TcaEstato es creado, de no ser asi retornamos false
                    if(tcaEstado.equals(idTcaEstado)){
                        rowContratos[i].setAttribute("IdTcaEstado", 
                                                     FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO); 
                        rowContratos[i].setAttribute("BanEstatus", 0);
                        esDesestimado = Boolean.TRUE;
                    }else{
                        logger.log(ADFLogger.WARNING, "El ESTADO del Contrato con ID: " + idContrato + 
                                                      " es diferente a Creado, Estado: "+ tcaEstado);
                        esDesestimado = Boolean.FALSE;
                        //this.getDBTransaction().rollback();
                        return esDesestimado;
                    }                   
                }
                logger.log(ADFLogger.WARNING, "Fin del FOR para desestimar contratos esDesestimado >> "
                                              + esDesestimado);
            }            
        }catch(Exception e){
            logger.warning("Ocurrio un error *Desestimando* los contratos de desembolso" + e);
        }
        //TRUE si desestimo todos los contratos del Array de RowContratos
        return esDesestimado;
    }
    
    /**
     * Vamos y recorremos el array de Rows para comprobar que todos los contratos
     * esten en estado Creado deno ser asi retornamos False
     * 
     * @since 13/09/2016
     * @return Boolean
     */
    public Boolean verTcaEstadoContratosDesembnolso(){
        logger.log(ADFLogger.WARNING, "*INTO* verTccEstadoContratosDesembnolso");
        Boolean esValido = Boolean.FALSE;
        Integer constanTcaEstadoCreado = FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO;
        Integer tcaEstado = null;
        Row[] rowContratos = null;
        //Se consulta los contratos para revisar que esten en un estado Creado
        try{
            rowContratos = getAllRowsInRange();
            if(rowContratos != null){
                for(Row rowContrato:rowContratos){
                    tcaEstado = (Integer) rowContrato.getAttribute("IdTcaEstado");
                    if(tcaEstado.equals(constanTcaEstadoCreado)){
                        esValido = true;
                        logger.log(ADFLogger.WARNING, "*idTcaEstadoContratoDesembolso: "+tcaEstado + " Es: " + esValido);
                    }else{
                        return false;
                    }               
                }
            }else{
                logger.log(ADFLogger.WARNING, "Row[] de Contratos NUll");
            }
        }catch(Exception ex){
            logger.warning("Error al consultar TcaEstado del contrato", ex);
        }
        return esValido;
    }
    
    public String obtenerCodigoBHQClientePorIdOperacion(Long idOperacion){
        logger.warning("Inicia metodo obtenerCodigoBHQClientePorIdOperacion");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        
        String codigoBHQCliente = null;
        
        if(null == idOperacion){
            logger.warning("Parametro idOperacion requerido es NULL");
            return null;
        }
        
        logger.warning("IdOperacion: " + idOperacion);
        FenixAMImpl fenixAM = null;
        fenixAM = (FenixAMImpl)this.getRootApplicationModule();
            
        String wsdl = fenixAM.getWsdl(IWsdlLocation.OPERACION);
        com.bcie.xmlns.operacionservice.Operacion12BndQSService operacion12BndQSService = IWsdlLocation.Service.getInstance(
                                                        Operacion12BndQSService.class, wsdl);
        Operacion12Port operacion12Port = operacion12BndQSService.getOperacion12BndQSPort();
        ConsultarOperacionByIdOperacionRequestType request = new ConsultarOperacionByIdOperacionRequestType();
        ConsultarOperacionResponseType response = null;
        request.setIdOperacion(idOperacion);
        request.setNivelDetalle(NivelType.OPERACION);
        request.setInfoDetalleCliente(Boolean.TRUE);
        
        try{
            java.util.Date horaInicio = ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_CONSULTAR_OPERACION_DESEMBOLSOS);
            response = operacion12Port.consultarOperacionByIdOperacion(request);
            ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_CONSULTAR_OPERACION_DESEMBOLSOS, horaInicio);
        }catch(Exception e){
            logger.warning("ERROR al ejecutar servicio consultarOperacionByIdOperacion ", e);
        }
        
        if(null != response){
            if(response.getResultado().getResult().value() == "OK"){
                logger.warning("Respuesta del servicio OK. Obteniendo idCliente y BHQ del cliente");
                if(null != response.getOperacion()){
                    for(Operacion operacion : response.getOperacion()){
                        if(null != operacion.getCliente()){
                            codigoBHQCliente = operacion.getCliente().getIdFacturador();
                        }else{
                            logger.warning("Objeto Cliente del servicio consultarOperacionByIdOperacion");
                        }
                    }
                }else{
                    logger.warning("El objeto Operacion del servicio consultarOperacionByIdOperacion");
                }
            }else{
                logger.warning("El response del servicio consultarOperacionByIdOperacion devuelve errores");
            }
        }
        
        Row row=getCurrentRow();
        if(null!=row){
            if(null!= codigoBHQCliente){
            row.setAttribute("BHQCliente", codigoBHQCliente);
            logger.warning("Se agrega al current row el bhq del cliente: "+ codigoBHQCliente);
            }    
        }
        logger.warning("EL codigo BHQ del cliente: " + codigoBHQCliente);
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo obtenerCodigoBHQClientePorIdOperacion con una duracion de: "+tiempo+" segundos");
        return codigoBHQCliente;
    }
    
    public String obtenerDescripcionMoneda(){
        logger.warning("Inicia metodo obtenerDescripcionMoneda");
        String descripcionMoneda = null;
        Integer idTipoMoneda = null;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        FenixAMImpl fenixAMImpl = null;
        Row row = null;
        
        row = getCurrentRow();
        
        if(null != row){
            try{
                idTipoMoneda = (Integer) row.getAttribute("IdTcaTipoMoneda");
            }catch(Exception e){
                logger.warning("ERROR al obtener el idTipoMoneda de CurrentRow");
            }
        }else{
            logger.warning("CurrentRow de contrato para obtener");
        }
        
        logger.warning("IdTipoMoneda: " + idTipoMoneda);
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        if(null != fenixAMImpl){
            gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
            if(null != gestorDesembolsosAMImpl){
                descripcionMoneda = gestorDesembolsosAMImpl.getTcaTipoMonedaVO().obtenerDescripcionMoneda(idTipoMoneda);
            }else{
                logger.warning("La instancia del GestorDesembolsosAMImpl es NULL");
            }
        }else{
            logger.warning("La instancia del FenixAMImpl es NULL");
        }
        row.setAttribute("DescripcionMoneda", descripcionMoneda);
                
        logger.warning("DescripcionMoneda : " + descripcionMoneda);        
        logger.warning("Termina metodo obtenerDescripcionMoneda");
        return descripcionMoneda;
    }
    
    
    public Map obtenerDatosMoneda(Long idDesembolso){
        logger.warning("Inicia metodo obtenerDescripcionMoneda");
        String descripcionMoneda = null;
        Integer idTipoMoneda = null;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        FenixAMImpl fenixAMImpl = null;
        Row row = null;
        HashMap datosMoneda = new HashMap();        
        row = getCurrentRow();
        
        if(null != row){
            try{
                idTipoMoneda = (Integer) row.getAttribute("IdTcaTipoMoneda");
            }catch(Exception e){
                logger.warning("ERROR al obtener el idTipoMoneda de CurrentRow");
            }
        }else{
            logger.warning("no hay un current de contrato para obtener los datos de la moneda");
            logger.warning("estableciendo contrato: "+idDesembolso+" como current");
            
            
                Row rowDesembolso = (Row)obtenerContratoPorId(idDesembolso);
                
                if(rowDesembolso != null){
                   setCurrentRow(rowDesembolso);
                    try{
                        idTipoMoneda = (Integer) rowDesembolso.getAttribute("IdTcaTipoMoneda");
                    }catch(Exception e){
                        logger.warning("ERROR al obtener el idTipoMoneda de CurrentRow");
                    }
                }            
        }
        
        logger.warning("IdTipoMoneda: " + idTipoMoneda);
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        if(null != fenixAMImpl){
            gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
            if(null != gestorDesembolsosAMImpl){
                descripcionMoneda = gestorDesembolsosAMImpl.getTcaTipoMonedaVO().obtenerDescripcionMoneda(idTipoMoneda);
            }else{
                logger.warning("La instancia del GestorDesembolsosAMImpl es NULL");
            }
        }else{
            logger.warning("La instancia del FenixAMImpl es NULL");
        }
        row.setAttribute("DescripcionMoneda", descripcionMoneda);                    
        logger.warning("descripcionMoneda : " + descripcionMoneda);
        
        if(idTipoMoneda != null)
            datosMoneda.put("idTipoMoneda", idTipoMoneda);
        
        if(descripcionMoneda != null)
           datosMoneda.put("descripcionMoneda", descripcionMoneda);
        
        logger.warning("Termina metodo obtenerDescripcionMoneda");
        return datosMoneda;
    }
    
    public Boolean setBhqDescripcionMoneda(String bhqCliente, String descMoneda) {
        logger.warning("** Inicia metodo setBhqDescripcionMoneda");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        
        Boolean res = Boolean.FALSE;
        Row fila = getCurrentRow();

        if (bhqCliente != null && descMoneda != null) {

            if (fila != null) {
                fila.setAttribute("BHQCliente", bhqCliente);
                fila.setAttribute("DescripcionMoneda", descMoneda);
                res = Boolean.TRUE;
            } else {
                logger.warning("** Error, No hay un current en contrato desembolso");
            }

        } else {
            logger.warning("** Error, Los parametros esperados son null bhqCliente->" + bhqCliente + " descMoneda->" +
                           descMoneda);
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/1000; //Calculamos los milisegundos de diferencia
        logger.warning("** Termina metodo setBhqDescripcionMoneda con una duracion de: "+tiempo+" segundos");
        return res;
    }
    
    
    @SuppressWarnings("unchecked")
    public Map obtenerIdTcaTipoYDescripcionMoneda(){
        logger.warning("Inicia metodo obtenerIdTcaTipoYDescripcionMoneda");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        
        Map mapaDatos = new HashMap();
        String descripcionMoneda = null;
        Integer idTipoMoneda = null;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        FenixAMImpl fenixAMImpl = null;
        Row row = null;
        
        row = getCurrentRow();
        
        if(row  != null ){
            try{
                idTipoMoneda = (Integer) row.getAttribute("IdTcaTipoMoneda");
                logger.warning(" idTipoMoneda del contrato CurrentRow es ->"+idTipoMoneda);
            }catch(Exception e){
                logger.warning("ERROR al obtener el idTipoMoneda de CurrentRow");
            }
        }else{
            logger.warning("*** Error no hay un contrato desembolso como CurrentRow");
        }
        
        logger.warning("IdTipoMoneda: " + idTipoMoneda);
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        
        try{
            if(null != fenixAMImpl){
                gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
                if(null != gestorDesembolsosAMImpl){
                    descripcionMoneda = gestorDesembolsosAMImpl.getTcaTipoMonedaVO().obtenerDescripcionMoneda(idTipoMoneda);
                    
                    if(descripcionMoneda != null){
                        logger.warning("Asigna descripcion de la moneda a Atributo DescripcionMoneda del registro de Contrato");
                        row.setAttribute("DescripcionMoneda", descripcionMoneda);
                    }
                }else{
                    logger.warning("La instancia del GestorDesembolsosAMImpl es NULL");
                }
                logger.warning("DescripcionMoneda : " + descripcionMoneda); 
            }else{
                logger.warning("La instancia del FenixAMImpl es NULL");
            }
            
            mapaDatos.put("idTipoMoneda", idTipoMoneda);    
            mapaDatos.put("descripcionMoneda", descripcionMoneda);   
        }catch(Exception e){
            logger.warning("Ocurrió un error al asignar tipo y descripciond e la moneda.", e);
        }       
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo obtenerIdTcaTipoYDescripcionMoneda con una duracion de: "+tiempo+" segundos");
        return mapaDatos;
    }
    
    public Row getContratoSeleccionado(){
        logger.warning("Inicia metodo getContratoSeleccionado.");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio = System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio
        logger.warning("Se ejecuto nuevamente el query en getContratoSeleccionado.");
        //this.executeQuery();
        
        Row row = null;
        
        if(getCurrentRow() != null ){
            logger.warning("<|>>>> ---SeleccionandoRow en el modelo id->"+getCurrentRow().getAttribute("Id"));
            row = getCurrentRow();     
        }else{
            logger.warning("ERROR NO SE ENCONTRO UN CONTRATO CURRENT");
        }
        
        TFin = System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio)/1000; //Calculamos los milisegundos de diferencia            
        logger.warning("Termina metodo getContratoSeleccionado con una duracion de: "+tiempo+" segundos");
        return row;
    }
    
    public void verificarValidacionesContrato(){
        logger.warning("Inicia metodo verificarValidacionesContrato");
        
        FenixAMImpl fenixAM = null;
        fenixAM = (FenixAMImpl)this.getRootApplicationModule();
            
        String wsdl = fenixAM.getWsdl(IWsdlLocation.REGLA_TAREA);
        ReglaTareaPTSOAP12BindingQSService reglaTareaService =
            IWsdlLocation.Service.getInstance(ReglaTareaPTSOAP12BindingQSService.class, wsdl);
        
//        Operacion12Port operacion12Port = operacion12BndQSService.getOperacion12BndQSPort();
//        ConsultarOperacionByIdOperacionRequestType request = new ConsultarOperacionByIdOperacionRequestType();
//        ConsultarOperacionResponseType response = null;
//        request.setIdOperacion(idOperacion);
//        request.setNivelDetalle(NivelType.OPERACION);
//        request.setInfoDetalleCliente(Boolean.TRUE);
        
        ReglaTareaPT reglaTareaPort = reglaTareaService.getReglaTareaPTSOAP12BindingQSPort();
        
        
        logger.warning("Inicia metodo verificarValidacionesContrato");
    }
    
    public Boolean guardarMontoMonedaFechaEstimada(){
        logger.warning("Inicia metodo guardarMontoMonedaFechaEstimada");
        Boolean resultado = Boolean.FALSE;
        Long idContrato = null;
        Row row = null;
        
        row = getCurrentRow();
        
        if(null != row){
            logger.warning("Id de contrato a guardar: " + row.getAttribute("Id"));
           
            try{
                idContrato = (Long) row.getAttribute("Id");
            }catch(Exception e){
                logger.warning("Error al convertir el idCOntrato para volver a cargar el currentRow");
            }
            
            try{
                logger.warning("Realizando primer intento de  para guardar los datos del contrato.");
                getDBTransaction().commit();
                resultado = Boolean.TRUE;
            }catch(Exception e){
                logger.warning("fallo el primer intento de commit -> ", e);                
                
                try{
                    logger.warning("reintentando commit....");
                    getDBTransaction().commit();
                    resultado = Boolean.TRUE;
                }catch(Exception ea){
                    logger.severe("Error al realizar el segundo intento de commit ->", ea); 
                }
            }
        }else{
            logger.warning("ROW es NULL no se pudo guardar la informacion del contrato.");
        }
        
        logger.warning("Termina metodo guardarMontoMonedaFechaEstimada");
        return resultado;
    }
    
    public Map obtenerProgramadoDiasConfiguracionMoneda(){
        logger.warning("Inicia metodo obtenerProgramadoDiasCOnfiguracionMoneda");
        Row row = null;
        Long idContrato = null;
        Map mapaDatosContrato = new HashMap();
        Long tipoPlazo = null;
        Integer plazo = null;
        row = getCurrentRow();
        
        if(null != row){
            try{
                idContrato = (Long) row.getAttribute("Id");
            }catch(Exception e){
                logger.warning("Atributo ID de contrato no obtenido", e);
            }
            
            if (null != idContrato) {
                obtenerDatosConsultarDesembolso(idContrato);
                try {
                    tipoPlazo = (Long) row.getAttribute("FrecuenciaPlazoMoneda");
                } catch (Exception e) {
                    logger.warning("Error al obtener el tipoPlazo del mapa de datos contrato", e);
                }

                try {
                    plazo = (Integer) row.getAttribute("PlazoMoneda");
                } catch (Exception e) {
                    logger.warning("Error al obtener el plazo del mapa de datos contrato", e);
                }

                logger.warning("PLAZO: " + plazo);
                logger.warning("TIPO PLAZO: " + tipoPlazo);

                try {
                    obtenerFechaEstimadaDisponibilidadRecursos(tipoPlazo, plazo);
                } catch (Exception e) {
                    logger.warning("Error al ejecutar obtenerFechaEstimadaDisponibilidadRecursos");
                }
            } else {
                logger.warning("IDCONTRATO es NULL");
            }
            
            logger.warning("FechaEstimadaDisponibilidadRecursos: " + row.getAttribute("FechaEstimadaDisponibilidadRecursos"));
            logger.warning("Programado: " + row.getAttribute("Programado"));
        }else{
            logger.warning("EL currentRow es NULL");
        }
        
        logger.warning("Inicia metodo obtenerProgramadoDiasCOnfiguracionMoneda");
        return mapaDatosContrato;
    }
    
    public Map obtenerDatosConsultarDesembolso(Long idContrato) {
        logger.warning("Inicia metodo obtenerDatosConsultarDesembolso");
        double TInicio, TFin, tiempo; //Variables para determinar el tiempo de ejecución
        TInicio =
            System.currentTimeMillis(); //Tomamos la hora en que inicio el algoritmo y la almacenamos en la variable inicio

        Map mapaDatosDesembolso = new HashMap();
        FenixAMImpl fenixAM = null;
        ContratoDesembolso contratoDesembolso = null;
        EstimadoDesembolsoType estimadoDesembolso = null;
        Catalogo frecuencia = null;
        Long tipoFrecuencia = null;
        Integer plazo = null;
        Boolean programado = Boolean.FALSE;
        BigDecimal montoProgramado = null;
        Row row = null;
        DesembolsoPTSOAP12BindingQSService desembolsoService = null;
        DesembolsoPT desembolsoPT = null;
        ConsultarDesembolsoBPELRequestType request = null;
        ConsultarDesembolsoBPELResponseType response = null;
        
        FenixGestorDesembolsosAMImpl fenixGestorDesembolsoAM = (FenixGestorDesembolsosAMImpl) getApplicationModule();
        
        row = getCurrentRow();

        if (null == idContrato) {
            logger.warning("Parametro idContrato requerido es NULL");
            return null;
        }
        
        logger.warning("IdContrato: " + idContrato);
        fenixAM = (FenixAMImpl) this.getRootApplicationModule();
        String wsdl = fenixAM.getWsdl(IWsdlLocation.DESEMBOLSO);        
        try{
            desembolsoService =  IWsdlLocation.Service.getInstance(DesembolsoPTSOAP12BindingQSService.class, wsdl);
            desembolsoPT = desembolsoService.getDesembolsoPTSOAP12BindingQSPort();
            request = new ConsultarDesembolsoBPELRequestType();        
            request.setIdDesembolso(idContrato);
        }catch(Exception e){
            logger.warning("*Error, la definicion del WSDL_DESEMBOLSO no esta disponible ->",e);
            throw new JboException("ha ocurrido un error al consultar la definicion del WSDL_DESEMBOLSO no esta disponible");        
        }
                
        try {
            logger.warning("Ejecutando servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
            java.util.Date horaInicio =
                ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
            response = desembolsoPT.consultarDesembolso(request);
            ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO, horaInicio);
            logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO + " ejecutado correctamente");
        } catch (Exception e) {
            logger.warning("Error al ejecutar servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
            JboException ex = new JboException("");
            ex.addToExceptions(new Exception("Error al ejecutar servicio ConsultarDesembolso: " + e.getMessage()));
            fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", " Error al ejecutar servicio ConsultarDesembolso: " + e.getMessage());
            throw ex;
        }

        if (null != response) {
            if (null != response.getResultado()) {
                if (response.getResultado().getResult().value() == "OK") {
                    if (null != response.getContratoDesembolso()) {
                        contratoDesembolso = response.getContratoDesembolso();

                        logger.warning("Obteniendo atributo PROGRAMADO");
                        programado = contratoDesembolso.isProgramado();
                        logger.warning("Invocando metodo agregarProgramado");
                        agregarProgramadoRow(row, programado);

                        if (null != contratoDesembolso.getEstimadoDesembolso()) {
                            estimadoDesembolso = contratoDesembolso.getEstimadoDesembolso();
                            if (null != estimadoDesembolso.getFrecuencia()) {
                                frecuencia = estimadoDesembolso.getFrecuencia();
                                if (null != frecuencia.getId()) {
                                    tipoFrecuencia = frecuencia.getId();
                                } else {
                                    logger.warning("Importante! El atributo id de la Frecuencia del estimado desembolso es NULL");
                                }
                                
                                
                                plazo = estimadoDesembolso.getPlazo();
                                
                                if(plazo == null )
                                    logger.warning("Error, plazo por especificacion de la moneda es resuelto a null");
                                

                                logger.warning("Plazo de la moneda: " + plazo);
                                logger.warning("Frecuencia de la moneda: " + tipoFrecuencia);

                                logger.warning("Seteando valores de plazo de la moneda a mapa");
                                mapaDatosDesembolso.put("plazo", plazo);
                                mapaDatosDesembolso.put("tipoPlazo", tipoFrecuencia);
                                
                                try {
                                    row.setAttribute("PlazoMoneda", plazo);
                                    row.setAttribute("FrecuenciaPlazoMoneda", tipoFrecuencia);
                                } catch (Exception e) {
                                    logger.warning("ERROR al asignar plazo y tipoPlazo a ConsultarDatosContratoVO.", e);
                                    fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "ERROR al asignar plazo y tipoPlazo a ConsultarDatosContratoVO."+ e.getMessage());
                                }
                            } else {
                                logger.warning("Objeto Frecuencia de servicio Consultar desembolso es NULL");
                            }
                        } else {
                            logger.warning("Objeto EstimadoDesembolso de servicio Consultar desembolso es NULL");
                        }

                        if (contratoDesembolso.getMonto() != null) {
                            for (MontoType montoType : contratoDesembolso.getMonto()) {
                                if (null != montoType.getTipo()) {
                                    if (null != montoType.getTipo().getDescripcionCorta()) {
                                        //PROGRAMADO
                                        if (montoType.getTipo().getDescripcionCorta().equalsIgnoreCase("PROGRAMADO")) {
                                            if (montoType.getImporte() != null) {
                                                montoProgramado = montoType.getImporte();
                                                logger.warning("Monto " + montoType.getTipo().getDescripcionCorta() +
                                                               " ->" + montoType.getImporte());
                                            } else {
                                                logger.warning("El importe del monto programado es resuelto a NULL");
                                            }
                                        } else {
                                            logger.warning("No es un Monto PROGRAMADO.");
                                        }
                                    } else {
                                        logger.warning("La descripcion corta del Monto es NULL.");
                                    }
                                } else {
                                    logger.warning("El atributo TIPO es NULL.");
                                }
                            }

                            if (montoProgramado == null) {
                                logger.warning("El  atributto importe monto programado del objeto response es rsuelto a null");
                                montoProgramado = BigDecimal.ZERO;
                            }
                            mapaDatosDesembolso.put("montoProgramado", montoProgramado);
                            try{
                                row.setAttribute("MontoProgramadoMesVigente", montoProgramado);
                            }catch(Exception e){
                                logger.warning("ERROR al asignar montoProgramado a ConsultarDatosContratoVO.", e);
                                fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "ERROR al asignar montoProgramado a ConsultarDatosContratoVO."+ e.getMessage());
                            }
                        } else {
                            logger.warning("El atributo Monto del objeto response es resuelto a NULL");
                        }
                        
                        /*
                        row.setAttribute("MontoProgramadoMesVigente", new BigDecimal(50000.50));
                        */
                    } else {
                        logger.warning("Objeto ContratoDesembolso() de servicio Consultar desembolso es NULL");
                        fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "Objeto ContratoDesembolso() de servicio Consultar desembolso es NULL");
                    }
                } else {
                    logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO + " devuelve ERROR >> " +
                                   response.getResultado().getMessage());
                    JboException ex = new JboException("");
                    ex.addToExceptions(new Exception("Servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO +
                                                     " devuelve ERROR >> " + response.getResultado().getMessage()));
                    fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "Servicio ConsultarDesembolso devuelve errores "
                                                                                    +response.getResultado().getMessage());
                }
            } else {
                logger.warning("getResultado de servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO +
                               " es NULL.");
                JboException ex = new JboException("");
                ex.addToExceptions(new Exception("El objeto getResutado del servicio ConsultarDesembolso es NULL."));
                fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "El objeto getResutado del servicio ConsultarDesembolso es NULL.");
                throw ex;
            }
        } else {
            logger.warning("ERROR: Response es null.");
            JboException ex = new JboException("");
            ex.addToExceptions(new Exception("El response del servicio ConsultarDesembolso es NULL."));
            fenixGestorDesembolsoAM.getManejoDeErroresVO().agregarError("", "El response del servicio ConsultarDesembolso es NULL.");
            throw ex;
        }

        TFin =
            System.currentTimeMillis(); //Tomamos la hora en que finalizó el algoritmo y la almacenamos en la variable T
        tiempo = (TFin - TInicio) / 1000; //Calculamos los milisegundos de diferencia
        logger.warning("Termina metodo obtenerDatosConsultarDesembolso con una duracion de: " + tiempo + " segundos");
        return mapaDatosDesembolso;
    }
    
    
    /** Este metodo se creo para recuperar los atributos que se necesiten del servicio de consultarDesembolso
     *  por el momento solo se recuperan tres, si es necesario se puede recuperar otro sin afectar el funcioamiento 
     *  del los metodos ya aplicados
    */
    public Map consultarDesembolsoService(Long idContrato){
        logger.warning("Inf, inicia metodo consultarDesembolsoService");
            Map mapaDatosDesembolso = new HashMap();
            FenixAMImpl fenixAM = null;        
            ContratoDesembolso contratoDesembolso = null;
            EstimadoDesembolsoType estimadoDesembolso = null;
            ConsultarDesembolsoBPELRequestType request = null;
            ConsultarDesembolsoBPELResponseType response = null;
            Catalogo frecuencia = null;
            Long tipoFrecuencia = null;
            Integer plazo = null;
            Boolean programado = null;
            BigDecimal montoProgramado = null;
            
            if(null == idContrato){
              logger.warning("Parametro idContrato requerido es NULL");
              return null;
            }
            logger.warning("IdContrato: " + idContrato);            
            fenixAM = (FenixAMImpl)this.getRootApplicationModule();                
            String wsdl = fenixAM.getWsdl(IWsdlLocation.DESEMBOLSO);            
            DesembolsoPTSOAP12BindingQSService desembolsoService = null;
            DesembolsoPT desembolsoPT = null;
            
            try{
                desembolsoService = IWsdlLocation.Service.getInstance(DesembolsoPTSOAP12BindingQSService.class, wsdl);            
                desembolsoPT = desembolsoService.getDesembolsoPTSOAP12BindingQSPort();
            }catch(Exception e){ 
                logger.warning("*Error, la definicion del WSDL_DESEMBOLSO no esta disponible ->",e);
                throw new JboException("ha ocurrido un error al consultar la definicion del WSDL_DESEMBOLSO no esta disponible");
            }                    
            
            try{            
                request = new ConsultarDesembolsoBPELRequestType();                            
                request.setIdDesembolso(idContrato);
                
                logger.warning("Ejecutando servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
                java.util.Date horaInicio = ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
                response = desembolsoPT.consultarDesembolso(request);
                ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO, horaInicio);
                logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO + " ejecutado correctamente");
            } catch (Exception e) {
                logger.warning("Error al ejecutar servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO);
                JboException ex = new JboException("");
                ex.addToExceptions(new Exception("Error al ejecutar servicio ConsultarDesembolso: " + e.getMessage()));
                throw ex;
            }
            
            if(null != response){
                if (null != response.getResultado()) {
                    if (response.getResultado().getResult().value() == "OK"){
                        if(null != response.getContratoDesembolso()){
                             contratoDesembolso = response.getContratoDesembolso();
                             
                             logger.warning("Obteniendo atributo PROGRAMADO");
                             programado = contratoDesembolso.isProgramado();
                             logger.warning("Invocando metodo agregarProgramado");
                             agregarProgramado(programado);
                             
                             if(null != contratoDesembolso.getEstimadoDesembolso()){
                                 estimadoDesembolso = contratoDesembolso.getEstimadoDesembolso();
                                 if(null != estimadoDesembolso.getFrecuencia()){
                                     frecuencia = estimadoDesembolso.getFrecuencia();
                                     if(null != frecuencia.getId()){
                                         tipoFrecuencia = frecuencia.getId();
                                     }else{
                                         logger.warning("El atributo id de la Frecuencia del estimado desembolso es NULL");
                                     }        
                                     
                                     if(contratoDesembolso.getMonto() != null){
                                              for(MontoType montoType : contratoDesembolso.getMonto()){                                                                                                 
                                                    //PROGRAMADO
                                                          if(montoType.getTipo().getDescripcionCorta().equalsIgnoreCase("PROGRAMADO")){                                                              
                                                                 if(montoType.getImporte() != null){
                                                                     montoProgramado = montoType.getImporte();
                                                                       logger.warning("Inf, *Importante!  monto "+montoType.getTipo().getDescripcionCorta()+" ->"+montoType.getImporte()); 
                                                                   }else{
                                                                     logger.warning("Inf, *Importante! El importe del monto programado es resuelto a NULL"); 
                                                                   }
                                                           }                                                    
                                                 }
                                           
                                            if(montoProgramado == null)
                                               logger.warning("Inf, *Importante! El  atributto importe monto programado del objeto response es rsuelto a null");
                                            
                                        }else{
                                             logger.warning("Inf, *Importante! El atributo Monto del objeto response es resuelto a NULL");
                                         }
                                         
                                     
                                     plazo = estimadoDesembolso.getPlazo();
                                     
                                     logger.warning("Plazo de la moneda: " + plazo);
                                     logger.warning("Frecuencia de la moneda: " + tipoFrecuencia);
                                     
                                     logger.warning("Seteando valores de plazo de la moneda a mapa");
                                     mapaDatosDesembolso.put("plazo", plazo);
                                     mapaDatosDesembolso.put("tipoPlazo", tipoFrecuencia);
                                    
                                 }else{
                                    logger.warning("Objeto Frecuencia de servicio Consultar desembolso es NULL");
                                 }
                                     mapaDatosDesembolso.put("montoProgramado", montoProgramado); 
                             }else{
                                 logger.warning("Objeto EstimadoDesembolso de servicio Consultar desembolso es NULL");
                             }
                        }else{
                            logger.warning("Objeto ContratoDesembolso() de servicio Consultar desembolso es NULL");
                        }
                    }else {
                        logger.warning("Servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO + " devuelve ERROR >> " +
                                       response.getResultado().getMessage());
                    }
                } else {
                    logger.warning("getResultado de servicio " + FenixModelConstants.WSC_CONSULTAR_DESEMBOLSO + " es NULL.");
                }
            }else{
                logger.warning("ERROR: Response es null.");
            }
        
        logger.warning("Inf, inicia metodo consultarDesembolsoService");
        return mapaDatosDesembolso;
    }
    
    public void agregarProgramado(Boolean isProgramado){
        logger.warning("Inicia metodo agregarProgramado");
        logger.warning("ISPROGRAMADO: " + isProgramado);
        Row row = null; 

        row = getCurrentRow();
        
        if(null != row){
            logger.warning("Seteando el valor del atributo PROGRAMADO");
            if(null != isProgramado){
                if(isProgramado){
                    logger.warning("Atributo PROGRAMADO es TRUE");
                    row.setAttribute("Programado", 1);
                }else{
                    logger.warning("Atributo PROGRAMADO es FALSE");
                    row.setAttribute("Programado", 0);
                }
            }else{
                logger.warning("Atributo PROGRAMADO es NULL. Mostrara valor NO APLICA");
                row.setAttribute("Programado", null);
            }
        }else{
            logger.warning("El current row es NULL");
        }
        
        logger.warning("Termina metodo agregarProgramado");
    }
    
    public void agregarProgramadoRow(Row row, Boolean isProgramado){
        logger.warning("Inicia metodo agregarProgramado");
        logger.warning("ISPROGRAMADO: " + isProgramado);
        
        if(null != row){
            logger.warning("Seteando el valor del atributo PROGRAMADO");
            if(null != isProgramado){
                if(isProgramado){
                    logger.warning("Atributo PROGRAMADO es TRUE");
                    //row.setAttribute("Programado", 1);
                    row.setAttribute("ProgramadoTransient", 1);
                }else{
                    logger.warning("Atributo PROGRAMADO es FALSE");
                    //row.setAttribute("Programado", 0);
                    row.setAttribute("ProgramadoTransient", 0);
                }
            }else{
                logger.warning("Atributo PROGRAMADO es NULL. Mostrara valor NO APLICA");
                //row.setAttribute("Programado", null);
                row.setAttribute("ProgramadoTransient", null);
            }
        }else{
            logger.warning("El current row es NULL");
        }
        
        logger.warning("Termina metodo agregarProgramado");
    }
    
    public void obtenerFechaDisponibilidadRecPrecarga(){
       logger.warning("Inicia el metodo obtenerFechaDisponibilidadRecPrecarga");
       
       Row row = null;
       Integer plazo = null;       
       row = getCurrentRow();
        
        if(null != row){
            
         logger.warning("*Inf, Calculando fecha de disponibilidad de recursos");
                
                plazo = (null == row.getAttribute("PlazoMoneda")) ? null 
                      : (Integer) row.getAttribute("PlazoMoneda");                        
            
                try{
                    fechaMaxima(obtenerDescripcionMoneda(), plazo);
                }catch(Exception e){
                    logger.warning("***ERROR al ejecutar metodo fechaMaxima", e);
                }            
            
        }else{
            logger.warning("***Error, El CurrentRow de desembolso es NULL no se recuperara  fecha estimada de disponibilidad de recursos");
        }
        
        logger.warning("Termina metodo obtenerFechaDisponibilidadRecPrecarga");                
    }
    
    
    public void obtenerFechaEstimadaDisponibilidadRecursos(Long tipoPlazo, Integer plazo){
        logger.warning("Inicia metodo obtenerFechaEstimadaDisponibilidadRecursos");
        Row row = null;
        java.util.Date fechaEstimadaDesembolsar = null;
        DateFormat dateFormat = new SimpleDateFormat("dd/MM/yy");
        
        logger.warning("Plazo: " + plazo);
        logger.warning("TipoPlazo: " + tipoPlazo);
        
        row = getCurrentRow();
        
        if(null != row){
            try{
                fechaMaxima(obtenerDescripcionMoneda(), plazo);
            }catch(Exception e){
                logger.warning("ERROR al ejecutar metodo fechaMaxima", e);
            }
        }else{
            logger.warning("El CurrentRow es NULL no se recuperara la fecha estimada de disponibilidad de recursos");
        }
        
        logger.warning("Termina metodo obtenerFechaEstimadaDisponibilidadRecursos");
    }
    
    public void fechaMaxima(String descripcionMoneda, Integer dias) {
            logger.warning("Inicia metodo fechaMaxima.");
            logger.warning("*Inf, descripcionMoneda: "+descripcionMoneda);
            logger.warning("*Inf, dias por moneda: "+dias);
            
            
            if(descripcionMoneda == null || dias == null){
                logger.warning("*Inf, Important! parametros requeridos resueltos a NULL");
                logger.warning("*Inf, Important! No se recuperara la fecha estimada de disponibilidad de recursos");
                return;
            }
            
            Row row = null;
            row = getCurrentRow();
            List<java.util.Date> diasInhabiles = new ArrayList<java.util.Date>();
            int contadorDiasInhabiles = 0;
            FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAMImpl = null;
            java.util.Date fechaSistema = new java.util.Date();
            java.util.Date fechaPropuesta = null;
            java.util.Date fechaOriginal = null;
            java.util.Date fechapropuestaFinal = null;
            Calendar fechaInicial = Calendar.getInstance();
            Calendar fechaFinal = Calendar.getInstance();
                        
            SimpleDateFormat formatter = new SimpleDateFormat("dd/MM/yyyy");
            String fechaString = null;           
            Map fechasMap = new HashMap();
            oracle.jbo.domain.Date fechaRangoInicial = null;
            oracle.jbo.domain.Date fechaRangoFinal = null;
            
            //si existe fecha efectiva se tomara el valor de esta como fecha estimada de disponibilidad de recursos
            //si existe fecha de inicio de procedo se tomara el valor de esta como fecha estimada de disponibilidad de recursos
            //si no existe fecha efectiva ni fecha de incio de proceso se tomara la fecha del sistema                    
            
            Timestamp fechaefectiva = (null == row.getAttribute("FechaEfectiva")) ? null
                                     : (Timestamp)row.getAttribute("FechaEfectiva");
            
            Timestamp fechaIniProces = (null == row.getAttribute("FechaInicioProcesoDesem")) ? null
                                     : (Timestamp)row.getAttribute("FechaInicioProcesoDesem");
                        
            if(fechaefectiva != null){
                            
                logger.warning("*Inf, Ok se encontro fechaefectiva: "+fechaefectiva);
                row.setAttribute("FechaEstimadaDisponibilidadRecursos", fechaefectiva);
                
            }else{
                
                //Si ya se cuenta con Fecha de Inicio de proceso de desembolsos        
                if(fechaIniProces != null){                                                                           
                        logger.warning("*Inf, Ok se encontro fecha de inicio de proseso");
                        logger.warning("asignado: "+ fechaIniProces+" para calculo de fecha estimada de dispponibilidad de recursos");                           
                        Long fConvert = fechaIniProces.getTime();
                        fechaSistema = new java.util.Date(fConvert);
                }
                fechaOriginal=fechaSistema;
                
                fechasMap = recuperarFechasRangoParaDiasInhabilesDesembolsoVO(fechaSistema);
                fechaRangoInicial = (oracle.jbo.domain.Date)fechasMap.get("fechaInicial");
                fechaRangoFinal   = (oracle.jbo.domain.Date)fechasMap.get("fechaFinal");                            
                
                try{
                    fenixGestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) getApplicationModule();          
                    diasInhabiles = fenixGestorDesembolsosAMImpl.getDiasInhabilesDesembolsosVO().obtenerDiasInhabilesByMoneda(descripcionMoneda, fechaRangoInicial, fechaRangoFinal);
                    logger.warning("Lista dias: " + diasInhabiles.size());
                }catch(Exception e){
                    logger.warning("ERROR al ejecutar metodo obtenerDiasInhabilesMoneda", e);
                }
                       
                //le agregamos a la fecha del sistema los dias programados de la moneda
                Calendar fechaSistemaCalendar = Calendar.getInstance();
                fechaSistemaCalendar.setTime(fechaSistema);
                fechaSistemaCalendar.add(Calendar.DATE, dias);
                            
                fechaSistema = fechaSistemaCalendar.getTime();            
                logger.warning("*Inf, la fecha con los dias de la moneda agregados es:"+fechaSistema);
                
                // le damos formato a la fecha para quitarle el tiempo 
                try{
                  String strDate = formatter.format(fechaSistema);               
                  fechaPropuesta = formatter.parse(strDate);
                  fechapropuestaFinal =fechaPropuesta;
                }catch(Exception e){
                    logger.warning("ha ocurrido un error al recuperar la fecha del sistema: ",e);
                } 
                
                // le damos formato a la fecha para quitarle el tiempo fechaOriginal
                try{
                  String strDate2 = formatter.format(fechaOriginal);               
                  fechaOriginal = formatter.parse(strDate2);
                }catch(Exception e){
                    logger.warning("ha ocurrido un error al recuperar la fecha del sistema: ",e);
                } 
                int contador=0;
                Calendar fechaObtenida = Calendar.getInstance();
                java.util.Date fechaContador = null;
                Integer diasIncrementado=0;
                if(null!=dias){
                        diasIncrementado=dias;
                    }
                
                if (diasInhabiles != null) {
                                        
                        for (java.util.Date date : diasInhabiles) {
                            fechaObtenida = Calendar.getInstance();
                            for(int i=0; i<=diasIncrementado;i++){
                                    fechaObtenida.setTime(fechaOriginal);
                                    fechaObtenida.add(Calendar.DATE, i);
                                    fechaContador=fechaObtenida.getTime();
                                    //logger.warning("la fecha a comparar :" + fechaContador + " fecha inhabil : "+date);
                                if(fechaContador.compareTo(date)==0){
                                        contador=contador+1;
                                        logger.warning("COINCIDENCIA ENCONTRADA! :D la fechaPropuesta del rango:" +
                                                       fechaContador + " es igual a fecha inhabil : "+date);
                                        diasIncrementado=diasIncrementado+1;
                                        break;
                                    }
                                else{
                                        //logger.warning("COINCIDENCIA NO ENCONTRADA! :( la fechaPropuesta del rango:" + fechaContador + " no es igual a fecha inhabil : "+date);
                                    }
                                }
                        }
                        logger.warning("Dias a sumar a la fecha propuesta: " + contador);
                        if(contador>0){
                                Calendar fechaObtenidaFinal = Calendar.getInstance();
                                fechaObtenidaFinal.setTime(fechaPropuesta);
                                fechaObtenidaFinal.add(Calendar.DATE, contador);
                                fechapropuestaFinal=fechaObtenidaFinal.getTime();
                                }
                    logger.warning("Cambio de fecha inicalmente se tenia la fecha:" + fechaOriginal);
                    logger.warning("Agregando los plazos se obtiene la fecha : "+fechaPropuesta);
                    logger.warning("Fecha final obtenida: "+ fechapropuestaFinal);
                        
                        fechaFinal.setTime(fechapropuestaFinal);
                                            
                        logger.warning("*Inf, Fecha Final ->> " + fechaFinal.getTime());                
                }
                
                java.util.Date fecha = fechaFinal.getTime();
                try {                
                    fechaString = formatter.format(fecha);
                    fecha = formatter.parse(fechaString);
                } catch (ParseException e) {
                    e.printStackTrace();
                }
                
                try{
                    Timestamp timestamp = new java.sql.Timestamp(fecha.getTime());
                    row = getCurrentRow();
                    if(null != row){
                        logger.warning("Seteando FECHA ESTIMADA DE DISPONIBILIDAD DE RECURSOS");
                        row.setAttribute("FechaEstimadaDisponibilidadRecursos", timestamp);
                    }
                }catch(Exception e){
                    logger.warning("ERROR al convertir fecha a Timestamp", e);
                }
            
            }
            
            
            logger.warning("Fecha estimada disponibilidad recursos: " + row.getAttribute("FechaEstimadaDisponibilidadRecursos"));            
            logger.warning("dias inhabiles encontrados: "+contadorDiasInhabiles);
            logger.warning("Termina metodo fechaMaxima");
        }
    
    
    public Map recuperarFechasRangoParaDiasInhabilesDesembolsoVO(java.util.Date fechaSistema){
     logger.warning("*Inf, Inicia metodo cargarDiasInhabilesDesembolsoVO");            
        
        java.util.Date fechaFin = null;
        oracle.jbo.domain.Date fechaInicial = null;
        oracle.jbo.domain.Date fechaFinal = null;
        Map fechas = new HashMap();
                        
            Calendar cal = Calendar.getInstance();
            cal.setTime(fechaSistema);
            cal.add(Calendar.MONTH, 1);
            fechaFin = cal.getTime();
                                           
           try {                 
                  java.sql.Date sqlDate = new java.sql.Date(fechaSistema.getTime());
                  fechaInicial = new oracle.jbo.domain.Date(sqlDate); 
                  fechas.put("fechaInicial", fechaInicial);
            } catch (Exception e) {
                logger.warning("*Inf, Error al parsear fecha de util date a domain.Date");
                logger.warning("***Error no se recuperaran los dias inhabiles");                
            }
        
            try {                 
                   java.sql.Date sqlDate = new java.sql.Date(fechaFin.getTime());
                   fechaFinal = new oracle.jbo.domain.Date(sqlDate);
                   fechas.put("fechaFinal", fechaFinal);
             } catch (Exception e) {
                 logger.warning("*Inf, Error al parsear fecha de util date a domain.Date");
                 logger.warning("***Error no se recuperaran los dias inhabiles");                 
             }
                                    
     logger.warning("*Inf, Termina el metodo cargarDiasInhabilesDesembolsoVO");
     return fechas;
    }


    public void setAtributosACurrent(String OrigenTranferenciaCliente, String CuentaCliente) {
        Row row = null;

        if (getCurrentRow() != null) {
            logger.warning("SeleccionandoRow en el modelo id->" + getCurrentRow().getAttribute("Id"));
            row = getCurrentRow();
            
            logger.warning("Seteando origen de transferencia " + OrigenTranferenciaCliente + " y cuenta cliente " +
                            CuentaCliente + " a Contrato Current id->" + getCurrentRow().getAttribute("Id"));
            
            if (OrigenTranferenciaCliente != null) {
                row.setAttribute("OrigenTranferenciaClienteTransient", OrigenTranferenciaCliente);
            } else {
                logger.warning("*** Error, origen de la transferencua es NULL");

            }

            if (CuentaCliente != null) {
                row.setAttribute("CuentaClienteTransient", CuentaCliente);
            } else {
                logger.warning("*** Error, cuenta cliente es NULL");
            }
        } else {
            logger.warning("*** Error, No hay un current en contrato");
        }
    }

    /**
     * Returns the variable value for pIdContrato.
     * @return variable value for pIdContrato
     */
    public Long getpIdContrato() {
        return (Long) ensureVariableManager().getVariableValue("pIdContrato");
    }
    
    public boolean liquidarContratoFenix(String idContrato) {
        logger.entering(this.getClass().getName(), "actualizarEstadoPorContrato");
        boolean exito = Boolean.FALSE;
        
        if (null != idContrato) {
            ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            executeQuery();
            exito = actualizarEstado(idContrato, FenixModelConstants.ESTADO_SOLICITUD_LIQUIDADO);
        }
        
        logger.exiting(this.getClass().getName(), "actualizarEstadoPorContrato", exito);
        return exito;
    }
    
    public boolean liquidarContratoEnvioAlGasto(String idContrato) {
        logger.entering(this.getClass().getName(), "liquidarContratoEnvioAlGasto");
        logger.warning("Entra en liquidarContratoEnvioAlGasto");
        boolean exito = Boolean.FALSE;
        
        if (null != idContrato) {
            ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            executeQuery();
            exito = actualizarEstadoEnvioAlGasto(idContrato, FenixModelConstants.ESTADO_SOLICITUD_LIQUIDADO);
        }
        
        logger.exiting(this.getClass().getName(), "liquidarContratoEnvioAlGasto", exito);
        return exito;
    }
    
    public boolean contratoNoLiquidado(String idContrato) {
        logger.entering(this.getClass().getName(), "contratoNoLiquidado");
        logger.warning("Entra en contratoNoLiquidado");
        boolean exito = Boolean.FALSE;
        
        if (null != idContrato) {
            ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            executeQuery();
            exito = actualizarEstadoEnvioAlGasto(idContrato, FenixModelConstants.ESTADO_SOLICITUD_NOLIQUIDADO);
        }
        
        logger.exiting(this.getClass().getName(), "actualizarEstadoPorContrato", exito);
        return exito;
    }

    /**
     * Sets <code>value</code> for variable pIdContrato.
     * @param value value to bind as pIdContrato
     */
    public void setpIdContrato(Long value) {
        ensureVariableManager().setVariableValue("pIdContrato", value);
    }
    
    public Boolean actualizarEstado(String idContrato, Integer estado) {
        logger.warning("Entrando en actualizarEstado.");
        logger.warning("idContrato: " + idContrato);
        logger.warning("estado: " + estado);
        FenixAMImpl fenixAmImpl = (FenixAMImpl) getRootApplicationModule();
        
        Boolean resultado = Boolean.FALSE;
        try{
            logger.warning("Inicio fenixAmImpl.actualizarEstado");
            resultado = fenixAmImpl.actualizarEstado(idContrato, estado);
            logger.warning("resultado: " + resultado);
            logger.warning("Se ejecutara nuevamente el query para actualizar los datos");
            this.executeQuery();
            logger.warning("Fin fenixAmImpl.actualizarEstado"); 
        }
        catch(Exception exp)
        {
            logger.warning("Error actualizarEstado: " + exp);
        }/*
        try{
            logger.warning("Inicio fenixAmImpl.actualizarEstado para VO");
            Long contrato = Long.parseLong(idContrato);
            logger.warning("Contrato: " + contrato);
            logger.warning("Se obtendra el row mediante obtenerContratoPorId");
            Row row = this.obtenerContratoPorId(contrato);
            logger.warning("Se asignara el estado a IdTcaEstado");
            row.setAttribute("IdTcaEstado", estado);
            logger.warning("Fin fenixAmImpl.actualizarEstado para VO");
        }
        catch(Exception exp)
        {
            logger.warning("Error actualizarEstado para VO: " + exp);
        } */
        /*Long contrato = null;
        if (null != idContrato) {
            contrato = Long.parseLong(idContrato);
            Row row = gestorDesembolsosAMImpl.getContratoDesembolsoVO().obtenerContratoPorId(contrato);
            if (null != row) {
                logger.warning("Estado anterior " + row.getAttribute("IdTcaEstado"));
                if (null != estado) {
                    row.setAttribute("IdTcaEstado", estado);
                    try {
                        getDBTransaction().commit();
                        logger.warning("Commit realizado con exito");
                    } catch (Exception e) {
                        logger.warning("error en el primer commit: ", e);
                        try{
                            getDBTransaction().commit();
                            logger.warning("Segundo commit realizado con exito");
                        }catch(Exception ex){
                            logger.warning("error en el segundo ommit: ", ex);
                            resultado = Boolean.FALSE;
                        }
                    }
                } else {
                    resultado = Boolean.FALSE;
                }
            } else {
                logger.warning("El row del contrato es nulo.");
                resultado = Boolean.FALSE;
            }

        } else {
            resultado = Boolean.FALSE;
        }*/
        return resultado;
    }
    
    private Boolean actualizarEstadoEnvioAlGasto(String idContrato, Integer estado) {
        logger.warning("Entra en actualizarEstadoEnvioAlGasto.");
        logger.warning("idContrato: " + idContrato);
        logger.warning("estado: " + estado);
        
        Boolean resultado = Boolean.TRUE;
        Long contrato = null;
        if (null != idContrato) {
            contrato = Long.parseLong(idContrato);
            Row row = this.obtenerContratoPorId(contrato);
            if (null != row) {
                logger.warning("Estado anterior " + row.getAttribute("IdTcaEstado"));
                if (null != estado) {
                    row.setAttribute("IdTcaEstado", estado);
                    try {
                        getDBTransaction().commit();
                        logger.warning("Commit realizado con exito");
                    } catch (Exception e) {
                        logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                        try{
                            getDBTransaction().commit();
                            logger.warning("Segundo commit realizado con exito");
                        }catch(Exception ex){
                            logger.warning("error en el segundo commit: ", ex);
                            resultado = Boolean.FALSE;
                        }
                    }
                } else {
                    resultado = Boolean.FALSE;
                }
            } else {
                logger.warning("El row del contrato es nulo.");
                resultado = Boolean.FALSE;
            }

        } else {
            resultado = Boolean.FALSE;
        }
        return resultado;
    }
    
    public void recuperarEstadoDesembolso(Long idContrato){
       logger.warning("inicia metodo de recuperarEstadoDesembolso");          
        if(null == idContrato){
            logger.warning("*** El parametro idContrato es requerido para la busqueda del estado ");
        }else{         
             Row row = getRow(new Key(new Object[] { idContrato })); 
             if(null!= row){
                 logger.warning("Estado del contrato recuperado ->"+ row.getAttribute("IdTcaEstado"));
              }
        }
        logger.warning("Termina metodo de recuperarEstadoDesembolso");    
     }
    
    /**
     * Metodo para recuperar el registro de los terminos Inicio de desembolso (T102) y
     * Desembolso de la totalidad de los recursos (T103)
     * @param idOperacion
     * */
    @SuppressWarnings("unchecked")
    public List recuperarFechasTerminosDesembolsos(Long idOperacion){
        logger.warning("Inicia metodo recuperarFechasTerminosDesembolsos");
        List listaMensajesError = new ArrayList();
        String mensajeError = null;
        java.util.Date fechaTerminoT102 = null;
        java.util.Date fechaTerminoT103 = null;
        java.util.Date fechaActual = new java.util.Date();
        //JURBINA@23062020 Se convierte la fecha actual a media noche, misma hora que seran convertidas las horas de los terminos para una comparacion nada mas de dias.
        fechaActual = this.getDateAtTime(fechaActual, 0, 0, 0, 0);

        FenixAMImpl fenixAmImpl = (FenixAMImpl) getRootApplicationModule();
        
        if(null == idOperacion){
            logger.warning("Parametro idOperacion requerido.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
            return listaMensajesError;
        }
        
        if(null != fenixAmImpl){
            logger.warning("Obteniendo fecha de termino T102");
            fechaTerminoT102 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_INICIO_DESEMBOLSOS, idOperacion);
            //JURBINA@23062020 Se convierte la fecha del termino 102 para asegurarse esta a media noche
            fechaTerminoT102 = this.getDateAtTime(fechaTerminoT102, 0, 0, 0, 0);
            
            FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAMImpl= (FenixGestorDesembolsosAMImpl) fenixAmImpl.getFenixGestorDesembolsosAM();
            Boolean validaTermino= fenixGestorDesembolsosAMImpl.getSolicitudDesembolsoEstadosVO().solicitudEnFinProceso(idOperacion);
            logger.warning("Al menos 1 solicitud se encuentra en proceso o cerrada? "+validaTermino);
            
            if(null != fechaTerminoT102){
                if(!validaTermino){
                        logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT102);
                        if(fechaActual.before(fechaTerminoT102) || fechaActual.equals(fechaTerminoT102)){
                            logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de inicio de desembolso.");
                        }else{
                            logger.warning("Fecha actual del sistema es mayor que la fecha de inicio de desembolso.");
                            mensajeError = FenixModelConstants.ERROR_VALIDAR_INICIO_DESEMBOLSO_VENCIDA;
                            listaMensajesError.add(mensajeError);
                        }
                    }
                else{
                        logger.warning("Se omite la valdiacion de la fecha de inicio de desembolso(T102). ");
                    }
               
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_INICIO_DESEMBOLSOS;
                listaMensajesError.add(mensajeError);
            }
            
            logger.warning("Obteniendo fecha de termino T103");
            
            
            fechaTerminoT103 = fechaTerminoT103 != null ? fechaTerminoT103 : fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_DESEMBOLSO_TOTALIDAD_RECURSOS, idOperacion);
            
            //JURBINA@23062020 Se convierte la fecha del termino 103 para asegurarse esta a media noche
            fechaTerminoT103 = this.getDateAtTime(fechaTerminoT103, 0, 0, 0, 0);
            
            if(null != fechaTerminoT103){
                logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT103);
                if(fechaActual.before(fechaTerminoT103) || fechaActual.equals(fechaTerminoT103)){
                    logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de desembolso de la totalidad de recursos.");
                }else{
                    logger.warning("Fecha actual del sistema es mayor que la fecha de desembolso de la totalidad de recursos.");
                    mensajeError = FenixModelConstants.ERROR_VALIDAR_DESEMBOLSO_TOTALIDAD_VENCIDA;
                    listaMensajesError.add(mensajeError);
                }
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_TOTALIDAD_RECURSOS;
                listaMensajesError.add(mensajeError);
            }
        }else{
            logger.warning("ERROR la instancia del FENIXAMIMPL es NULL.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
        }
        
        logger.warning("Termina metodo recuperarFechasTerminosDesembolsos");
        return listaMensajesError;
    }
    
    /**
     * Metodo para recuperar el registro de los terminos Inicio de desembolso (T102) y
     * Desembolso de la totalidad de los recursos (T103)
     * @param idOperacion
     * @param Linea
     * */
    @SuppressWarnings("unchecked")
    public List recuperaFechasTerminosLineaDesembolso(Long idOperacion, Long idLinea){
        logger.warning("Inicia metodo recuperaFechasTerminosLineaDesembolso");
        logger.warning("idOperacion: " + idOperacion);
        logger.warning("idLinea: " + idLinea);
        List listaMensajesError = new ArrayList();
        String mensajeError = null;
        java.util.Date fechaTerminoT102 = null;
        java.util.Date fechaTerminoT103 = null;
        java.util.Date fechaActual = new java.util.Date();
        //JURBINA@23062020 Se convierte la fechaActual para asegurarse esta a media noche
        fechaActual = this.getDateAtTime(fechaActual, 0, 0, 0, 0);
        
        FenixAMImpl fenixAmImpl = (FenixAMImpl) getRootApplicationModule();
        FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAMImpl= (FenixGestorDesembolsosAMImpl) fenixAmImpl.getFenixGestorDesembolsosAM();
        
        if(null == idOperacion && idLinea==null){
            logger.warning("Parametro idOperacion y idLinea requerido.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
            return listaMensajesError;
        }
        
        if(null != fenixAmImpl && null != fenixGestorDesembolsosAMImpl){
            logger.warning("Obteniendo fecha de termino T102");
           // fechaTerminoT102 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_INICIO_DESEMBOLSOS, idOperacion);
            fechaTerminoT102 = fenixGestorDesembolsosAMImpl.getTerminoLineaVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_INICIO_DESEMBOLSOS, idLinea, idOperacion);
            //JURBINA@23062020 Se convierte la fecha del termino 102 para asegurarse esta a media noche
            fechaTerminoT102 = this.getDateAtTime(fechaTerminoT102, 0, 0, 0, 0);
            
            Boolean validaTermino= fenixGestorDesembolsosAMImpl.getSolicitudDesembolsoEstadosVO().solicitudEnFinProceso(idOperacion);
            logger.warning("Al menos 1 solicitud se encuentra en proceso o cerrada? "+validaTermino);
            
            //se valida si la fecha terminoT102 es nula, en caso de ser asi se trae del fenixAmImpl JURBINA 04/07/2019
            if(null == fechaTerminoT102)
            {
                fechaTerminoT102 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_INICIO_DESEMBOLSOS, idOperacion);
            }
            
            if(null != fechaTerminoT102){
                if(!validaTermino){
                        logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT102);
                        if(fechaActual.before(fechaTerminoT102) || fechaActual.equals(fechaTerminoT102)){
                            logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de inicio de desembolso.");
                        }else{
                            logger.warning("Fecha actual del sistema es mayor que la fecha de inicio de desembolso.");
                            mensajeError = FenixModelConstants.ERROR_VALIDAR_INICIO_DESEMBOLSO_VENCIDA;
                            listaMensajesError.add(mensajeError);
                        }
                    }
                else{
                        logger.warning("Se omite la valdiacion de la fecha de inicio de desembolso(T102). ");
                    }
               
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_INICIO_DESEMBOLSOS;
                listaMensajesError.add(mensajeError);
            }
            
            //se valida si la fecha terminoT103 es nula, en caso de ser asi se trae del fenixAmImpl JURBINA 04/07/2019
            logger.warning("Obteniendo fecha de termino T103");
            //fechaTerminoT103 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_DESEMBOLSO_TOTALIDAD_RECURSOS, idOperacion);
                        
            //JURBINA@31082020 Ahora se obtiene la fechaTerminoT103 de ConsultaLineaCreditoVOImpl, esto debido a que desde este vo se encuentra el maxUsageDate que viene desde Flexcube
            Map mapaDatosLinea = new HashMap();
            mapaDatosLinea = fenixGestorDesembolsosAMImpl.getConsultaLineaCreditoVO().obtenerFechaVencimientoMaximaMontoDisponible(idLinea, null);
            
            if(mapaDatosLinea != null && !mapaDatosLinea.isEmpty())
            {
                logger.warning("Obteniendo fecha de termino T103 desde el map resultado de consultar contrato de flexcube");
                fechaTerminoT103 = mapaDatosLinea.get("FechaMaxima") == null ? null : (java.util.Date)mapaDatosLinea.get("FechaMaxima");
            }
            
            fechaTerminoT103 = fechaTerminoT103 != null ? fechaTerminoT103 : fenixGestorDesembolsosAMImpl.getTerminoLineaVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_DESEMBOLSO_TOTALIDAD_RECURSOS, idLinea, idOperacion);
            
            //JURBINA@23062020 Se convierte la fecha del termino 103 para asegurarse esta a media noche
            fechaTerminoT103 = this.getDateAtTime(fechaTerminoT103, 0, 0, 0, 0);
            
            if(fechaTerminoT103 == null)
            {
                fechaTerminoT103 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_DESEMBOLSO_TOTALIDAD_RECURSOS, idOperacion);
            }
            
            if(null != fechaTerminoT103){
                logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT103);
                if(fechaActual.before(fechaTerminoT103) || fechaActual.equals(fechaTerminoT103)){
                    logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de desembolso de la totalidad de recursos.");
                }else{
                    logger.warning("Fecha actual del sistema es mayor que la fecha de desembolso de la totalidad de recursos.");
                    mensajeError = FenixModelConstants.ERROR_VALIDAR_DESEMBOLSO_TOTALIDAD_VENCIDA;
                    listaMensajesError.add(mensajeError);
                }
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_TOTALIDAD_RECURSOS;
                listaMensajesError.add(mensajeError);
            }
        }else{
            logger.warning("ERROR la instancia del FENIXAMIMPL o FENIXGESTORDESEMBOLSOSAMImpl es NULL.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
        }
        
        logger.warning("Termina metodo recuperarFechasTerminosDesembolsos");
        return listaMensajesError;
    }
    
    public Boolean actualizarMontoDesembolsar(BigDecimal nuevoMontoDesembolsar){
        logger.warning("Inicia metodo actualizarMontoDesembolsar");
        Boolean resultado = Boolean.FALSE;
        Row row = null;
        
        if(null == nuevoMontoDesembolsar){
            logger.warning("Parametro nuevoMontoDesembolsar es NULL.");
            return resultado;
        }
        
        row = getCurrentRow();
        
        if(null != row){
            logger.warning("Actualizar el monto a desembolsar del contrato: " + row.getAttribute("Id"));
            logger.warning("Monto a desembolsar actualizado: " + nuevoMontoDesembolsar);
            row.setAttribute("MontoDesembolsar", nuevoMontoDesembolsar);
            
            try{
                logger.warning("Realizando COMMIT para actualizar el monto a desembolsar.");
                getDBTransaction().commit();
                logger.warning("COMMIT realizado con exito.");            
                resultado = Boolean.TRUE;
            }catch(Exception e){
                logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                try{
                    getDBTransaction().commit();
                    logger.warning("Segundo commit realizado con exito");
                    resultado = Boolean.TRUE;
                }catch(Exception ex){
                    logger.warning("error en el segundo commit: ", ex);
                    resultado = Boolean.FALSE;
                }
            }
        }else{
            logger.warning("No hay un CURRENTROW.");
        }
        
        logger.warning("Inicia metodo actualizarMontoDesembolsar");
        return resultado;
    }
  
  
    /**
     * Este metodo ejecuta un servicio para la aplicar la compensacion al desembolso
     * @param IdContrato
     * @since 16/11/2016   
     * @return Boolean respuesta
     * @Carlos Orozco
     */  
    
    public Boolean aplicarCompensacionDesembolsoService(Long idDesembolso){
        logger.warning("inicia metodo AplicarCompensacionDesembolsoService");
           Boolean respuesta = Boolean.FALSE;        
           
            if(idDesembolso == null){
                    logger.warning("*** Error, el parametro requerido idDesembolso es null ");                
                return false;
                }
                    
            FenixAMImpl fenixAM = null;
            fenixAM = (FenixAMImpl) this.getRootApplicationModule();
            String wsdl = fenixAM.getWsdl(IWsdlLocation.DESEMBOLSO);

            DesembolsoPTSOAP12BindingQSService desembolsoService =
                IWsdlLocation.Service.getInstance(DesembolsoPTSOAP12BindingQSService.class, wsdl);
            DesembolsoPT desembolsoPT = desembolsoService.getDesembolsoPTSOAP12BindingQSPort();
            
            AplicarCompensacionDesembolsoRequestType request = new AplicarCompensacionDesembolsoRequestType();
            AplicarCompensacionDesembolsoResponseType response = null;
            request.setIdDesembolso(idDesembolso);
            request.getPlataforma().add("MFC");
            
            
            try{
                java.util.Date horaInicio = ModelUtils.logStartWS(logger, request, FenixModelConstants.WSC_APLICAR_COMPENSACION_A_DESEMBOLSO);
                response = desembolsoPT.aplicarCompensacionDesembolso(request);
                ModelUtils.logEndWS(logger, response, FenixModelConstants.WSC_APLICAR_COMPENSACION_A_DESEMBOLSO, horaInicio);
            }catch(Exception e){
                logger.warning("*** ERROR, al ejecutar servicio aplicar compensacion a el contrato ", e);
            }
            
            if(null != response){                
                 if(null != response.getResultado()){                       
                        if( null != response.getResultado().getResult().value()){                                    
                              if(response.getResultado().getResult().value() == "OK"){                                    
                                    logger.warning("Respuesta del servicio OK. ");
                                    respuesta = Boolean.TRUE; 
                            }else{
                                logger.warning("***Error, Respuesta del servicio: "+response.getResultado().getResult().value());
                                 }                    
                       }else{
                          logger.warning("*** Error, response.getResultado().getResult().value() es resuelto a null ");     
                        }
              }else{
                 logger.warning("*** Error, response.getResultado() es resuelto a null ");
                }       
            }else{
                    logger.warning("*** Error, response de aplicar compensacion a desembolso es resuelto a null ");                
                }
            logger.warning("Termina metodo AplicarCompensacionDesembolsoService");  
        return respuesta;
        }
    
    public Boolean actualizarEstadoDesembolso(Integer idEstadoActualizar){
        logger.warning("Inicia metodo actualizarEstadoDesembolso");
        Boolean resultado = Boolean.FALSE;
        Row row = null;
        
        if(null == idEstadoActualizar){
            logger.warning("Parametro idEstadoActualizar requerido es NULL.");
            return resultado;
        }
        
        row = getCurrentRow();
        
        if(null != row){
            row.setAttribute("IdTcaEstado", idEstadoActualizar);            
            try{
                logger.warning("Realizando COMMIT");
                getDBTransaction().commit();
                resultado = Boolean.TRUE;
                logger.warning("Primer commit realizado con exito");
            }catch(Exception e){
                logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                try{
                    getDBTransaction().commit();
                    resultado = Boolean.TRUE;
                    logger.warning("Segundo commit realizado con exito");
                }catch(Exception ex){
                    logger.warning("error en el segundo commit: ", ex);
                    resultado = Boolean.FALSE;
                }
            }
        }else{
            logger.warning("No existe un Current row de contratos.");
        }
        
        logger.warning("Termina metodo actualizarEstadoDesembolso");
        return resultado;
    }

    /**
     * Este metodo realiza el comit de lo preparado en la VO
     *
     * @since 23/11/2016
     * @author Carlos Lopez
     */

        public Boolean comitDatosContrato() {
            logger.warning("*** Inicia metodo comitDatosContrato");
            logger.warning("*** Inicia primer intento de comitDatosContrato");      
                Boolean respuesta = Boolean.FALSE;
                try {
                    getDBTransaction().commit();
                    respuesta = Boolean.TRUE;
                    logger.warning("Commit realizado con exito");
                } catch (Exception e) {
                    logger.log(ADFLogger.WARNING, "Error al intentar guardar los datos del contrato en el primer intento ->: " + e.getMessage());
                    logger.warning("*** Inicia segundo intento de comitDatosContrato"); 
                    try {
                        getDBTransaction().commit();
                        respuesta = Boolean.TRUE;
                        logger.warning("Segundo commit realizado con exito");
                    } catch (Exception ex) {
                        logger.log(ADFLogger.ERROR, "Error al intentar guardar los datos del contrato en el segundo intento ->: " + e.getMessage());
                    }
                }
            logger.warning("*** Termina metodo comitDatosContrato");
          return respuesta;
        }
    
    public Boolean encontrarContratosDesestimados(Long idContrato){
        logger.warning("Inicia metodo encontrarContratosDesestimados");
        Boolean resultado = Boolean.FALSE;
        Row row = null;
        //RowSetIterator iter = createRowSetIterator(null);
        
        if(null == idContrato){
            logger.warning("IdContrato requerido es NULL.");
        }
        
        if(getEstimatedRowCount() > 0){
            
            row = consultarContratoPorId(idContrato);
            //row = getRow(new Key(new Object[] { idContrato }));
            
            if(null != row){
                Integer idEstado = null;
                try{
                    idEstado = (Integer) row.getAttribute("IdTcaEstado");
                }catch(Exception e){
                    logger.warning("No se pudo obtener el idEstado del contrato");
                }
                logger.warning("Estado del contrato: " + idEstado);
                
                if(null != idEstado){
                    logger.warning("Evaluando el estado del contrato");
                    if(!idEstado.equals(FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO)){
                        resultado = Boolean.TRUE;
                    }else{
                        logger.warning("El contrato esta desestimado.");
                    }
                }else{
                    logger.warning("El estado es NULL.");
                }
            }else{
                logger.warning("No existe registro de contrato con id: " + idContrato);
            }
        }
        
        logger.warning("Termina metodo encontrarContratosDesestimados");
        return resultado;
    }
    
    public void ejecutarQuerty(){
        logger.warning("Ejecutar query de ContratoDesembolsoVO");
        executeQuery();
    }
    
    public BigDecimal obtenerMontoDesembolsarContrato(Long idContrato){
        logger.warning("Inicia metodo obtenerMontoDesembolsarContrato");
        BigDecimal montoDesembolsar = null;
        Row row = null;
        
        if(getEstimatedRowCount() > 0){
            
            SimpleDateFormat dateFormat = new SimpleDateFormat("HH:mm:ss");
            java.util.Date pdTime = new java.util.Date();
            String strTime = dateFormat.format(pdTime.getTime());
            logger.warning("Inicia GET ROW " + strTime);
            
            row = consultarContratoPorId(idContrato);
            //row = getRow(new Key(new Object[] { idContrato }));
            
            pdTime = new java.util.Date();
            strTime = dateFormat.format(pdTime.getTime());
            logger.warning("Termina GET ROW " + strTime);
            
            if(null != row){
                Integer idEstado = null;
                try{
                    idEstado = (Integer) row.getAttribute("IdTcaEstado");
                }catch(Exception e){
                    logger.warning("No se pudo obtener el idEstado del contrato");
                }
                logger.warning("Estado del contrato: " + idEstado);
                    
                if(null != idEstado){
                    logger.warning("Evaluando el estado del contrato");
                    if(!idEstado.equals(FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO)){
                        if(null != row.getAttribute("MontoDesembolsar")){
                            logger.warning("Obteniendo el monto a desembolsar del contrato");
                            try{
                                montoDesembolsar = (BigDecimal) row.getAttribute("MontoDesembolsar");
                            }catch(Exception e){
                                logger.warning("No se pudo obtener el monto a desembolsar");
                            }
                        }else{
                            logger.warning("EL contrato no tiene monto a desembolsar");
                        }
                    }else{
                        logger.warning("El contrato esta desestimado.");
                        montoDesembolsar = new BigDecimal(0.0);
                    }
                }else{
                    logger.warning("El estado del contrato es NULL");
                }
            }else{
                logger.warning("No existe registro de contrato con id: " + idContrato);
            }
        }
        
        logger.warning("Termina metodo obtenerMontoDesembolsarContrato");
        return montoDesembolsar;
    }
    
    public Boolean cambiarEstadoContratoValidacion(Long idContrato, Boolean requiereValidacionAsignacion){
        logger.warning("Inicia metodo cambiarEstadoContratoValidacion");
        Row row = null;
        Boolean resultado = Boolean.FALSE;
        
        if(null == idContrato){
            logger.warning("IdContrato requerido es NULL.");
            return resultado;
        }
        
        row = obtenerContratoPorId(idContrato);
        setCurrentRow(row);
        if(getEstimatedRowCount() > 0){
            
            //row = getRow(new Key(new Object[] { idContrato }));
            
            if(null != row){
                Integer idEstado = null;
                try{
                    idEstado = (Integer) row.getAttribute("IdTcaEstado");
                }catch(Exception e){
                    logger.warning("No se pudo obtener el idEstado del contrato");
                }
                logger.warning("Estado del contrato: " + idEstado);
                    
                if(null != idEstado){
                    logger.warning("Evaluando el estado del contrato");
                    if(!idEstado.equals(FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO)){
                        if(null != requiereValidacionAsignacion){
                            if(requiereValidacionAsignacion){
                                logger.warning("RequiereValidacionAsignacion es TRUE, cambiando estado a Validacion de asignacion.");
                                row.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_VALIDACION_RECURSOS);
                            }else{
                                logger.warning("RequiereValidacionAsignacion es FALSE, cambiando estado a Cumplimiento de condiciones.");
                                row.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CUMPLIMIENTO_CONDICIONES);
                            }
                        }else{
                            logger.warning("RequiereValidacionAsignacion es NULL, cambiando estado a Cumplimiento de condiciones.");
                            row.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CUMPLIMIENTO_CONDICIONES);
                        }
                        resultado = Boolean.TRUE;
                    }else{
                        logger.warning("El contrato esta desestimado.");
                    }
                }else{
                    logger.warning("El estado del contrato es NULL");
                }
            }else{
                logger.warning("No existe registro de contrato con id: " + idContrato);
            }
        }
                
        
        logger.warning("Termina metodo cambiarEstadoContratoValidacion");
        return resultado;
    }

    
    public Boolean guardarFechaInicioProcesDes(Long idContrato){
        logger.warning("Inf, inicia metodo guardarFechaInicioProcesDes");
            Boolean respuesta = Boolean.FALSE;
            java.util.Date date = new java.util.Date();
            Timestamp timestamp = new Timestamp(date.getTime());         
            Row contratoDesembolsosRow = null;
                         
            if(idContrato == null){
               logger.warning("***Error, parametro idContrato es resuelto a null");
                  return Boolean.FALSE;
              }            
        
            contratoDesembolsosRow = getRow(new Key(new Object[] { idContrato }));
            
         if(contratoDesembolsosRow !=  null){       
              contratoDesembolsosRow.setAttribute("FechaInicioProcesoDesem", timestamp);                         
             try {
                 getDBTransaction().commit();    
                 respuesta = Boolean.TRUE;
                 logger.warning("Commit realizado con exito");
             } catch (Exception e) {
                 logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                 try{
                     getDBTransaction().commit();
                     respuesta = Boolean.TRUE;
                     logger.warning("Segundo commit realizado con exito");
                 }catch(Exception ex){
                     logger.warning("error en el segundo commit: ", ex);
                 }
             }            
         }
         else
         {
            logger.warning("Error, No se pudo setear la fecha de inicio de proceso no se encontro el contrato con el Id : "+idContrato);
         }
                  
            logger.warning("Inf, Termina metodo guardarFechaInicioProcesDes fechaInicioProces: " +timestamp );
             
            return respuesta;
        }
    
    
    
    public Boolean validarCamposObligatoriosContrato(Long idContrato){
        logger.warning("Inf, inicia metodo validarCamposObligatoriosContrato");               
        Boolean respuesta = Boolean.FALSE;
        Row contratoDesembolsosRow = null;
            
        if(idContrato == null){
            logger.warning("***Error, parametro idContrato es resuelto a null");                 
            return null;
        }            
        Date fechaEstDisem=null;
        java.sql.Timestamp fechaDesestimada=null;
        logger.warning("Filtrando contrato por ID.");
        contratoDesembolsosRow = consultarContratoPorId(idContrato);
            
        if(contratoDesembolsosRow !=  null){
            logger.warning("Obteniendo campos obligatorios de contrato: " + contratoDesembolsosRow.getAttribute("Id"));
            
                              String fondo = (null == contratoDesembolsosRow.getAttribute("Fondo")) ? null
                                           : (String)contratoDesembolsosRow.getAttribute("Fondo");
                
               BigDecimal MontoDesembolsar = (null == contratoDesembolsosRow.getAttribute("MontoDesembolsar"))? null
                                           : (BigDecimal)contratoDesembolsosRow.getAttribute("MontoDesembolsar");  
               if(null!=contratoDesembolsosRow.getAttribute("FechaEstimadaDesembolsar")){
                       try{
                           fechaDesestimada = ( null == contratoDesembolsosRow.getAttribute("FechaEstimadaDesembolsar"))? null
                                              : (java.sql.Timestamp)contratoDesembolsosRow.getAttribute("FechaEstimadaDesembolsar");
                       }catch(Exception ex){
                           logger.warning("Error al obtener datos de la fecha: ", ex);
                           }
                   }
                
            Timestamp FechaEstDispRecursos = (null == contratoDesembolsosRow.getAttribute("FechaEstimadaDispRecursos"))? null
                                           : (Timestamp) contratoDesembolsosRow.getAttribute("FechaEstimadaDispRecursos");
          
               Integer idTcaEstadoContrato = (null == contratoDesembolsosRow.getAttribute("IdTcaEstado"))? null 
                                           :(Integer)contratoDesembolsosRow.getAttribute("IdTcaEstado");
               
            Integer idTcaTipoMoneda = (null == contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda"))? null 
                                           :(Integer)contratoDesembolsosRow.getAttribute("IdTcaTipoMoneda");
            
            if((idTcaEstadoContrato.compareTo(FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO) != 0 )){
                        if(fondo == null || MontoDesembolsar == null || fechaDesestimada == null || idTcaTipoMoneda == null){
                            logger.warning("Inf, Los registros de campos obligatorios del contrato con id : "+idContrato+" no estan completos");                        
                            respuesta = Boolean.FALSE;
                            
                            logger.warning("fondo : "+fondo);
                            logger.warning("MontoDesembolsar : "+MontoDesembolsar);
                            logger.warning("FechaEstDisem : "+fechaDesestimada);
                            logger.warning("IdTcaTipoMoneda : "+idTcaTipoMoneda);
                                    
                        }else{
                            logger.warning("Inf, ok registros de campos obligatorios del contrato con id : "+idContrato+ " completos");                                                    
                            respuesta = Boolean.TRUE;
                        }
                
            }else{                        
                logger.warning("Inf, el con id : "+idContrato+ " tiene un estado desembolsado no aplicara la validacion de campos");                                                    
                respuesta = Boolean.TRUE;
            }     
              
        }else{
            logger.warning("***Error, No se pudo recuperar el contrato con el Id : "+idContrato);
        }                    
            
        logger.warning("Inf, termina metodo validarCamposObligatoriosContrato");
        return respuesta;
    }
    
    
    public Boolean validarEstadoContratoACreado(Long idContrato) {
        logger.warning("Inf, inicia metodo validarEstadoContratoCreado");
        Boolean respuesta = Boolean.TRUE;
        Row contratoDesembolsosRow = null;

        if (idContrato == null) {
            logger.warning("***Error, parametro idContrato es resuelto a null");
            return Boolean.FALSE;
        }
        /*
        executeQuery();
        logger.warning("Numero de registros: " + getEstimatedRowCount());

        contratoDesembolsosRow = getRow(new Key(new Object[] { idContrato }));
        */
        contratoDesembolsosRow = consultarContratoPorId(idContrato);
        
        Integer idTcaEstadoContrato = (Integer) contratoDesembolsosRow.getAttribute("IdTcaEstado");
        if (contratoDesembolsosRow != null) {
            logger.warning("El contrato : " + idContrato + " tiene un estado : " + idTcaEstadoContrato);

            if (idTcaEstadoContrato.compareTo(ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO) != 0) {
                respuesta = Boolean.FALSE;
            }

        } else {
            logger.warning("*** Error, No se pudo recuperar el contrato con el Id : " + idContrato);
            respuesta = Boolean.FALSE;
        }
        return respuesta;
    }
    
    
    // se cambio la funcionalidad del metodo a un cambio de estado o eliminacion dependiendo del estado del contrato
    
      public Boolean cambiarContratoABanstatusCero(Long idContrato){
         logger.warning("Inf, se ha solicitando eliminar el contrato "+idContrato+" iniciando validacion...");  
          Boolean respuesta = Boolean.FALSE;
            Row contratoDesembolsosRow = null;
            
            if(idContrato == null){
               logger.warning("***Error, parametro idContrato es resuelto a null");                 
                  return Boolean.FALSE;
              }            
            
            logger.warning("Registros de contrato filtraods: " + getEstimatedRowCount());
            contratoDesembolsosRow = getCurrentRow();
            
            if(contratoDesembolsosRow !=  null){  
                logger.warning("Registro a desestimar: " + contratoDesembolsosRow.getAttribute("Id"));
                Integer idTcaEstadoContrato = (Integer)contratoDesembolsosRow.getAttribute("IdTcaEstado");                
              
                if(idTcaEstadoContrato.compareTo(ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO) == 0 ){                        
                    logger.warning("Inf, el estado del contrato es "+idTcaEstadoContrato
                                                +" que corresponde a creado se realizara un borrado fisico");
                    
                    //se modificaron los Assoc para que al eliminar el row se eliminen en cascada los registros con relacion
                    
                           logger.warning("Inf, ok relacion eliminada, eliminando registro de tabla contrato_desembolso");
                           contratoDesembolsosRow.remove(); 
                           logger.warning("Inf, ok registro de tabla contrato_desembolso eliminado esperando commit");
                           respuesta = Boolean.TRUE;  

                      }else{
                          logger.warning("El contrato : "+idContrato+ 
                          " tiene un estado diferente a creado estado : "+idTcaEstadoContrato+" actualizando estado a desestimado");
                            contratoDesembolsosRow.setAttribute("IdTcaEstado", FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_DESESTIMADO);
                             respuesta = Boolean.TRUE;    
                             logger.warning("Ok el estado del contrato "+idContrato+" a cambiado a desestimado");
                         }   
                    
            }else{
               logger.warning("*** Error, No se pudo recuperar el contrato con el Id : "+idContrato);            
            }  
            
         logger.warning("Inf, Termina metodo para eliminar el contrato");  
         return respuesta;
        }
      
    public Boolean eliminarContratoSolicitud(Long idContrato) {
        logger.warning("Inside eliminarContratoSolicitud.");
        logger.warning("idContrato: " + idContrato);
        
        Boolean respuesta = Boolean.FALSE;
        Row contratoDesembolsosRow = null;
        ViewCriteria criteria = null;

        if (idContrato == null) {
            logger.warning("***Error, parametro idContrato es null");
            return Boolean.FALSE;
        }
        
        executeQuery();
        
        try{  
            logger.warning("Ejecutando criteria de busqueda de contrato.");
            criteria = this.getViewCriteriaManager().getViewCriteria("ContratoDesembolsoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            this.applyViewCriteria(criteria);
            this.executeQuery();
        
            logger.warning("Registros de contratos encontrados: " + getEstimatedRowCount());
            
            if(getEstimatedRowCount() > 0){
                contratoDesembolsosRow = first();
                
                if (contratoDesembolsosRow != null) {
                    logger.warning("Registro a desestimar: " + contratoDesembolsosRow.getAttribute("Id"));
                    Integer idTcaEstadoContrato = (Integer) contratoDesembolsosRow.getAttribute("IdTcaEstado");

                    if (idTcaEstadoContrato.compareTo(ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO) == 0) {
                        logger.warning("Inf, el estado del contrato es " + idTcaEstadoContrato +
                                       " que corresponde a creado, se realizara un borrado fisico");

                        //se modificaron los Assoc para que al eliminar el row se eliminen en cascada los registros con relacion

                        logger.warning("Inf, ok relacion eliminada, eliminando registro de tabla contrato_desembolso");
                        contratoDesembolsosRow.remove();
                        logger.warning("Inf, ok registro de tabla contrato_desembolso eliminado esperando commit");
                        respuesta = Boolean.TRUE;
                    }
                } else {
                    logger.warning("*** Error, No se pudo recuperar el contrato con el Id : " + idContrato);
                }
            }
        }catch(Exception e){
            logger.warning("ERROR al ejecutar el crietria ContratoDesembolsoVOCriteria.", e);
        }finally{
            //Eliminamos el ViewCriteria
            this.getViewCriteriaManager().removeApplyViewCriteriaName("ContratoDesembolsoVOCriteria");
        }

        logger.warning("Termina metodo - eliminarContratoSolicitud");
        return respuesta;
    }
    
      public Integer recuperarIdTcaEstadoContrato(Long idContrato){
          logger.warning("Inf, inicia metodo recuperaraEstadoContrato");
            Integer idTcaEstadoContrato = null;
              Row contratoDesembolsosRow = null;
              
              if(idContrato == null){
                 logger.warning("***Error, parametro idContrato es resuelto a null");                 
                    return idTcaEstadoContrato;
              }            
              
              //executeQuery();
              //contratoDesembolsosRow = getRow(new Key(new Object[] { idContrato }));
              
              contratoDesembolsosRow = consultarContratoPorId(idContrato);
              
              if(contratoDesembolsosRow !=  null){                                                          
                   idTcaEstadoContrato = (Integer)contratoDesembolsosRow.getAttribute("IdTcaEstado");
                  logger.warning("Inf, el contrato : "+idContrato+" tiene un idTcaEstado : "+idTcaEstadoContrato);                 
              }else{
               logger.warning("*** Error, No se pudo recuperar el contrato con el Id : "+idContrato);
                return idTcaEstadoContrato;
            }  
            
          
           logger.warning("Inf, termina metodo recuperaraEstadoContrato");
          return idTcaEstadoContrato;
          }
    
    
    public Boolean commitContrato() {
        logger.warning("*** Inicia metodo commitContrato");        
         Boolean respuesta = Boolean.FALSE;
            try {
                getDBTransaction().commit();
                respuesta = Boolean.TRUE;
                logger.warning("Commit realizado con exito");
            } catch (Exception e) {
                logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                try{
                    getDBTransaction().commit();
                    respuesta = Boolean.TRUE;
                    logger.warning("Segundo commit realizado con exito");
                }catch(Exception ex){
                    logger.warning("error en el segundo commit: ", ex);
               }
            }         
         logger.warning("*** Termina metodo commitContrato");
        return respuesta;
        }
    
    //TODO crear metodo de suma de monto de ampliacion para asignar al campo Monto
    /**
     * Metodo para crear el contrato de desembolso desde la tarea Enviar al cobro,
     * Se crea con el estado 'creado por implementacion'.
     * @param idOperacion
     * @param idSolicitud
     * @param idLineaCredito
     * @param loginUsuario
     * @return idContratoCreado
     */
    public Long crearContratoEnvioCobro(Long idOperacion, Long idSolicitud, Long idLineaCredito, String loginUsuario, BigDecimal montoTotalContratos){
        logger.warning("Inicia metodo crearContratoEnvioCobro");
        Long idContratoEnvioCobro = null;
        Long idContratoCreado = null;
        //Integer idTipoMoneda = null;
        String idFondoLinea = null;
        //BigDecimal montoTotalContratos = null;
        
        FenixAMImpl fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixImplementacionPctAMImpl fenixImplementacionPctAMImpl = null;
            fenixImplementacionPctAMImpl = (FenixImplementacionPctAMImpl) this.getApplicationModule(); 
        Map mapaDatosFondo = new HashMap();
        Row contratoDesembolsosRow = null;
        
        if(null == idOperacion || null == idLineaCredito || null == loginUsuario){
            logger.warning("Parametros requeridos son NULL.");
            logger.warning("IdOperacion: " + idOperacion);
            logger.warning("idLineaCredito: " + idLineaCredito);
            logger.warning("loginUsuario: " + loginUsuario);
            return idContratoEnvioCobro;
        }
        
        try{
            //montoTotalContratos = fenixImplementacionPctAMImpl.getContratosDesembolsoConInteresVO().obtenerMontoTotalContratosPorLiquidar(idLineaCredito,idOperacion);
            logger.warning("Valor del monto total de contratos." + montoTotalContratos);
        }catch(Exception e){
            logger.warning("Error al obtener el monto total de los contratos.", e);
        }
        
        Long idLineaNumber = new Long(idLineaCredito.longValue());
        
        idContratoEnvioCobro = crearContratoDesembolsoEnvioCobro(idOperacion, idSolicitud, idLineaCredito, loginUsuario, montoTotalContratos);
        logger.warning("idContrato creado: " + idContratoEnvioCobro);
        if(null != idContratoEnvioCobro){
            //La moneda para el contrato creado es USD por lo tanto no se obtiene del del termino formalizado
            //idTipoMoneda = obtenerTipoMonedaMontoFormalizado(idOperacion);
            
            if(null != fenixAMImpl){
                mapaDatosFondo = fenixAMImpl.getConsultarLineaCreditoDesembolsoVO().obtenerFondoLinea(idLineaNumber);
                
                if(mapaDatosFondo.size() > 0){
                    try{
                        idFondoLinea = (String) mapaDatosFondo.get("idFondo");
                    }catch(Exception e){
                        logger.warning("No se pudo obtener el idFondo de linea de credito.", e);
                    }
                    
                    if (null != idFondoLinea) {
                        logger.warning("El Fondo obtenido es: " + idFondoLinea);
                    } else {
                        logger.warning("Se obtuvo un Fondo NULL");
                    }                    
                }else{
                    logger.warning("El mapa de datos de Fondo de la linea viene vacio.");
                }                
            }else{
                logger.warning("Instancia de FenixAMImpl es NULL.");
            }
            
            //contratoDesembolsosRow = getRow(new Key(new Object[] { idContratoEnvioCobro }));l
            contratoDesembolsosRow = obtenerContratoPorId(idContratoEnvioCobro);
            
            if(null != contratoDesembolsosRow){
//                if(null != idTipoMoneda){
//                    contratoDesembolsosRow.setAttribute("IdTcaTipoMoneda", idTipoMoneda);
//                }else{
//                    logger.warning("IdTipoMoneda es NULL. No se pudo asignar moneda a row de contrato.");
//                }
                
                if(null != idFondoLinea){
                    contratoDesembolsosRow.setAttribute("Fondo", idFondoLinea);
                }else{
                    logger.warning("idFondoLinea es NULL. No se pudo asignar fondo a row de contrato.");
                }
                
                try{
                    getDBTransaction().commit();
                    idContratoCreado = idContratoEnvioCobro;
                    logger.warning("Commit realizado con exito");
                }catch(Exception e){
                    logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                    try{
                        getDBTransaction().commit();
                        idContratoCreado = idContratoEnvioCobro;
                        logger.warning("Segundo commit realizado con exito");
                    }catch(Exception ex){
                        logger.warning("error en el segundo commit: ", ex);
                    }
                }
            }else{
                logger.warning("El row de nuevo contrato es NULL.");
            }
        }else{
            logger.warning("Registro de contrato no creado.");
        }
        
        logger.warning("Termina metodo crearContratoEnvioCobro");
        return idContratoCreado;
    }
    
    public Boolean guardarDatosContratoEnvioCobro(){
        logger.warning("Inicia metodo guardarDatosContratoEnvioCobro");
        Boolean resultado = Boolean.FALSE;
        
        logger.warning("Registros de contratos: " + getEstimatedRowCount());
        if(getEstimatedRowCount() > 0){
            try{
                logger.warning("Ejecutando COMMIT.");
                getDBTransaction().commit();
                resultado = Boolean.TRUE;
                logger.warning("Commit realizado con exito");
            }catch(Exception e){
                logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                try{
                    getDBTransaction().commit();
                    resultado = Boolean.TRUE;
                    logger.warning("Segundo commit realizado con exito");
                }catch(Exception ex){
                    logger.warning("error en el segundo commit: ", ex);
                    resultado = Boolean.FALSE;
                }
            }
        }
        
        logger.warning("Termina metodo guardarDatosContratoEnvioCobro");
        return resultado;
    }
    
    public String recuperarFondoContrato(Long idContrato){
        logger.warning("Inicia metodo recuperarFondoContrato. para contrato: "+idContrato);
        String fondo = null;
        Row row = null;

        try {
            row = consultarContratoPorId(idContrato);
        } catch (Exception e) {
            logger.warning(" ha ocurrido un error al setear como current el contrato " + idContrato + " Exception ->",
                           e);
        }

        if (null != row) {            
            logger.warning("Obtener el fondo del contrato: " + row.getAttribute("Id"));
            if(null != row.getAttribute("Fondo")){
                try{
                    fondo = (String) row.getAttribute("Fondo");
                }catch(Exception e){
                    logger.warning("ERROR al recuperar el valor de Fondo del contrato.", e);
                }
                logger.warning("FONDO: " + fondo);
            }else{
                logger.warning("El atributo FONDO de contrato es NULL.");
            }
        }else{
            logger.warning("CurrentRow es NULL");
        }
        
        logger.warning("Termina metodo recuperarFondoContrato.");
        return fondo;
    }
    
    public Long crearContratoDesembolsoEnvioCobro(Long idOperacion, Long idSolicitud, Long idLineaCredito, String loginUsuario, BigDecimal montoTotal) {
        logger.warning("Entra en crearContratoDesembolsoEnvioCobro");
        logger.warning("*Valor de idOperacion: " + idOperacion);
        logger.warning("*Valor de idSolicitud: " + idSolicitud);
        logger.warning("Valor de idLineaCredito: " + idLineaCredito);
        logger.warning("Valor del usuario: " + loginUsuario);
        
        FenixAMImpl fenixAMImpl = null;
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
        
        Long idContratoDesembolsoLong = null;
        Integer estadoDesembolso = FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_CREADO_POR_IMPLEMENTACION;       
                        
        if (null == idOperacion || null == idSolicitud || null == idLineaCredito || null == loginUsuario) {
            logger.warning("Se recibio valores nulos.");
            return idContratoDesembolsoLong;
        }
        
//        if(tarea.compareTo(FenixModelConstants.ID_REALIZAR_AJUSTES_ASIGNACION)==0){
//            logger.warning("el desembolso se cambia a  estado validacion de recursos");
//            estadoDesembolso=FenixModelConstants.ID_ESTADO_CONTRATO_DESEMBOLSO_VALIDACION_RECURSOS;
//         }
//        Map mapaDatosFondo = new HashMap();
//        Long idLinea = idLineaCredito;
//        String idFondoLinea = null;
        //Valida que el idOperacion es NULL
        //Retorna FALSE en caso de ser NULL
       
        Row row = null;
        oracle.jbo.domain.Number idContratoDesembolso = null;
        SequenceImpl seqContratoDesembolso = null;
        
        try {            
            logger.warning("*Inf, Creando nuevo id de contrato con un estado: " + estadoDesembolso);
            seqContratoDesembolso = new SequenceImpl("CONTRATO_DESEMBOLSO_SEQ", getDBTransaction());
            idContratoDesembolso = seqContratoDesembolso.getSequenceNumber();
            logger.warning("*Inf, sequence generado: " + idContratoDesembolso);
        } catch (Exception e) {
            logger.warning("***Error al crear el id del contrato ", e);
            new JboException(e);
            return idContratoDesembolsoLong;
        }
        idContratoDesembolsoLong = new Long(idContratoDesembolso.longValue());

        NameValuePairs nvpContrato = new NameValuePairs();
        nvpContrato.setAttribute("Id", idContratoDesembolsoLong);
        nvpContrato.setAttribute("IdTcaEstado", estadoDesembolso);
        nvpContrato.setAttribute("FechaRegistro", new Date().getCurrentDate());
        nvpContrato.setAttribute("BanEstatus", FenixModelConstants.BANESTATUS_TRUE);
        nvpContrato.setAttribute("LoginUsuario", loginUsuario);
        nvpContrato.setAttribute("MontoDesembolsar", montoTotal);
        nvpContrato.setAttribute("IdTcaTipoMoneda", FenixModelConstants.TIPO_MONEDA_USD);
        nvpContrato.setAttribute("MontoDesembolsarUsd", montoTotal);

        row = createAndInitRow(nvpContrato);
        if(null == row){
            logger.warning("El row a insertar es NULL");
            idContratoDesembolsoLong = null;
        }else{
            insertRow(row);
            Boolean respuesta = Boolean.FALSE;
            if (null != fenixAMImpl) {
                try{                                 
                    respuesta = gestorDesembolsosAMImpl.getTreSolicitudLineaCreditoConsultaVO().crearRegistroTreeSolicitudLineaCredito(idSolicitud, idLineaCredito, idContratoDesembolsoLong);
                    logger.warning("Respuesta de guardado del registro en crearRegistroTreeSolicitudLineaCredito :" + respuesta);
                  }catch(Exception e){
                      new JboException(e);
                  }
                                  
                if(!respuesta){                   
                   idContratoDesembolsoLong = null;
                 }
             }
            
            
        }
        logger.warning("Termina metodo crearContratoDesembolso :" + idContratoDesembolsoLong);
        return idContratoDesembolsoLong;
    }
    
    public Boolean actualizarCuentaConPresupuestoMonto(Long idContrato, Integer cuentaConPresupuesto){
        logger.warning("Entra en actualizarCuentaConPresupuestoMonto.");
        logger.warning("Se recibe idContrato: " + idContrato);
        logger.warning("Se recibe cuentaConPresupuesto: " + cuentaConPresupuesto);
        Boolean esActualizado = Boolean.TRUE;
        Row row = null;
        Integer valorCampo = null;
        
        try{
            row = this.obtenerContratoPorId(idContrato);
            
            if(null != row){
                row.setAttribute("CuentaConPresupuestoMonto", cuentaConPresupuesto);
                try{
                    this.getDBTransaction().commit();
                    valorCampo = (Integer)row.getAttribute("CuentaConPresupuestoMonto");
                    logger.warning("Commit realizado con exito");
                } catch (Exception e) {
                    logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                    try{
                        getDBTransaction().commit();
                        valorCampo = (Integer)row.getAttribute("CuentaConPresupuestoMonto");
                        logger.warning("Segundo commit realizado con exito");
                    }catch(Exception ex){
                        logger.warning("error en el segundo commit: ", ex);
                        esActualizado = Boolean.FALSE;
                    }
                }
            }else{
                logger.warning("No se obtuvo registro con el id de contrato :" + idContrato);
            } 
            
        }catch(Exception e){
            //this.getDBTransaction().rollback();
            esActualizado = Boolean.FALSE;
            logger.warning("Error al actualizar CuentaConPresupuesto.", e);
        }
        
        logger.warning("Se actualizo el registro. " + esActualizado + "Con estado :" + valorCampo);
        logger.warning("Finaliza actualizarCuentaConPresupuestoMonto.");
        return esActualizado;
    }
    
    public Boolean getBanderaCuentaConPresupuestoMonto(Long idContrato){
        logger.warning("Entra en getBanderaCuentaConPresupuestoMonto.");
        logger.warning("Se recibe idContrato: " + idContrato);
        Boolean banderaCuentaConPresupuestoMonto = Boolean.FALSE;
        Row row = null;
        Integer valorCampo = null;
        
        try{
            row = this.consultarContratoPorId(idContrato);
            
            if(null != row){
                if(null != row.getAttribute("CuentaConPresupuestoMonto")){
                    valorCampo = (Integer)row.getAttribute("CuentaConPresupuestoMonto");
                    if(valorCampo.compareTo(1) == 0)
                        banderaCuentaConPresupuestoMonto = Boolean.TRUE;
                    else if(valorCampo.compareTo(0) == 0)
                        banderaCuentaConPresupuestoMonto = Boolean.FALSE;
                    else
                        banderaCuentaConPresupuestoMonto = Boolean.FALSE;
                }
                else{
                    logger.warning("El campo CuentaConPresupuestoMonto con el idContrato " + idContrato + " es null");
                    banderaCuentaConPresupuestoMonto = Boolean.FALSE;
                }
            }else{
                logger.warning("No se obtuvo registro con el id de contrato :" + idContrato);
                banderaCuentaConPresupuestoMonto = Boolean.FALSE;
            } 
            
        }catch(Exception e){
            banderaCuentaConPresupuestoMonto = Boolean.FALSE;
            logger.warning("Error en getBanderaCuentaConPresupuestoMonto.", e);
        }
        
        logger.warning("Se retorna valor de la bandera: " + banderaCuentaConPresupuestoMonto + "   Con idContrato :" + idContrato);
        logger.warning("Finaliza getBanderaCuentaConPresupuestoMonto.");
        return banderaCuentaConPresupuestoMonto;
    }
    
    /**
     * Metodo para recuperar el registro de los terminos Inicio de desembolso (T102) y
     * Desembolso de la totalidad de los recursos (T103)
     * @param idOperacion
     * */
    @SuppressWarnings("unchecked")
    public List validarFechasTerminosDesembolsos(Long idOperacion){
        logger.warning("Inicia metodo recuperarFechasTerminosDesembolsos");
        List listaMensajesError = new ArrayList();
        String mensajeError = null;
        java.util.Date fechaTerminoT102 = null;
        java.util.Date fechaTerminoT103 = null;
        java.util.Date fechaActual = new java.util.Date();
        //JURBINA@23062020 Se convierte la fecha actual para asegurarse esta a media noche
        fechaActual = this.getDateAtTime(fechaActual, 0, 0, 0, 0);
        
        FenixAMImpl fenixAmImpl = (FenixAMImpl) getRootApplicationModule();
        FenixGestorDesembolsosAMImpl fenixGestorDesembolsosAMImpl = null;
        fenixGestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAmImpl.getFenixGestorDesembolsosAM();
        
        if(null == idOperacion){
            logger.warning("Parametro idOperacion requerido.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
            return listaMensajesError;
        }
        
        if(null != fenixAmImpl){
            logger.warning("Obteniendo fecha de termino T102");
            fechaTerminoT102 = fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_INICIO_DESEMBOLSOS, idOperacion);
            //JURBINA@23062020 Se convierte la fecha del termino 102 para asegurarse esta a media noche
            fechaTerminoT102 = this.getDateAtTime(fechaTerminoT102, 0, 0, 0, 0);
            
            if(null != fechaTerminoT102){
                logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT102);
                if(fechaActual.before(fechaTerminoT102) || fechaActual.equals(fechaTerminoT102)){
                    logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de inicio de desembolso.");
                }else{
                    logger.warning("Fecha actual del sistema es mayor que la fecha de inicio de desembolso.");
                    mensajeError = "T102";
                    listaMensajesError.add(mensajeError);
                }
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_INICIO_DESEMBOLSOS;
                listaMensajesError.add(mensajeError);
            }
            
            logger.warning("Obteniendo fecha de termino T103");
            
            fechaTerminoT103 = fechaTerminoT103 != null? fechaTerminoT103 : fenixAmImpl.getTccTerminoVO().obtenerFechaTerminoPorId(FenixModelConstants.ID_TCA_TERMINO_DESEMBOLSO_TOTALIDAD_RECURSOS, idOperacion);
            
            //JURBINA@23062020 Se convierte la fecha del termino 103 para asegurarse esta a media noche
            fechaTerminoT103 = this.getDateAtTime(fechaTerminoT103, 0, 0, 0, 0);
            
            if(null != fechaTerminoT103){
                logger.warning("Fecha actual del sistema: " + fechaActual + ", fecha del termino: " + fechaTerminoT103);
                if(fechaActual.before(fechaTerminoT103) || fechaActual.equals(fechaTerminoT103)){
                    logger.warning("La fecha actual del sistema es Menor o Igual al de la fecha de desembolso de la totalidad de recursos.");
                }else{
                    logger.warning("Fecha actual del sistema es mayor que la fecha de desembolso de la totalidad de recursos.");
                    mensajeError = "T103";
                    listaMensajesError.add(mensajeError);
                }
            }else{
                mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLA_FECHA_TOTALIDAD_RECURSOS;
                listaMensajesError.add(mensajeError);
            }
        }else{
            logger.warning("ERROR la instancia del FENIXAMIMPL es NULL.");
            mensajeError = FenixModelConstants.ERROR_VALIDAR_REGLAS_FECHAS;
            listaMensajesError.add(mensajeError);
        }
        
        logger.warning("Termina metodo recuperarFechasTerminosDesembolsos");
        return listaMensajesError;
    }
    
    public void actualizarProgramaOperacionDestinoFinaciamiento(){
        logger.warning("Inicia metodo actualizarProgramaOperacionDestinoFinaciamiento.");
        Row row = getCurrentRow();
        
        if(null != row){
            logger.warning("Asignando ProgramaOperacion y DestinoFinanciamiento.");
            row.setAttribute("ProgramaOperacion", FenixModelConstants.PROGRAMA_OPERACION_OR);
            row.setAttribute("DestinoFinanciamiento", FenixModelConstants.DESTINO_FINANCIAMIENTO_ND);
            
            try{
                logger.warning("Ejecutando COMMIT para actualizar ProgramaOperacion y DestinoFinanciamiento.");
                getDBTransaction().commit();
                logger.warning("Commit realizado con exito");
            }catch(Exception e){
                logger.warning("ERROR al realizar el COMMIT para actualizar ProgramaOperacion y DestinoFinanciamiento.", e);
                try{
                    getDBTransaction().commit();
                    logger.warning("Segundo commit realizado con exito");
                }catch(Exception e1){
                    logger.warning("error en el segundo commit: ", e1);
                    JboException ex = new JboException("");
                    ex.addToExceptions(new Exception("ContratoDesembolsoVOImpl-actualizarProgramaOperacionDestinoFinaciamiento():" +
                    "ERROR al actualizar ProgramaOperacion y DestinoFinanciamiento del Contrato de desembolso: " + e1.getMessage()));
                    throw ex;
                }
            }
            
        }else{
            logger.warning("El currentRow de ContratoDesembolsoVO es NULL.");
            JboException ex = new JboException("");
            ex.addToExceptions(new Exception("ContratoDesembolsoVOImpl-actualizarProgramaOperacionDestinoFinaciamiento():" +
                "No se encontró registro activo de ContratoDesembolsoVO."));
            throw ex;
        }
        
        logger.warning("Termina metodo actualizarProgramaOperacionDestinoFinaciamiento.");
    }
    
    public Map obtenerContratoFlexFechaEfectivaFT05(Long idContrato){
        logger.log(ADFLogger.WARNING, "INTO  obtenerContratoFlexFechaEfectivaFT05.");
        Map mapaDatos = new HashMap();
        Integer contador = 0;
        String contratoFlexcube = null;
        Timestamp fechaEfectiva = null;
        String cuentaCliente = null;
        
        if (null == idContrato) {
            logger.warning("Parametros requeridos son NULL");
            return mapaDatos;
        }
        else{
            ViewCriteria criteria =this.getViewCriteriaManager().getViewCriteria("ContratoDesembolsoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContrato);
            this.applyViewCriteria(criteria);
            this.executeQuery();
            
            RowSetIterator rowsContratoDesembolsosVo = createRowSetIterator(null);
            rowsContratoDesembolsosVo.reset();
                while (rowsContratoDesembolsosVo.hasNext()) {
                    ContratoDesembolsoVORowImpl rowL = (ContratoDesembolsoVORowImpl) rowsContratoDesembolsosVo.next();
                    if(rowL.getAttribute("BhqTransferenciaFt05") != null || rowL.getAttribute("FechaEfectivaFt05") != null){
                        //contratoFlexcube = (rowL.getAttribute("BhqTransferenciaFt05")!=null) ? (String)rowL.getAttribute("ContratoFlexcube") : null;
                        //fechaEfectiva = (rowL.getAttribute("FechaEfectivaFt05")!=null) ? (Timestamp) rowL.getAttribute("FechaEfectiva") : null;
                        contratoFlexcube = (rowL.getAttribute("BhqTransferenciaFt05")!=null) ? (String)rowL.getAttribute("BhqTransferenciaFt05") : null;
                        fechaEfectiva = (rowL.getAttribute("FechaEfectivaFt05")!=null) ? (Timestamp) rowL.getAttribute("FechaEfectivaFt05") : null;
                    }
                    if(null != rowL.getAttribute("CuentaCliente")){
                        cuentaCliente = (String)rowL.getAttribute("CuentaCliente");
                    }
                    contador++;
                }
            logger.warning("Numero de rows: " + contador);
            
            rowsContratoDesembolsosVo.closeRowSetIterator();
        }
        
        logger.log(ADFLogger.WARNING, "Valor contratoFlexcube a retornar: " + contratoFlexcube);
        logger.log(ADFLogger.WARNING, "Valor fechaEfectiva a retornar: " + fechaEfectiva);
        logger.log(ADFLogger.WARNING, "Valor cuentaCliente a retornar: " + cuentaCliente);
        
        mapaDatos.put("contratoFlexcube", contratoFlexcube);
        mapaDatos.put("fechaEfectiva", fechaEfectiva);
        mapaDatos.put("cuentaCliente", cuentaCliente);
        
        logger.log(ADFLogger.WARNING, "Finaliza  obtenerContratoFlexFechaEfectivaFT05.");
        return mapaDatos;
    }
    
    public Boolean asignarFechaInicioDesembolso(Long idContrato){
        logger.warning("Inicia metodo asignarFechaInicioDesembolso.");
        Boolean resultado = Boolean.FALSE;
        Row row = null;
        java.util.Date date = new java.util.Date();
        Timestamp timestamp = new Timestamp(date.getTime());
            
        if(null == idContrato){
            logger.warning("IDCONTRATO requerido es NULL.");
            JboException ex = new JboException("");
            ex.addToExceptions(new Exception("IDCONTRATO requerido es NULL."));
            throw ex;
        }
        
        getCurrentRow().refresh(Row.REFRESH_WITH_DB_FORGET_CHANGES);
        row = getCurrentRow();
        if(null != row){
            logger.warning("Asignando fecha de inicio de desembolso: " + timestamp);
            row.setAttribute("FechaInicioProcesoDesem", timestamp);
            //setCurrentRow(row);
            
            try{
                logger.warning("Realizando COMMIT para actualizar la fecha de inicio del contrato.");
                getDBTransaction().commit();
                resultado = Boolean.TRUE;
                logger.warning("Commit realizado con exito");
            }catch(Exception e){
                logger.log(ADFLogger.ERROR, "error en el commit: ", e);
                try{
                    getDBTransaction().commit();
                    resultado = Boolean.TRUE;
                    logger.warning("Segundo commit realizado con exito"); 
                }catch(Exception e1){
                    JboException ex = new JboException("");
                    ex.addToExceptions(new Exception("Error al actualizar la Fecha de inicio de proceso de Desembolso: " + e1.getMessage()));
                    throw ex;
                }
            }
        }else{
            logger.warning("No se encontro registro de contrato con ID: " + idContrato);
            JboException ex = new JboException("");
            ex.addToExceptions(new Exception("No se encontró registro de contrato con ID: " + idContrato));
            throw ex;
        }
        
        logger.warning("Termina metodo asignarFechaInicioDesembolso.");
        return resultado;
    }
    
    public Boolean guardarMonedaPrimerContrato(Long idContrato, Integer idTipoMoneda){
        logger.warning("Inicia metodo guardarMonedaPrimerContrato.");
        Boolean resultado = Boolean.FALSE;
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) getApplicationModule();
        Row row = null;
        
        row = gestorDesembolsosAMImpl.getContratoDesembolsoVO().obtenerContratoPorId(idContrato);
        
        if(null != row){
            logger.warning("Cambiando moneda por la de primer contrato.");
            row.setAttribute("IdTcaTipoMoneda", idTipoMoneda);
            resultado = Boolean.TRUE;
        }else{
            logger.warning("Row de contrato buscado es NULL.");
        }
        
        logger.warning("Termina metodo guardarMonedaPrimerContrato.");
        return resultado;
    }

    /**
     * executeQueryForCollection - overridden for custom java data source support.
     */
    @Override
    protected void executeQueryForCollection(Object qc, Object[] params, int noUserParams) {
        super.executeQueryForCollection(qc, params, noUserParams);
    }

    /**
     * hasNextForCollection - overridden for custom java data source support.
     */
    @Override
    protected boolean hasNextForCollection(Object qc) {
        boolean bRet = super.hasNextForCollection(qc);
        return bRet;
    }

    /**
     * createRowFromResultSet - overridden for custom java data source support.
     */
    @Override
    protected ViewRowImpl createRowFromResultSet(Object qc, ResultSet resultSet) {
        ViewRowImpl value = super.createRowFromResultSet(qc, resultSet);
        return value;
    }

    /**
     * getQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getQueryHitCount(ViewRowSetImpl viewRowSet) {
        long value = super.getQueryHitCount(viewRowSet);
        return value;
    }

    /**
     * getCappedQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getCappedQueryHitCount(ViewRowSetImpl viewRowSet, Row[] masterRows, long oldCap, long cap) {
        long value = super.getCappedQueryHitCount(viewRowSet, masterRows, oldCap, cap);
        return value;
    }
    
    public void cargaDeMoneda(Long idSolicitud, Long idOperacion){
        logger.warning("idSolicitud: "+ idSolicitud);
        logger.warning("Operacion: "+ idOperacion);
        logger.warning("Elementos encontrados: "+ this.getEstimatedRowCount());
        Integer tipoMonedaActual=null;
        FenixAMImpl fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
        Integer tipoMonedaActivo=null;
        Row row=this.getCurrentRow();
        if(null!=row){
                logger.warning("idTipoMoneda: "+ row.getAttribute("IdTcaTipoMoneda"));
                tipoMonedaActual= gestorDesembolsosAMImpl.getMonedaContratoVO1().monedaId(idSolicitud, idOperacion);
                if(null!= tipoMonedaActual){
                                row.setAttribute("IdTcaTipoMoneda",tipoMonedaActual);
                            }
                        else{
                                row.setAttribute("IdTcaTipoMoneda",FenixModelConstants.TIPO_MONEDA_USD);
                            }
            }
        else{
            logger.warning("No existen registros");
            }
        }
    /**
     *
     * metodo que busca el contratoDesembolso por id y hace current al row recuperado de la busqueda
     * @param idContratoDesembolso
     * @return true o false
     */
    public Boolean setCurrentContratoDesembolsoById(Long idContratoDesembolso){
        
        logger.warning("Dentro de getContratoDesembolsoById, idContratoDesembolso : "+idContratoDesembolso);
        
        Row row = null;
        ViewCriteria criteria = null;
        Boolean resultado = Boolean.FALSE;
        
        try{  
            criteria = this.getViewCriteriaManager().getViewCriteria("ContratoDesembolsoVOCriteria");
            criteria.ensureVariableManager().setVariableValue("pIdContrato", idContratoDesembolso);
            this.applyViewCriteria(criteria);
            this.executeQuery();
            if(getEstimatedRowCount() > 0){
                logger.warning("contrato de desembolso encontrado");
                row = first();
                logger.warning("set current row : "+row);
                this.setCurrentRow(row);
                resultado = Boolean.TRUE;
            }else{
                logger.warning("no se encontro un contrato de desembolso con el id : "+idContratoDesembolso);
            }
        }catch(Exception e){
            logger.warning("Error en ContratoDesembolsoVOCriteria.", e);
        }finally{
            //Eliminamos el ViewCriteria
            this.getViewCriteriaManager().removeApplyViewCriteriaName("ContratoDesembolsoVOCriteria");
        }
        logger.warning("Fuera de getContratoDesembolsoById, resultado : "+resultado);
        return resultado;
    }
    
    public void asignarTransientCuentaClienteOrigenTransferencia(){
        logger.warning("Dentro asignarTransientCuentaClienteOrigenTransferencia");
        
        Row row = getCurrentRow();
        
        String origenTransferenciaClienteTransient = null;
        String cuentaClienteTransient = null;
        String cuentaCliente = null;
        
        //validar que el row no sea nulo, evitar errores
        if(null != row){
        
            try{
                origenTransferenciaClienteTransient = (String) row.getAttribute("OrigenTranferenciaClienteTransient");
            }catch(Exception e){
                logger.severe("ERROR al recuperar columna OrigenTranferenciaClienteTransient", e);
            }
        
            try{
                cuentaClienteTransient = (String) row.getAttribute("CuentaClienteTransient");
            }catch(Exception e){
                logger.severe("ERROR al recuperar columna CuentaClienteTransient", e);
            }
            
            try{
                cuentaCliente = (String) row.getAttribute("CuentaCliente");
            }catch(Exception e){
                logger.severe("ERROR al recuperar columna CuentaCliente", e);
            }
        
            logger.warning("origenTransferenciaClienteTransient : "+origenTransferenciaClienteTransient);
            logger.warning("cuentaClienteTransient : "+cuentaClienteTransient);
        
        
            if(null == row.getAttribute("OrigenTranferenciaCliente")){
                logger.warning("OrigenTranferenciaCliente es nulo");
                //evitar settear a la columna OrigenTranferenciaCliente un valor null
                if(null != origenTransferenciaClienteTransient){
                    logger.warning("asignar el valor de origenTransferenciaClienteTransient : "
                                    +origenTransferenciaClienteTransient+ " a OrigenTranferenciaCliente" );
                    row.setAttribute("OrigenTranferenciaCliente", origenTransferenciaClienteTransient);
                }else{
                    logger.warning("origenTransferenciaClienteTransient es nulo");
                }
            }else{
                //mostrar valor que tiene el campo OrigenTranferenciaCliente de ContratoDesembolsoVO
                logger.warning("OrigenTranferenciaCliente : "+ row.getAttribute("OrigenTranferenciaCliente"));
            }
        
            if(null == row.getAttribute("CuentaCliente")){
                logger.warning("CuentaCliente es nulo");
                //evitar settear a la columna CuentaCliente un valor null
                if(null != cuentaClienteTransient){
                    logger.warning("asignar el valor de cuentaClienteTransient : " 
                                        +cuentaClienteTransient+ " a CuentaCliente");
                    row.setAttribute("CuentaCliente", cuentaClienteTransient);
                }else{
                    logger.warning("cuentaClienteTransient es nulo");
                }
            }else{
                
                //mostrar valor de tiene el campo CuentaCliente de ContratoDesembolsoVO
                logger.warning("CuentaCliente"+row.getAttribute("CuentaCliente"));
                
                row.setAttribute("CuentaClienteTransient", cuentaCliente);
            }
        
        }else{
            logger.severe("row de contratoDesembolsoVO es nulo");
        }
        
        logger.warning("Fuera asignarTransientCuentaClienteOrigenTransferencia");
    }
    
    
    public Integer obtenerDiaPagoCliente(){
      logger.warning("*inf, inicia metodo obtenerDiaPagoCliente");
        Row fila = null;
        Long idDesembolso = null;
        Integer diaPagoCliente = null;
        FenixAMImpl fenixAMImpl = null;
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;  
        
        
        if(getCurrentRow() != null){
            
             idDesembolso = (null == getCurrentRow().getAttribute("Id"))? null
                          : (Long)getCurrentRow().getAttribute("Id");
             
             if(idDesembolso != null){
                   gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
                   diaPagoCliente = gestorDesembolsosAMImpl.getRecuperarDiaPagoClienteByDesembolsoVO().recuperarDiaPagoClientebyDesembolso(idDesembolso);
             }else{
                  logger.warning("*Inf, no se pudo recuperar el id de desembolso Current");
             }
        }else{
            logger.warning("*Inf, no se pudo recuperar el desembolso Current");
        }
        
        
        logger.warning("*inf, termina metodo obtenerDiaPagoCliente");
        return diaPagoCliente;
    }
    
    
    
    //metodo para validar el valor de la columna CuentaCliente en contratoDesembolsoVO 
    public void validaCuentaCliente(){
        logger.warning("Dentro de validaCuentaCliente");
        Row row = null;
        
            if(getCurrentRow() != null ){
                row = getCurrentRow(); 
                logger.warning("id :"+row.getAttribute("Id"));
                logger.warning("CuentaCliente :"+row.getAttribute("CuentaCliente"));
                logger.warning("CuentaClienteTransient :"+row.getAttribute("CuentaClienteTransient"));
                logger.warning("OrigenTranferenciaCliente :"+row.getAttribute("OrigenTranferenciaCliente"));
                logger.warning("OrigenTranferenciaClienteTransient :"+row.getAttribute("OrigenTranferenciaClienteTransient"));
            }else{
                logger.warning("current Row de ContratoDesembolsoVO es nulo");
            }             
       
        logger.warning("Fuera de validaCuentaCliente");
    }
    
    
    
    
    /* public void afterCommit(TransactionEvent event){
        logger.warning("Dentro afterCommit");
        //se guarda el current row de ContratoDesembolsoVO
        Row row = this.getCurrentRow();
        Long idContratoDesembolso = null;
        Long idLineaTransient = null;
        String descripcionMonedaTransient = null, bhqCliente = null, codExternoMoneda = null, contratoFlexAux = null, 
            fondoTransient = null, origenTranferenciaClienteTransient = null, cuentaClienteTransient = null;
        Timestamp fechaEstimadaDisponibilidadRecursos = null;
        BigDecimal montoProgramadoMesVigente = null;
        Integer plazoMoneda = null;
        Long frecuenciaPlazoMoneda = null;
        Integer idTcaTipoMonedaTransient = null;
        Integer programadoTransient = null;
        
        
        //validar que el row no sea nulo
        if(row != null){
            try{
                idContratoDesembolso = (Long)row.getAttribute("Id");
            }catch(Exception e){
                logger.severe("Error al recuperar el id del contratoDesembolsoVO");
            }
            logger.warning("getCurrentRow id es : "+idContratoDesembolso);
            
            //Se recuperan los atributos Transient para reasignar despues de asignar el currentRow.
            try{
                idLineaTransient = 
                    (null == row.getAttribute("IdLinea")) ? null : (Long) row.getAttribute("IdLinea");
                descripcionMonedaTransient = 
                    (null == row.getAttribute("DescripcionMoneda")) ? null : (String) row.getAttribute("DescripcionMoneda");
                bhqCliente = 
                    (null == row.getAttribute("BHQCliente")) ? null : (String) row.getAttribute("BHQCliente");
                codExternoMoneda = 
                    (null == row.getAttribute("CodExternoMoneda")) ? null : (String) row.getAttribute("CodExternoMoneda");
                contratoFlexAux = 
                    (null == row.getAttribute("ContratoFlexAux")) ? null : (String) row.getAttribute("ContratoFlexAux");
                montoProgramadoMesVigente = 
                    (null == row.getAttribute("MontoProgramadoMesVigente")) ? null : (BigDecimal) row.getAttribute("MontoProgramadoMesVigente");
                plazoMoneda = 
                    (null == row.getAttribute("PlazoMoneda")) ? null : (Integer) row.getAttribute("PlazoMoneda");
                frecuenciaPlazoMoneda = 
                    (null == row.getAttribute("FrecuenciaPlazoMoneda")) ? null : (Long) row.getAttribute("FrecuenciaPlazoMoneda");
                fondoTransient = 
                    (null == row.getAttribute("FondoTransient")) ? null : (String) row.getAttribute("FondoTransient");
                idTcaTipoMonedaTransient = 
                    (null == row.getAttribute("IdTcaTipoMonedaTransient")) ? null : (Integer) row.getAttribute("IdTcaTipoMonedaTransient");
                programadoTransient = 
                    (null == row.getAttribute("ProgramadoTransient")) ? null : (Integer) row.getAttribute("ProgramadoTransient");
                origenTranferenciaClienteTransient = 
                    (null == row.getAttribute("OrigenTranferenciaClienteTransient")) ? null : (String) row.getAttribute("OrigenTranferenciaClienteTransient");
                cuentaClienteTransient = 
                    (null == row.getAttribute("CuentaClienteTransient")) ? null : (String) row.getAttribute("CuentaClienteTransient");
                fechaEstimadaDisponibilidadRecursos = 
                    (null == row.getAttribute("FechaEstimadaDisponibilidadRecursos")) ? null : (Timestamp) row.getAttribute("FechaEstimadaDisponibilidadRecursos");
            }catch(Exception e){
                logger.warning("ERROR al recuperar los atributos Transient.", e);
            }
            
            //ejecutar nuevamente la consulta para recuperar cualquier transaccion anterior
            this.executeQuery();
            //buscar contratoDesembolso por id y hacerlo current row
            setCurrentContratoDesembolsoById(idContratoDesembolso);
            
            //se asignan a currentRow los atributos transient
            if(null != getCurrentRow()){
                Row rowActual = getCurrentRow();
                rowActual.setAttribute("IdLinea", idLineaTransient);
                rowActual.setAttribute("DescripcionMoneda", descripcionMonedaTransient);
                rowActual.setAttribute("FechaEstimadaDisponibilidadRecursos", fechaEstimadaDisponibilidadRecursos);
                rowActual.setAttribute("BHQCliente", bhqCliente);
                rowActual.setAttribute("CodExternoMoneda", codExternoMoneda);
                rowActual.setAttribute("ContratoFlexAux", contratoFlexAux);
                rowActual.setAttribute("MontoProgramadoMesVigente", montoProgramadoMesVigente);
                rowActual.setAttribute("PlazoMoneda", plazoMoneda);
                rowActual.setAttribute("FrecuenciaPlazoMoneda", frecuenciaPlazoMoneda);
                rowActual.setAttribute("FondoTransient", fondoTransient);
                rowActual.setAttribute("IdTcaTipoMonedaTransient", idTcaTipoMonedaTransient);
                rowActual.setAttribute("ProgramadoTransient", programadoTransient);
                rowActual.setAttribute("OrigenTranferenciaClienteTransient", origenTranferenciaClienteTransient);
                rowActual.setAttribute("CuentaClienteTransient", cuentaClienteTransient);
            }
        }else{
            logger.warning("getCurrentRow es nulo");
        }
        
        logger.warning("Fuera afterCommit");
    } */

    @Override
    public void afterRollback(TransactionEvent transactionEvent) {
        
        executeQuery();
        
        // TODO Implement this method
        super.afterRollback(transactionEvent);
    }
    
    public Boolean modeloSucio(){
        Boolean respuesta=Boolean.FALSE;
        logger.warning("Inicia metodo");
        respuesta= getDBTransaction().isDirty();
        logger.warning("Inicia metodo, espuesta que devuele: "+ respuesta);
        return respuesta;
        }
    
    
    public Integer getRowState(){
        ContratoDesembolsoVORowImpl row = (ContratoDesembolsoVORowImpl) getCurrentRow();
        Integer intState = row.getRowState();
        return intState;
    }
    
    
    public void recalcularValorTasaReferncia(Timestamp fechaEfectiva){
        logger.warning("*Inf, Inicia metodo recalcularValorTasaReferncia ..");
        
        Map datos = new HashMap();        
        Row contratoCurrent = getCurrentRow();         
        Long idDesembolso = (Long)contratoCurrent.getAttribute("Id");
        //Timestamp fechaEfectiva =  (Timestamp)contratoCurrent.getAttribute("FechaEfectiva");
        BigDecimal tasaTotal = null;
                   
        FenixAMImpl fenixAMImpl = null;
        fenixAMImpl = (FenixAMImpl) this.getRootApplicationModule();
        FenixGestorDesembolsosAMImpl gestorDesembolsosAMImpl = null;
        gestorDesembolsosAMImpl = (FenixGestorDesembolsosAMImpl) fenixAMImpl.getFenixGestorDesembolsosAM();
        
        Row condicionFinRow = gestorDesembolsosAMImpl.getCondicionesFinancierasVO().getCondicionFinancieraCurrent();
        
        String descripcionTasa = (String)condicionFinRow.getAttribute("DescripcionTasa");
        BigDecimal valorSpread = (BigDecimal)condicionFinRow.getAttribute("SpreadTasa");
        
        if(descripcionTasa == null || descripcionTasa.equals("")){
            logger.warning("*Inf, descripcionTasa null, TasaTotal = valorSpread");
            tasaTotal = valorSpread;
            condicionFinRow.setAttribute("TasaTotal", tasaTotal);
        }else{
            
            datos = (Map)gestorDesembolsosAMImpl.getTasaReferenciaVO().obtenerValorTasaReferencia(descripcionTasa, fechaEfectiva);
            String tasaRefencia = datos.get("ValorActual").toString();
            
            BigDecimal valorTasaReferencia = (!tasaRefencia.equals("") && tasaRefencia != null) 
                                           ? new BigDecimal(tasaRefencia) : BigDecimal.ZERO;
            
                      valorSpread = ( valorSpread != null ) ? valorSpread : BigDecimal.ZERO;
            
                      tasaTotal = valorTasaReferencia.add(valorSpread);
            
            condicionFinRow.setAttribute("TasaTotal", tasaTotal);
            
        }
        
        logger.warning("*Inf, termina metodo recalcularValorTasaReferncia tasaTotal: "+tasaTotal);
    }
    
    private java.util.Date getDateAtTime(java.util.Date fecha, int hora, int minuto, int segundo, int milisegundo )
    {
        java.util.Date fechaRetorno = fecha;
               
        logger.warning("fecha recibida: "  + fecha + ", hora destino:" + hora + ", minuto destino:" + minuto + ", segundo destino:" + segundo + ", milisegundo destino:" + milisegundo);
         
        if(fecha != null)
        {
            Calendar calConversion = new GregorianCalendar();
            calConversion.setTime(fechaRetorno);
            calConversion.set(Calendar.HOUR_OF_DAY, hora);
            calConversion.set(Calendar.MINUTE, minuto);
            calConversion.set(Calendar.SECOND, segundo);
            calConversion.set(Calendar.MILLISECOND, milisegundo);
            
            fechaRetorno = calConversion.getTime();
            
            logger.warning("fecha convertida: "  + fechaRetorno);
        }
        
        return fechaRetorno;
    }
    
    
    public String recuperarContratoFlexcube(Long idContrato){
        logger.warning("Inf, inicia metodo recuperarContratoFlexcube");
          String ContratoFlexcube = null;
            Row contratoDesembolsosRow = null;
            
            if(idContrato == null){
               logger.warning("***Error, parametro idContrato es resuelto a null");                 
                  return ContratoFlexcube;
            }
            contratoDesembolsosRow = consultarContratoPorId(idContrato);
            
            if(contratoDesembolsosRow !=  null){                                                          
                 ContratoFlexcube = (String)contratoDesembolsosRow.getAttribute("ContratoFlexcube");
                logger.warning("Inf, el contrato : "+idContrato+" tiene un ContratoFlexcube : "+ContratoFlexcube);                 
            }else{
                logger.warning("*** Error, No se pudo recuperar el contrato con el Id : "+idContrato);
                return ContratoFlexcube;
            }  
          
        
            logger.warning("Inf, termina metodo recuperarContratoFlexcube");
            return ContratoFlexcube;
        }   
    
}

