package org.bcie.fenix.common.model.vo;

import java.math.BigDecimal;
import java.sql.Timestamp;
import java.math.RoundingMode;

import java.sql.CallableStatement;
import java.sql.ResultSet;

import java.sql.SQLException;

import oracle.adf.share.logging.ADFLogger;

import oracle.jbo.JboException;
import oracle.jbo.Row;
import oracle.jbo.server.ViewObjectImpl;
import oracle.jbo.server.ViewRowImpl;
import oracle.jbo.server.ViewRowSetImpl;

import oracle.jdbc.OracleTypes;

import org.bcie.fenix.common.model.FenixModelConstants;
import org.bcie.fenix.common.model.vo.common.FormularioCalculoInteresesVO;

import java.text.SimpleDateFormat;
import java.text.DateFormat;
import java.text.ParseException;

import java.util.Date;

// ---------------------------------------------------------------------
// ---    File generated by Oracle ADF Business Components Design Time.
// ---    Fri Oct 07 12:51:20 CDT 2016
// ---    Custom code may be added to this class.
// ---    Warning: Do not modify method signatures of generated methods.
// ---------------------------------------------------------------------
public class FormularioCalculoInteresesVOImpl extends ViewObjectImpl implements FormularioCalculoInteresesVO {
    
    private static ADFLogger logger = null;
    
    
    /**
     * This is the default constructor (do not remove).
     */
    public FormularioCalculoInteresesVOImpl() {
        if (logger == null) {
            logger = ADFLogger.createADFLogger(this.getClass());
        }
    }
    
    public BigDecimal obtenerIntereses(Long idPrepago,String contratoDesembolso){
        ResultSet rs = null;
        BigDecimal intereses = null;
        int id = 1;
        this.executeQuery();
        logger.log(ADFLogger.WARNING,"Into obtenerIntereses.");
        logger.log(ADFLogger.WARNING,"Parameter value idPrepago : " + idPrepago);
        logger.log(ADFLogger.WARNING,"Parameter value contratoDesembolso : " + contratoDesembolso);
        try {
            String storeProcedure = "{call SP_CALCULO_DE_INTERES(?,?)}";
            CallableStatement callableStatement = null;
            callableStatement = this.getDBTransaction().createCallableStatement(storeProcedure,0);
            callableStatement.setLong(FenixModelConstants.P_PREPAGO,idPrepago);
            callableStatement.registerOutParameter(FenixModelConstants.P_RECORDSET, OracleTypes.CURSOR);
            callableStatement.executeUpdate();
            rs = (ResultSet) callableStatement.getObject(FenixModelConstants.P_RECORDSET);
            while(rs.next()){
                if(null != contratoDesembolso &&  contratoDesembolso.equals(rs.getString("CONTRACT_DESEMBOLSO"))){
                    intereses = (null != rs.getBigDecimal("INTERESES") ? rs.getBigDecimal("INTERESES").setScale(2, RoundingMode.CEILING) : null);
                }
            }
            
        }catch(SQLException sqlerr){
            logger.log(ADFLogger.ERROR,"Exception into obtenerIntereses : " +sqlerr.getMessage());
            throw new JboException(sqlerr);
        }

        logger.log(ADFLogger.WARNING,"obtenerIntereses return : "+intereses);
        return intereses; 
    }
    
    public BigDecimal obtenerInteresesNew(Long idPrepago,String contratoDesembolso, Integer idTcaTipoResolucion,  Timestamp fechaPrepago){
        ResultSet rs = null;
        BigDecimal intereses = null;
        int id = 1;
        this.executeQuery();
        logger.log(ADFLogger.WARNING,"Into obtenerIntereses.");
        logger.log(ADFLogger.WARNING,"Parameter value idPrepago : " + idPrepago);
        logger.log(ADFLogger.WARNING,"Parameter value idTcaTipoResolucion : " + idTcaTipoResolucion);
        logger.log(ADFLogger.WARNING,"Parameter value fechaPrepago : " + fechaPrepago);
        logger.log(ADFLogger.WARNING,"Parameter value contratoDesembolso : " + contratoDesembolso);
        try {
            String storeProcedure = "{call SP_CALCULO_DE_INTERES(?,?)}";
            CallableStatement callableStatement = null;
            callableStatement = this.getDBTransaction().createCallableStatement(storeProcedure,0);
            callableStatement.setLong(FenixModelConstants.P_PREPAGO,idPrepago);
            callableStatement.registerOutParameter(FenixModelConstants.P_RECORDSET, OracleTypes.CURSOR);
            callableStatement.executeUpdate();
            rs = (ResultSet) callableStatement.getObject(FenixModelConstants.P_RECORDSET);
            while(rs.next()){
                if(null != contratoDesembolso &&  contratoDesembolso.equals(rs.getString("CONTRACT_DESEMBOLSO"))){
                    //Se validan condiciones de la RN_11 para mostrar intereses por contrato
                    Boolean mostrarIntereses = mostrarIntereses(rs, idTcaTipoResolucion, fechaPrepago);
                    logger.log(ADFLogger.WARNING, "mostrarIntereses: " + mostrarIntereses);
                    
                    if (mostrarIntereses) {
                        intereses = (null != rs.getBigDecimal("INTERESES") ? rs.getBigDecimal("INTERESES").setScale(2, RoundingMode.CEILING) : null);
                    }
                }
            }
            
        }catch(SQLException sqlerr){
            logger.log(ADFLogger.ERROR,"Exception into obtenerIntereses : " +sqlerr.getMessage());
            throw new JboException(sqlerr);
        }

        logger.log(ADFLogger.WARNING,"obtenerIntereses return : "+intereses);
        return intereses; 
    }
    
    public void testLlenarCalculoIntereses() {
        Long idPrepago = 56L;
        Integer idTcaTipoResolucion = 1;
        Timestamp fechaPrepago = new Timestamp(System.currentTimeMillis());
        
        try {
            //2016-10-10 00:00:00.0
            DateFormat formatter = new SimpleDateFormat("MM-dd-yyyy");
            Date date;
            date = (Date) formatter.parse("10-10-2016");
            
            //Descomentar para probar con una fecha especifica
            //fechaPrepago = new Timestamp(date.getTime());
            
            llenarCalculoIntereses(idPrepago, idTcaTipoResolucion, fechaPrepago);
        } catch (ParseException e) {
            logger.log(ADFLogger.WARNING, "", e);
        }
        
        
    }
    
    /**  llenarCalculoIntereses
    *       @param  idPrepago
    *       @since 07/10/2016
    *       @by Jonathan Ruiz
    **/
    public void llenarCalculoIntereses(Long idPrepago, Integer idTcaTipoResolucion, Timestamp fechaPrepago) {
        ResultSet rs = null;
        int id = 1;
        this.executeQuery();
        logger.log(ADFLogger.WARNING,"Into llenarCalculoIntereses.");
        logger.log(ADFLogger.WARNING,"Parameter value idPrepago : " + idPrepago);
        logger.log(ADFLogger.WARNING,"Parameter value idTcaTipoResolucion : " + idTcaTipoResolucion);
        logger.log(ADFLogger.WARNING,"Parameter value fechaPrepago : " + fechaPrepago);
        try {
            String storeProcedure = "{call SP_CALCULO_DE_INTERES(?,?)}";
            CallableStatement callableStatement = null;
            callableStatement = this.getDBTransaction().createCallableStatement(storeProcedure,0);
            callableStatement.setLong(FenixModelConstants.P_PREPAGO,idPrepago);
            callableStatement.registerOutParameter(FenixModelConstants.P_RECORDSET, OracleTypes.CURSOR);
            callableStatement.executeUpdate();
            rs = (ResultSet) callableStatement.getObject(FenixModelConstants.P_RECORDSET);
            while(rs.next()){
                Row row = this.createRow();
                //agrega un id incremental para poder indentificar los registros en la vista
                row.setAttribute(FormularioCalculoInteresesVORowImpl.ID, Integer.valueOf(id));
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.IDTREPREPAGOCONTRATO,
                                    (0 != rs.getLong("ID_TRE_PRE_CONT")) ?
                                        rs.getLong("ID_TRE_PRE_CONT") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.CONTRATODESEMBOLSO,
                                    (null != rs.getString("CONTRACT_DESEMBOLSO")) ?
                                        rs.getString("CONTRACT_DESEMBOLSO") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.BASE,(null != rs.getString("BASE")) ?
                                        rs.getString("BASE") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.TASA,(null != rs.getBigDecimal("TASA")) ?
                                        rs.getBigDecimal("TASA") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.MONTOPREPAGO,
                                    (null != rs.getBigDecimal("MONTO_PREPAGAR")) ?
                                        rs.getBigDecimal("MONTO_PREPAGAR") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.DESDE,
                                    (null != rs.getTimestamp("FECHA_DESDE")) ?
                                        rs.getTimestamp("FECHA_DESDE") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.HASTA,
                                    (null != rs.getTimestamp("FECHA_HASTA")) ?
                                        rs.getTimestamp("FECHA_HASTA") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.DIAS,
                                    (0 != rs.getInt("DIAS_CALCULADOS")) ?
                                        rs.getInt("DIAS_CALCULADOS") : null);
                
                //Se validan condiciones de la RN_11 para mostrar intereses por contrato
                Boolean mostrarIntereses = mostrarIntereses(rs, idTcaTipoResolucion, fechaPrepago);
                logger.log(ADFLogger.WARNING, "mostrarIntereses: " + mostrarIntereses);
                
                if (mostrarIntereses) {
                    if (null == rs.getBigDecimal("INTERESES")) {
                        logger.log(ADFLogger.WARNING, "Los intereses son nulos.");
                    }
                    
                    if (null == rs.getString("MONEDA")) {
                        logger.log(ADFLogger.WARNING, "La moneda es nula.");
                    }
                    
                    row.setAttribute(FormularioCalculoInteresesVORowImpl.INTERESES,
                                        (null != rs.getBigDecimal("INTERESES")) ?
                                            rs.getBigDecimal("INTERESES").setScale(2, RoundingMode.CEILING) : null);
                    
                    row.setAttribute(FormularioCalculoInteresesVORowImpl.MONEDA,
                                        (null != rs.getString("MONEDA")) ?
                                            rs.getString("MONEDA") : null);
                }
                
                id++;
                this.insertRow(row);
                logger.log(ADFLogger.WARNING,"row contrato desembolso :" + row.getAttribute("ContratoDesembolso"));
            }
            
        }catch(SQLException sqlerr){
            logger.log(ADFLogger.ERROR,"Exception into llenarCalculoIntereses : " +sqlerr.getMessage());
            throw new JboException(sqlerr);
        }
        
        logger.log(ADFLogger.WARNING,"successful method llenarCalculoIntereses.");
    }
    
    public boolean mostrarIntereses(ResultSet rs, Integer idTcaTipoResolucion, Timestamp fechaPrepago) throws SQLException {
        //Se validan condiciones de la RN_11
        Boolean mostrarIntereses = Boolean.FALSE;
        Integer esPagoTotal = rs.getInt("ES_PAGO_TOTAL");
        Timestamp proximoPago = rs.getTimestamp("FECHA_PROXIMO_PAGO");
        
        logger.log(ADFLogger.WARNING,"esPagoTotal: " + esPagoTotal);
        logger.log(ADFLogger.WARNING,"proximoPago: " + proximoPago + " || fechaPrepago: " + fechaPrepago);
        
        if(fechaPrepago.compareTo(proximoPago) != 0){
            switch (idTcaTipoResolucion) {
                case 1: //PRE-10/2008  
                    if(null != esPagoTotal && esPagoTotal == 1){
                        mostrarIntereses = Boolean.TRUE;
                    }
                    break;
                case 3: //Otras condiciones
                    mostrarIntereses = Boolean.TRUE;
                    break;
            }
        }
        
        return mostrarIntereses;
    }
    
    /**  llenarCalculoIntereses"
    *       @param  idPrepago
    *       @since 07/10/2016
    *       @by Gabriel Niño Rosales
    **/
    @Deprecated
    public void llenarCalculoIntereses(Long idPrepago) {
        ResultSet rs = null;
        int id = 1;
        this.executeQuery();
        logger.log(ADFLogger.WARNING,"Into llenarCalculoIntereses.");
        logger.log(ADFLogger.WARNING,"Parameter value idPrepago : " + idPrepago);
        try {
            String storeProcedure = "{call SP_CALCULO_DE_INTERES(?,?)}";
            CallableStatement callableStatement = null;
            callableStatement = this.getDBTransaction().createCallableStatement(storeProcedure,0);
            callableStatement.setLong(FenixModelConstants.P_PREPAGO,idPrepago);
            callableStatement.registerOutParameter(FenixModelConstants.P_RECORDSET, OracleTypes.CURSOR);
            callableStatement.executeUpdate();
            rs = (ResultSet) callableStatement.getObject(FenixModelConstants.P_RECORDSET);
            while(rs.next()){
                Row row = this.createRow();
                //agrega un id incremental para poder indentificar los registros en la vista
                row.setAttribute(FormularioCalculoInteresesVORowImpl.ID, Integer.valueOf(id));
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.IDTREPREPAGOCONTRATO,
                                    (0 != rs.getLong("ID_TRE_PRE_CONT")) ?
                                        rs.getLong("ID_TRE_PRE_CONT") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.CONTRATODESEMBOLSO,
                                    (null != rs.getString("CONTRACT_DESEMBOLSO")) ?
                                        rs.getString("CONTRACT_DESEMBOLSO") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.BASE,(null != rs.getString("BASE")) ?
                                        rs.getString("BASE") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.TASA,(null != rs.getBigDecimal("TASA")) ?
                                        rs.getBigDecimal("TASA") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.MONTOPREPAGO,
                                    (null != rs.getBigDecimal("MONTO_PREPAGAR")) ?
                                        rs.getBigDecimal("MONTO_PREPAGAR") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.DESDE,
                                    (null != rs.getTimestamp("FECHA_DESDE")) ?
                                        rs.getTimestamp("FECHA_DESDE") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.HASTA,
                                    (null != rs.getTimestamp("FECHA_HASTA")) ?
                                        rs.getTimestamp("FECHA_HASTA") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.DIAS,
                                    (0 != rs.getInt("DIAS_CALCULADOS")) ?
                                        rs.getInt("DIAS_CALCULADOS") : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.INTERESES,
                                    (null != rs.getBigDecimal("INTERESES")) ?
                                        rs.getBigDecimal("INTERESES").setScale(2, RoundingMode.CEILING) : null);
                
                row.setAttribute(FormularioCalculoInteresesVORowImpl.MONEDA,
                                    (null != rs.getString("MONEDA")) ?
                                        rs.getString("MONEDA") : null);
                
                id++;
                this.insertRow(row);
                logger.log(ADFLogger.WARNING,"row contrato desembolso :" + row.getAttribute("ContratoDesembolso"));
            }
            
        }catch(SQLException sqlerr){
            logger.log(ADFLogger.ERROR,"Exception into llenarCalculoIntereses : " +sqlerr.getMessage());
            throw new JboException(sqlerr);
        }
        
        logger.log(ADFLogger.WARNING,"successful method llenarCalculoIntereses.");
    }

    /**
     * executeQueryForCollection - overridden for custom java data source support.
     */
    @Override
    protected void executeQueryForCollection(Object qc, Object[] params, int noUserParams) {
        super.executeQueryForCollection(qc, params, noUserParams);
    }

    /**
     * hasNextForCollection - overridden for custom java data source support.
     */
    @Override
    protected boolean hasNextForCollection(Object qc) {
        boolean bRet = super.hasNextForCollection(qc);
        return bRet;
    }

    /**
     * createRowFromResultSet - overridden for custom java data source support.
     */
    @Override
    protected ViewRowImpl createRowFromResultSet(Object qc, ResultSet resultSet) {
        ViewRowImpl value = super.createRowFromResultSet(qc, resultSet);
        return value;
    }

    /**
     * getQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getQueryHitCount(ViewRowSetImpl viewRowSet) {
        long value = super.getQueryHitCount(viewRowSet);
        return value;
    }

    /**
     * getCappedQueryHitCount - overridden for custom java data source support.
     */
    @Override
    public long getCappedQueryHitCount(ViewRowSetImpl viewRowSet, Row[] masterRows, long oldCap, long cap) {
        long value = super.getCappedQueryHitCount(viewRowSet, masterRows, oldCap, cap);
        return value;
    }
}

